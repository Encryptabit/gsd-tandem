---
phase: 07-add-reviewer-lifecycle-management-to-broker
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - tools/gsd-review-broker/src/gsd_review_broker/tools.py
  - tools/gsd-review-broker/tests/test_reclaim.py
autonomous: true
requirements:
  - RLMC-03

must_haves:
  truths:
    - "claim_review stores claimed_at timestamp and claim_generation in response"
    - "submit_verdict accepts optional claim_generation and rejects stale claims"
    - "submit_verdict verifies claimed_by matches the submitting reviewer_id for claimed reviews"
    - "submit_verdict rejects verdicts on claimed reviews when both claim_generation and reviewer_id are omitted"
    - "A timed-out review can be reclaimed to pending with incremented claim_generation"
    - "After reclaim, a late verdict from the original reviewer is rejected"
    - "claim_generation is backward-compatible -- omitting it skips the fence check ONLY for non-claimed reviews"
    - "claimed_by authorization prevents foreign reviewers from submitting verdicts on claimed reviews"
  artifacts:
    - path: "tools/gsd-review-broker/src/gsd_review_broker/tools.py"
      provides: "Modified claim_review with claimed_at and claim_generation; modified submit_verdict with fence check, claimed_by authorization, and fence bypass prevention; new reclaim_review internal function"
      min_lines: 50
    - path: "tools/gsd-review-broker/tests/test_reclaim.py"
      provides: "Tests for fenced reclaim: timeout, late verdict rejection, claim_generation flow, claimed_by authorization, fence bypass prevention"
      min_lines: 100
  key_links:
    - from: "tools/gsd-review-broker/src/gsd_review_broker/tools.py"
      to: "reviews.claim_generation"
      via: "SQL UPDATE increment on reclaim"
      pattern: "claim_generation = claim_generation \\+ 1"
    - from: "tools/gsd-review-broker/src/gsd_review_broker/tools.py"
      to: "reviews.claimed_at"
      via: "SQL UPDATE on claim"
      pattern: "claimed_at.*datetime"
    - from: "tools/gsd-review-broker/src/gsd_review_broker/tools.py"
      to: "reviews.claimed_by"
      via: "Authorization check in submit_verdict"
      pattern: "claimed_by.*!=.*reviewer_id"
---

<objective>
Fenced reclaim logic: claim_generation fence tokens, claimed_at timestamps, claimed_by authorization, fence bypass prevention, and stale verdict rejection.

Purpose: Prevent duplicate verdicts when a reviewer times out and its review is reclaimed by another reviewer. The fence token (claim_generation) ensures only the current claim holder can submit verdicts. The claimed_by check provides an orthogonal authorization layer that prevents foreign reviewers from submitting verdicts even when claim_generation is omitted for backward compatibility. A final safety net rejects verdicts on claimed reviews when BOTH identifiers are omitted, closing the bypass where a caller could skip all fencing by omitting both parameters. This is the safety mechanism for the multi-reviewer pool.
Output: Modified claim_review and submit_verdict tools with fence token support, claimed_by authorization, and bypass prevention. reclaim_review helper. Comprehensive race-condition tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-add-reviewer-lifecycle-management-to-broker/07-RESEARCH.md
@.planning/phases/07-add-reviewer-lifecycle-management-to-broker/07-01-SUMMARY.md
@tools/gsd-review-broker/src/gsd_review_broker/tools.py
@tools/gsd-review-broker/src/gsd_review_broker/state_machine.py
@tools/gsd-review-broker/tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Modify claim_review and submit_verdict for fence tokens, claimed_by authorization, and bypass prevention</name>
  <files>
    tools/gsd-review-broker/src/gsd_review_broker/tools.py
  </files>
  <action>
  **Modify `claim_review`:**
  - In the successful claim UPDATE statement, also set:
    - `claimed_at = datetime('now')`
    - `claim_generation = claim_generation + 1`
  - In the SELECT, also fetch `claim_generation` from the row.
  - After the UPDATE, read back the new claim_generation (it was incremented, so it's the old value + 1). Calculate it as `old_claim_generation + 1` where old_claim_generation is from the SELECT.
  - Include `claim_generation` in the successful claim response dict so reviewers know their fence token.
  - Keep backward compatibility: existing callers that ignore claim_generation still work.

  **Modify `submit_verdict`:**
  - Add optional parameter `claim_generation: int | None = None` to the function signature.
  - In both the comment verdict and standard verdict paths, after fetching the review row, also SELECT `claim_generation` and `claimed_by` from the reviews table.

  - **Fence bypass prevention (MUST come first):** If the review's current status is 'claimed' AND BOTH `claim_generation` is None (not provided) AND `reviewer_id` is not provided (None or empty), ROLLBACK and return error dict: `{"error": "Claimed reviews require reviewer_id or claim_generation for verdict submission"}`. This closes the bypass where a caller omitting both parameters would skip all fencing checks on a claimed review. This check ONLY applies to reviews in 'claimed' status -- reviews in other statuses (e.g., reviews that were claimed and then had status manually changed, or legacy reviews) are unaffected for backward compatibility.

  - **Fence check (claim_generation):** If the caller provided `claim_generation` (not None), compare it to the row's current `claim_generation`. If they don't match, ROLLBACK and return error dict: `{"error": "Stale claim: review was reclaimed since your claim. Your generation=X, current=Y"}`.
  - If `claim_generation` is None (not provided) AND the review is not in claimed status, skip the fence check. This preserves backward compatibility with manual reviewers and external tools operating on non-claimed reviews.

  - **Authorization check (claimed_by):** If the review's current status is 'claimed' and `claimed_by` is not NULL, and `reviewer_id` is provided (not None/empty), verify that the `reviewer_id` parameter matches the row's `claimed_by` value. If they don't match, ROLLBACK and return error dict: `{"error": "Unauthorized: review is claimed by {claimed_by}, not {reviewer_id}"}`. This is an orthogonal safety net that prevents ANY foreign client from submitting verdicts on reviews claimed by broker-managed reviewers.

  **Check ordering in submit_verdict for claimed reviews:**
  1. Fence bypass prevention (both identifiers omitted on claimed review -> reject)
  2. Fence check (claim_generation mismatch -> reject)
  3. Authorization check (reviewer_id mismatch on claimed review -> reject)
  4. Proceed with verdict

  **Add internal `reclaim_review` function** (not an @mcp.tool, called by background tasks):
  ```python
  async def reclaim_review(review_id: str, app: AppContext, reason: str = "claim_timeout") -> dict:
  ```
  - Acquire write_lock.
  - BEGIN IMMEDIATE.
  - SELECT status, claimed_by, claim_generation FROM reviews WHERE id = review_id.
  - If status is not 'claimed', ROLLBACK, return error.
  - UPDATE reviews SET status='pending', claimed_by=NULL, claimed_at=NULL, claim_generation=claim_generation+1, updated_at=datetime('now') WHERE id=review_id.
  - Record `review_reclaimed` audit event with actor="pool-manager", old_status="claimed", new_status="pending", metadata={old_reviewer: claimed_by, reason, claim_generation: new_value}.
  - COMMIT.
  - Notify on review_id and QUEUE_TOPIC.
  - Return success dict with review_id, new status, new claim_generation.
  </action>
  <verify>
  Run `cd C:/Projects/gsd-tandem/tools/gsd-review-broker && uv run pytest tests/test_tools.py tests/test_proposals.py -v` -- all existing tests still pass (backward compatibility). Read tools.py to verify claim_generation is optional in submit_verdict, that claimed_by authorization check exists, and that the fence bypass prevention check exists for claimed reviews when both identifiers are omitted.
  </verify>
  <done>
  claim_review returns claim_generation in response. submit_verdict accepts and checks claim_generation when provided. submit_verdict verifies claimed_by matches reviewer_id for claimed reviews (orthogonal authorization). submit_verdict rejects verdicts on claimed reviews when both claim_generation and reviewer_id are omitted (fence bypass prevention). reclaim_review function transitions claimed reviews back to pending with incremented fence token.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fenced reclaim, authorization, and bypass prevention tests covering race conditions</name>
  <files>
    tools/gsd-review-broker/tests/test_reclaim.py
  </files>
  <action>
  Create comprehensive test file for the fenced reclaim system. Import create_review, claim_review, submit_verdict, reclaim_review, and close_review from tools module. Use conftest fixtures (ctx, db).

  **Tests:**

  1. **test_claim_review_returns_claim_generation**: Create review, claim it, verify response contains `claim_generation` key with value >= 1.

  2. **test_claim_review_sets_claimed_at**: Create review, claim it, verify `claimed_at` is set in the DB (SELECT reviews WHERE id=...).

  3. **test_submit_verdict_with_valid_claim_generation**: Create, claim (capture claim_generation from response), submit_verdict with that claim_generation. Verify success.

  4. **test_submit_verdict_with_stale_claim_generation**: Create, claim (gen=1), reclaim (gen becomes 2), claim again (gen=3), submit_verdict with gen=1. Verify error "Stale claim".

  5. **test_submit_verdict_without_claim_generation_backward_compat**: Create, claim, submit_verdict without claim_generation parameter BUT with reviewer_id matching the claimed_by. Verify success (fence check skipped because reviewer_id is provided and matches, satisfying the bypass prevention gate).

  6. **test_reclaim_review_transitions_to_pending**: Create, claim, reclaim. Verify status is 'pending', claimed_by is NULL.

  7. **test_reclaim_review_increments_claim_generation**: Create, claim (gen=1), reclaim. SELECT claim_generation, verify it's 2.

  8. **test_reclaim_review_clears_claimed_at**: Create, claim (claimed_at set), reclaim. Verify claimed_at is NULL.

  9. **test_reclaim_review_only_claimed_status**: Create review (pending), try reclaim. Verify error (not claimed).

  10. **test_full_race_scenario**: The critical end-to-end race test:
      - Create review.
      - Reviewer A claims (gets gen=1).
      - Review is reclaimed (gen becomes 2).
      - Reviewer B claims (gets gen=3).
      - Reviewer A tries submit_verdict with gen=1 -> REJECTED (stale).
      - Reviewer B submits verdict with gen=3 -> ACCEPTED.
      - Verify audit log shows reclaim event.

  11. **test_reclaim_records_audit_event**: Create, claim, reclaim. Query audit_events for review_reclaimed event. Verify metadata contains old_reviewer and reason.

  12. **test_comment_verdict_with_stale_claim_generation**: Same as test 4 but with verdict="comment". Verify stale check applies to comments too.

  13. **test_submit_verdict_wrong_reviewer_rejected**: Create review, claim with reviewer_id="reviewer-A". Then call submit_verdict with reviewer_id="reviewer-B" (a different reviewer). Verify error "Unauthorized: review is claimed by reviewer-A, not reviewer-B". This validates the claimed_by authorization check that prevents foreign clients from submitting verdicts regardless of claim_generation.

  14. **test_submit_verdict_correct_reviewer_accepted**: Create review, claim with reviewer_id="reviewer-A". Call submit_verdict with reviewer_id="reviewer-A" and valid claim_generation. Verify success. This confirms that the claimed_by check passes for the correct reviewer.

  15. **test_submit_verdict_no_reviewer_id_with_claim_generation_accepted**: Create review, claim with reviewer_id="reviewer-A". Call submit_verdict WITHOUT reviewer_id parameter but WITH valid claim_generation. Verify success -- claim_generation is provided so the bypass prevention gate passes, and the claimed_by check is skipped when reviewer_id is not provided.

  16. **test_submit_verdict_claimed_review_both_omitted_rejected**: Create review, claim with reviewer_id="reviewer-A". Call submit_verdict WITHOUT reviewer_id AND WITHOUT claim_generation (both omitted). Verify error: "Claimed reviews require reviewer_id or claim_generation for verdict submission". This is the critical fence bypass prevention test -- a caller cannot skip all fencing by omitting both identifiers on a claimed review.

  17. **test_submit_verdict_non_claimed_review_both_omitted_accepted**: Create a review, move it to a non-claimed status (e.g., directly set status to an appropriate state, or use a review that was never claimed). Call submit_verdict without reviewer_id and without claim_generation. Verify success -- the bypass prevention only applies to reviews in 'claimed' status. This confirms backward compatibility for non-claimed reviews.
  </action>
  <verify>
  Run `cd C:/Projects/gsd-tandem/tools/gsd-review-broker && uv run pytest tests/test_reclaim.py -v` -- all 17 tests pass. Run full suite `uv run pytest tests/ -v` to verify no regressions.
  </verify>
  <done>
  All race condition scenarios tested: stale verdicts rejected, valid verdicts accepted, reclaim increments fence token, backward compatibility preserved when claim_generation omitted with valid reviewer_id. Foreign reviewer verdicts rejected via claimed_by authorization check. Fence bypass prevention rejects verdicts on claimed reviews when both claim_generation and reviewer_id are omitted. Non-claimed reviews unaffected (backward compatible). Audit events recorded for reclaim operations.
  </done>
</task>

</tasks>

<verification>
- `uv run pytest tests/ -v` from tools/gsd-review-broker/ -- all tests pass (existing + new)
- submit_verdict signature shows `claim_generation: int | None = None`
- submit_verdict has fence bypass prevention: rejects claimed reviews when both claim_generation and reviewer_id omitted
- submit_verdict has claimed_by authorization check for claimed reviews
- claim_review response includes claim_generation
- reclaim_review increments claim_generation atomically
- Full race scenario test passes (reviewer A stale, reviewer B succeeds)
- Foreign reviewer verdict rejection test passes (claimed_by mismatch)
- Fence bypass prevention test passes (both identifiers omitted on claimed review -> rejected)
- Non-claimed review backward compatibility test passes (both omitted -> accepted)
- No breaking changes to existing tool signatures (backward compatible)
</verification>

<success_criteria>
Fenced reclaim system prevents stale verdicts via claim_generation. claimed_by authorization prevents foreign reviewers from bypassing the fence by omitting claim_generation. Fence bypass prevention rejects verdicts on claimed reviews when both claim_generation and reviewer_id are omitted, closing the final bypass path. claim_generation flows through claim -> verdict path. reclaim_review function ready for background task integration in plan 04. All 17 reclaim tests pass. Existing test suite has zero regressions.
</success_criteria>

<output>
After completion, create `.planning/phases/07-add-reviewer-lifecycle-management-to-broker/07-03-SUMMARY.md`
</output>
