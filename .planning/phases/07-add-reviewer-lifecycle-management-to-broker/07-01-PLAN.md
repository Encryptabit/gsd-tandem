---
phase: 07-add-reviewer-lifecycle-management-to-broker
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tools/gsd-review-broker/src/gsd_review_broker/db.py
  - tools/gsd-review-broker/src/gsd_review_broker/models.py
  - tools/gsd-review-broker/src/gsd_review_broker/state_machine.py
  - tools/gsd-review-broker/src/gsd_review_broker/config_schema.py
  - tools/gsd-review-broker/reviewer_prompt.md
  - tools/gsd-review-broker/tests/test_db_schema.py
  - tools/gsd-review-broker/tests/test_config_schema.py
autonomous: true
requirements:
  - RLMC-06
  - RLMC-07

must_haves:
  truths:
    - "reviewers table exists with all required columns after schema migration"
    - "reviews table has claim_generation and claimed_at columns after migration"
    - "state machine allows CLAIMED -> PENDING transition for reclaim"
    - "SpawnConfig validates model names against allowlist and rejects invalid values"
    - "Reviewer prompt template file exists and contains the review loop instructions"
    - "New audit event type constants are defined for reviewer lifecycle"
    - "load_spawn_config returns None when reviewer_pool key is missing from config"
  artifacts:
    - path: "tools/gsd-review-broker/src/gsd_review_broker/config_schema.py"
      provides: "SpawnConfig Pydantic model with field validators"
      exports: ["SpawnConfig", "ALLOWED_MODELS", "load_spawn_config"]
    - path: "tools/gsd-review-broker/reviewer_prompt.md"
      provides: "Reviewer prompt template with placeholder variables"
      min_lines: 10
    - path: "tools/gsd-review-broker/tests/test_config_schema.py"
      provides: "Tests for SpawnConfig validation"
      min_lines: 30
  key_links:
    - from: "tools/gsd-review-broker/src/gsd_review_broker/db.py"
      to: "SCHEMA_MIGRATIONS list"
      via: "ALTER TABLE and CREATE TABLE statements"
      pattern: "CREATE TABLE IF NOT EXISTS reviewers"
    - from: "tools/gsd-review-broker/src/gsd_review_broker/state_machine.py"
      to: "VALID_TRANSITIONS"
      via: "CLAIMED -> PENDING entry"
      pattern: "ReviewStatus\\.PENDING.*# reclaim"
---

<objective>
Schema foundation, config validation, and data model updates for reviewer lifecycle management.

Purpose: Establish the database schema (reviewers table, fence token columns), state machine changes, config validation, audit event types, and reviewer prompt template that all subsequent plans depend on.
Output: Updated schema migrations, SpawnConfig model, state machine with reclaim transition, prompt template, and tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-add-reviewer-lifecycle-management-to-broker/07-RESEARCH.md
@tools/gsd-review-broker/src/gsd_review_broker/db.py
@tools/gsd-review-broker/src/gsd_review_broker/models.py
@tools/gsd-review-broker/src/gsd_review_broker/state_machine.py
@tools/gsd-review-broker/tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema migrations, models, and state machine update</name>
  <files>
    tools/gsd-review-broker/src/gsd_review_broker/db.py
    tools/gsd-review-broker/src/gsd_review_broker/models.py
    tools/gsd-review-broker/src/gsd_review_broker/state_machine.py
  </files>
  <action>
  **db.py** -- Append these migrations to the `SCHEMA_MIGRATIONS` list:

  1. CREATE TABLE IF NOT EXISTS reviewers with columns:
     - id TEXT PRIMARY KEY (e.g. "codex-r1-a7f3b2e1")
     - display_name TEXT NOT NULL (e.g. "codex-r1")
     - session_token TEXT NOT NULL
     - status TEXT NOT NULL DEFAULT 'active' CHECK(status IN ('active','draining','terminated'))
     - pid INTEGER (OS process ID)
     - spawned_at TEXT NOT NULL DEFAULT (datetime('now'))
     - last_active_at TEXT NOT NULL DEFAULT (datetime('now'))
     - terminated_at TEXT
     - reviews_completed INTEGER NOT NULL DEFAULT 0
     - total_review_seconds REAL NOT NULL DEFAULT 0.0
     - approvals INTEGER NOT NULL DEFAULT 0
     - rejections INTEGER NOT NULL DEFAULT 0
  2. CREATE INDEX IF NOT EXISTS idx_reviewers_session ON reviewers(session_token)
  3. CREATE INDEX IF NOT EXISTS idx_reviewers_status ON reviewers(status)
  4. ALTER TABLE reviews ADD COLUMN claim_generation INTEGER NOT NULL DEFAULT 0
  5. ALTER TABLE reviews ADD COLUMN claimed_at TEXT

  Note: The migration for `ALTER TABLE reviews ADD COLUMN project TEXT` already exists (labeled "Phase 7 migrations" in db.py). Keep it. Add the new migrations after the existing Phase 5 audit_events migrations. Add a comment `# Phase 7 migrations -- reviewer pool` before the new block.

  **models.py** -- Add new enum members to AuditEventType:
  - REVIEWER_SPAWNED = "reviewer_spawned"
  - REVIEWER_DRAIN_START = "reviewer_drain_start"
  - REVIEWER_TERMINATED = "reviewer_terminated"
  - REVIEW_RECLAIMED = "review_reclaimed"

  Add a new ReviewerStatus StrEnum:
  - ACTIVE = "active"
  - DRAINING = "draining"
  - TERMINATED = "terminated"

  **state_machine.py** -- Add `ReviewStatus.PENDING` to the CLAIMED transition set so reclaim (CLAIMED -> PENDING) is valid. Add a comment `# reclaim on timeout` next to it.
  </action>
  <verify>
  Run `cd C:/Projects/gsd-tandem/tools/gsd-review-broker && uv run pytest tests/test_db_schema.py tests/test_state_machine.py -v` -- existing tests must still pass. Manually verify by reading the modified files that the migrations and enum values are correct.
  </verify>
  <done>
  reviewers table schema defined in SCHEMA_MIGRATIONS. claim_generation and claimed_at columns added to reviews. CLAIMED -> PENDING transition valid. ReviewerStatus and new AuditEventType members exist.
  </done>
</task>

<task type="auto">
  <name>Task 2: SpawnConfig validation model, reviewer prompt template, and tests</name>
  <files>
    tools/gsd-review-broker/src/gsd_review_broker/config_schema.py
    tools/gsd-review-broker/reviewer_prompt.md
    tools/gsd-review-broker/tests/test_config_schema.py
    tools/gsd-review-broker/tests/test_db_schema.py
  </files>
  <action>
  **config_schema.py** -- Create new module with:

  1. `ALLOWED_MODELS` set of strings: Include current known Codex-capable models. Use a reasonable set like `{"o4-mini", "o3", "codex-mini-latest"}` -- the exact list can evolve, but the mechanism must exist and reject unknown models.

  2. `SpawnConfig(BaseModel)` Pydantic model with:
     - model: str = Field(default="o4-mini") with @field_validator that checks against ALLOWED_MODELS
     - reasoning_effort: str = Field(default="high") with @field_validator ensuring value in ("low", "medium", "high")
     - workspace_path: str (required, no default -- must be explicitly set)
     - wsl_distro: str = Field(default="Ubuntu")
     - max_pool_size: int = Field(default=3, ge=1, le=10)
     - idle_timeout_seconds: float = Field(default=300.0, ge=60.0)
     - max_ttl_seconds: float = Field(default=3600.0, ge=300.0)
     - claim_timeout_seconds: float = Field(default=1200.0, ge=60.0) -- 20 minutes
     - spawn_cooldown_seconds: float = Field(default=10.0, ge=1.0)
     - prompt_template_path: str = Field(default="reviewer_prompt.md")
     - scaling_ratio: float = Field(default=3.0, ge=1.0) -- pending:reviewer ratio threshold
     - background_check_interval_seconds: float = Field(default=30.0, ge=5.0)

  3. `load_spawn_config(config_path: str | Path) -> SpawnConfig | None` function:
     - If the file doesn't exist, raise FileNotFoundError.
     - Read the JSON config file.
     - If the `"reviewer_pool"` key is **missing or absent**, return `None`. This is the canonical behavior: no reviewer_pool key means pool is disabled. Do NOT return a default SpawnConfig.
     - If the `"reviewer_pool"` key **exists**, validate its contents with SpawnConfig and return the constructed SpawnConfig instance.
     - This ensures backward compatibility: existing config.json files without reviewer_pool silently disable the pool rather than crashing or enabling it with defaults.

  **reviewer_prompt.md** -- Create template file with the reviewer loop instructions. Use `{reviewer_id}` and `{claim_generation_note}` as template placeholders. Content should match the existing PowerShell script's prompt structure:
  - You are reviewer "{reviewer_id}". Loop indefinitely:
  - 1) list_reviews(status="pending", wait=true).
  - 2) When reviews appear, process in order; claim_review(review_id=ID, reviewer_id="{reviewer_id}").
  - 3) get_proposal(review_id=ID).
  - 4) Thorough review focused on correctness, regressions, security, data integrity, missing tests.
  - 5) submit_verdict with claim_generation from the claim_review response.
  - 6) If approved or changes_requested, close_review.
  - 7) Loop.
  - Always include reasoning and prioritize catching real risks.

  **test_config_schema.py** -- Create test file with:
  - test_default_config: construct SpawnConfig with just workspace_path, verify defaults
  - test_invalid_model_rejected: verify ValidationError on unknown model string
  - test_invalid_reasoning_effort_rejected: verify ValidationError on bad reasoning_effort
  - test_pool_size_bounds: verify ge=1, le=10 constraints
  - test_timeout_minimums: verify ge constraints on timeout fields
  - test_load_spawn_config_from_file: write a temp JSON file with reviewer_pool key, load it, verify SpawnConfig returned
  - test_load_spawn_config_missing_file: verify FileNotFoundError
  - test_load_spawn_config_missing_key: write a temp JSON file WITHOUT reviewer_pool key, call load_spawn_config, verify it returns None (not a default SpawnConfig, not an error)
  - test_shell_metacharacter_in_model_rejected: verify model like "; rm -rf /" is rejected by allowlist

  **test_db_schema.py** -- Add tests that the reviewers table and new review columns exist after ensure_schema:
  - test_reviewers_table_exists: INSERT and SELECT from reviewers table
  - test_claim_generation_column_exists: verify reviews.claim_generation defaults to 0
  - test_claimed_at_column_exists: verify reviews.claimed_at is nullable
  </action>
  <verify>
  Run `cd C:/Projects/gsd-tandem/tools/gsd-review-broker && uv run pytest tests/test_config_schema.py tests/test_db_schema.py -v` -- all new tests pass. Verify reviewer_prompt.md exists and contains reviewer loop instructions.
  </verify>
  <done>
  SpawnConfig validates all spawn parameters with allowlists and range checks. load_spawn_config returns None when reviewer_pool key is missing (pool disabled). Reviewer prompt template exists. Schema tests confirm reviewers table and fence token columns. Config tests confirm validation catches invalid models, metacharacters, and missing-key case.
  </done>
</task>

</tasks>

<verification>
- `uv run pytest tests/ -v` from tools/gsd-review-broker/ -- all existing + new tests pass
- reviewers table creation SQL in SCHEMA_MIGRATIONS
- claim_generation and claimed_at ALTER TABLE in SCHEMA_MIGRATIONS
- CLAIMED -> PENDING in state machine VALID_TRANSITIONS
- SpawnConfig rejects invalid model names and shell metacharacters
- load_spawn_config returns None when reviewer_pool key absent (not a default SpawnConfig)
- reviewer_prompt.md exists with template variables
</verification>

<success_criteria>
All schema, model, config, and state machine foundations are in place for the ReviewerPool (plan 02) and fenced reclaim (plan 03) to build on. All tests pass including new schema and config validation tests. load_spawn_config behavior is canonical: missing key returns None (pool disabled).
</success_criteria>

<output>
After completion, create `.planning/phases/07-add-reviewer-lifecycle-management-to-broker/07-01-SUMMARY.md`
</output>
