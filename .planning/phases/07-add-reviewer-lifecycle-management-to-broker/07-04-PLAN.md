---
phase: 07-add-reviewer-lifecycle-management-to-broker
plan: 04
type: execute
wave: 3
depends_on: ["07-02", "07-03"]
files_modified:
  - tools/gsd-review-broker/src/gsd_review_broker/db.py
  - tools/gsd-review-broker/src/gsd_review_broker/server.py
  - tools/gsd-review-broker/src/gsd_review_broker/tools.py
  - tools/gsd-review-broker/tests/test_scaling.py
  - tools/gsd-review-broker/tests/conftest.py
autonomous: true
requirements:
  - RLMC-02
  - RLMC-05
  - RLMC-08

must_haves:
  truths:
    - "Background scaling task runs periodically and checks idle/TTL/claim timeouts"
    - "Ratio-based scaling spawns a reviewer when pending > scaling_ratio * active_reviewers"
    - "create_review triggers reactive scaling check"
    - "Idle timeout terminates reviewers with no activity beyond configured duration"
    - "TTL expiry triggers graceful drain (finish current review, then terminate)"
    - "Claim timeout reclaims reviews stuck in claimed state beyond 20 minutes"
    - "spawn_reviewer MCP tool exposes manual spawn with pool cap enforcement"
    - "kill_reviewer MCP tool terminates only broker-managed reviewer IDs"
    - "Stale session claims are reclaimed to pending on broker startup"
    - "Pool integrates with broker lifespan (start background tasks, shutdown on exit)"
  artifacts:
    - path: "tools/gsd-review-broker/src/gsd_review_broker/db.py"
      provides: "AppContext with pool field, lifespan with background tasks and stale session recovery"
      contains: "pool: ReviewerPool"
    - path: "tools/gsd-review-broker/src/gsd_review_broker/tools.py"
      provides: "spawn_reviewer and kill_reviewer MCP tools, reactive scaling in create_review"
      exports: ["spawn_reviewer", "kill_reviewer"]
    - path: "tools/gsd-review-broker/tests/test_scaling.py"
      provides: "Tests for auto-scaling, idle timeout, TTL, claim timeout, stale session recovery"
      min_lines: 120
  key_links:
    - from: "tools/gsd-review-broker/src/gsd_review_broker/db.py"
      to: "tools/gsd-review-broker/src/gsd_review_broker/pool.py"
      via: "ReviewerPool created in lifespan"
      pattern: "ReviewerPool.*session_token"
    - from: "tools/gsd-review-broker/src/gsd_review_broker/tools.py"
      to: "tools/gsd-review-broker/src/gsd_review_broker/pool.py"
      via: "pool.spawn_reviewer and pool.drain_reviewer calls"
      pattern: "app\\.pool\\.spawn_reviewer|app\\.pool\\.drain_reviewer"
    - from: "tools/gsd-review-broker/src/gsd_review_broker/db.py"
      to: "background tasks"
      via: "asyncio.create_task for periodic checks"
      pattern: "asyncio\\.create_task.*periodic"
---

<objective>
Auto-scaling, background tasks, MCP tools, lifespan integration, and stale session recovery.

Purpose: Wire the ReviewerPool (plan 02) and fenced reclaim (plan 03) into the broker's runtime: background tasks for periodic scaling/reclaim checks, reactive scaling on create_review, manual spawn/kill MCP tools, and stale session recovery on startup. This completes the reviewer lifecycle management system.
Output: Fully integrated pool with auto-scaling, background tasks, manual override tools, and comprehensive tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-add-reviewer-lifecycle-management-to-broker/07-RESEARCH.md
@.planning/phases/07-add-reviewer-lifecycle-management-to-broker/07-01-SUMMARY.md
@.planning/phases/07-add-reviewer-lifecycle-management-to-broker/07-02-SUMMARY.md
@.planning/phases/07-add-reviewer-lifecycle-management-to-broker/07-03-SUMMARY.md
@tools/gsd-review-broker/src/gsd_review_broker/db.py
@tools/gsd-review-broker/src/gsd_review_broker/pool.py
@tools/gsd-review-broker/src/gsd_review_broker/tools.py
@tools/gsd-review-broker/src/gsd_review_broker/config_schema.py
@tools/gsd-review-broker/tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Lifespan integration, background tasks, and stale session recovery</name>
  <files>
    tools/gsd-review-broker/src/gsd_review_broker/db.py
    tools/gsd-review-broker/tests/conftest.py
  </files>
  <action>
  **db.py -- AppContext update:**
  Add `pool: ReviewerPool | None = None` field to AppContext dataclass. Import ReviewerPool from pool module.

  **db.py -- broker_lifespan update:**
  After `ensure_schema(db)` and before `yield`:

  1. Load spawn config: Try to load `SpawnConfig` from `.planning/config.json` (look for a `"reviewer_pool"` key). If no config file found or no reviewer_pool key, set pool to None (pool features disabled, broker works as before). Use the repo_root to resolve relative paths. Log whether pool is enabled or disabled.

  2. If config loaded successfully, create `ReviewerPool(session_token=secrets.token_hex(4), config=spawn_config)`.

  3. **Stale session recovery:** Query `SELECT id, session_token, status FROM reviewers WHERE status IN ('active', 'draining')`. For each reviewer with a session_token different from the current pool's session_token, UPDATE status to 'terminated', set terminated_at. Then query `SELECT id, claimed_by FROM reviews WHERE status = 'claimed'`. For each claimed review where claimed_by matches a terminated stale reviewer_id, call `reclaim_review(review_id, app, reason="stale_session")`. Log how many stale reviewers and reviews were recovered.

  4. Start background tasks:
     ```python
     scaling_task = asyncio.create_task(_periodic_check(ctx, "scaling"))
     ```
     Create a single `_periodic_check` async function (defined at module level or as a standalone function in db.py) that runs in a `while True` loop:
     - `await asyncio.sleep(config.background_check_interval_seconds)`
     - Call `await _check_idle_timeouts(ctx)` -- query reviewers with last_active_at older than idle_timeout, drain them.
     - Call `await _check_ttl_expiry(ctx)` -- query reviewers with spawned_at older than max_ttl, drain them.
     - Call `await _check_claim_timeouts(ctx)` -- query reviews WHERE status='claimed' AND claimed_at < now - claim_timeout, reclaim them.
     - Call `await _check_dead_processes(ctx)` -- iterate pool._processes, check proc.returncode is not None (process exited), clean up.
     - Wrap each check in try/except (log errors, don't crash the background task).
     - Handle `asyncio.CancelledError` by re-raising for clean shutdown.

  5. Set `ctx.pool = pool` before yield.

  6. In the `finally` block (before db close):
     - Cancel background task(s).
     - Await cancelled tasks with `suppress(CancelledError)`.
     - If pool exists, call `await pool.shutdown_all(db, write_lock)`.

  **conftest.py update:**
  Update the `ctx` fixture to include `pool=None` in AppContext construction so existing tests keep working. Pool-enabled tests will set it explicitly.

  **Helper functions** (defined in db.py or in a new module, at your discretion):

  `_check_idle_timeouts(ctx)`: Query reviewers WHERE status='active' AND last_active_at < datetime('now', '-{idle_timeout} seconds'). For each, call `pool.drain_reviewer(id, db, write_lock, reason="idle")`.

  `_check_ttl_expiry(ctx)`: Query reviewers WHERE status='active' AND spawned_at < datetime('now', '-{max_ttl} seconds'). For each, call `pool.drain_reviewer(id, db, write_lock, reason="ttl")`.

  `_check_claim_timeouts(ctx)`: Query reviews WHERE status='claimed' AND claimed_at < datetime('now', '-{claim_timeout} seconds'). For each, call `reclaim_review(review_id, ctx, reason="claim_timeout")`. Import reclaim_review from tools module.

  `_check_dead_processes(ctx)`: Iterate pool._processes items. If proc.returncode is not None, the process exited unexpectedly. Record reviewer_terminated audit event, update DB, remove from _processes.
  </action>
  <verify>
  Run `cd C:/Projects/gsd-tandem/tools/gsd-review-broker && uv run pytest tests/ -v` -- ALL existing tests still pass (pool=None means no pool features activate). Verify broker_lifespan creates and cleans up background tasks.
  </verify>
  <done>
  AppContext has pool field. broker_lifespan creates ReviewerPool if config exists, starts background tasks, recovers stale sessions on startup, shuts down cleanly. Existing tests unaffected (pool=None by default).
  </done>
</task>

<task type="auto">
  <name>Task 2: MCP tools (spawn/kill) and reactive scaling</name>
  <files>
    tools/gsd-review-broker/src/gsd_review_broker/tools.py
    tools/gsd-review-broker/tests/test_scaling.py
  </files>
  <action>
  **tools.py -- Add spawn_reviewer MCP tool:**
  ```python
  @mcp.tool
  async def spawn_reviewer(ctx: Context = None) -> dict:
  ```
  - Get app context. If app.pool is None, return error: "Reviewer pool not configured. Add reviewer_pool section to config."
  - Acquire pool._spawn_lock to serialize scaling decisions.
  - Call `app.pool.spawn_reviewer(app.db, app.write_lock)`.
  - Return result (success or error from pool).
  - Log spawn result.

  **tools.py -- Add kill_reviewer MCP tool:**
  ```python
  @mcp.tool
  async def kill_reviewer(reviewer_id: str, ctx: Context = None) -> dict:
  ```
  - Get app context. If app.pool is None, return error.
  - Validate reviewer_id exists in pool._processes (cannot kill arbitrary processes per user decision).
  - Call `app.pool.drain_reviewer(reviewer_id, app.db, app.write_lock, reason="manual")`.
  - Return result.
  - Log kill result.

  **tools.py -- Add reactive scaling to create_review:**
  At the END of the `create_review` function (after the notification calls, before the final return), add:
  ```python
  # Reactive scaling check
  if app.pool is not None:
      asyncio.create_task(_reactive_scale_check(app))
  ```

  Create `_reactive_scale_check(app)` as an async function:
  - Count pending reviews: SELECT COUNT(*) FROM reviews WHERE status='pending'.
  - Count active reviewers: app.pool.active_count.
  - If active_count == 0 and pending > 0: spawn (cold start).
  - Elif pending > app.pool.config.scaling_ratio * active_count: spawn.
  - Else: do nothing.
  - Wrap in try/except to prevent create_review from failing due to scaling errors.
  - Use pool._spawn_lock to prevent concurrent scaling decisions.

  **tools.py -- Add list_reviewers MCP tool:**
  ```python
  @mcp.tool
  async def list_reviewers(ctx: Context = None) -> dict:
  ```
  - If app.pool is None, return error.
  - Query reviewers table: SELECT id, display_name, status, pid, spawned_at, last_active_at, reviews_completed, total_review_seconds, approvals, rejections FROM reviewers WHERE session_token = pool.session_token ORDER BY spawned_at ASC.
  - Return list of reviewer dicts.
  - Include pool_size (active count) and session_token in response for debugging.

  **test_scaling.py -- Comprehensive tests** (mock subprocess throughout):

  1. **test_spawn_reviewer_tool**: Call spawn_reviewer via tool .fn, verify success response with reviewer_id.
  2. **test_spawn_reviewer_pool_not_configured**: Set app.pool = None, call spawn_reviewer, verify error.
  3. **test_kill_reviewer_tool**: Spawn a reviewer, then kill it, verify drain initiated.
  4. **test_kill_reviewer_unknown_id**: Call kill_reviewer with unknown ID, verify error.
  5. **test_kill_reviewer_pool_not_configured**: Set app.pool = None, verify error.
  6. **test_reactive_scaling_cold_start**: Create a review with pool active (0 reviewers, 1 pending), verify spawn triggered.
  7. **test_reactive_scaling_ratio**: Set scaling_ratio=3, have 1 active reviewer and 4 pending reviews, verify spawn triggered.
  8. **test_reactive_scaling_sufficient_reviewers**: 1 active reviewer, 2 pending reviews (ratio 3:1 not exceeded), verify no spawn.
  9. **test_idle_timeout_triggers_drain**: Create reviewer, set last_active_at to old timestamp, run _check_idle_timeouts, verify drain called.
  10. **test_ttl_expiry_triggers_drain**: Create reviewer, set spawned_at to old timestamp, run _check_ttl_expiry, verify drain called.
  11. **test_claim_timeout_triggers_reclaim**: Create and claim a review, set claimed_at to old timestamp, run _check_claim_timeouts, verify reclaim called and review back to pending.
  12. **test_stale_session_recovery_on_startup**: Insert reviewer rows with different session_token, insert claimed reviews referencing those reviewers, simulate startup recovery logic, verify reviewers marked terminated and reviews reclaimed.
  13. **test_list_reviewers_tool**: Spawn reviewer, call list_reviewers, verify response contains the reviewer.
  14. **test_dead_process_cleanup**: Mock a process with returncode != None, run _check_dead_processes, verify reviewer terminated and cleaned up.

  Use conftest fixtures. For pool-enabled tests, create a helper that constructs AppContext with a ReviewerPool and mocked subprocess. Set up a fixture or factory that provides a SpawnConfig with test-appropriate defaults (short timeouts for fast tests).
  </action>
  <verify>
  Run `cd C:/Projects/gsd-tandem/tools/gsd-review-broker && uv run pytest tests/test_scaling.py -v` -- all 14 tests pass. Run `uv run pytest tests/ -v` -- full suite passes with no regressions.
  </verify>
  <done>
  spawn_reviewer and kill_reviewer MCP tools work with pool cap and ID validation. Reactive scaling triggers on create_review. Background tasks handle idle timeout, TTL expiry, and claim timeout. Stale session recovery works on startup. list_reviewers shows pool status. Full test coverage with mocked subprocesses.
  </done>
</task>

</tasks>

<verification>
- `uv run pytest tests/ -v` from tools/gsd-review-broker/ -- ALL tests pass (existing + new)
- spawn_reviewer MCP tool enforces pool cap
- kill_reviewer MCP tool only targets broker-managed IDs
- create_review triggers reactive scaling check
- Background periodic task runs idle/TTL/claim timeout checks
- Stale session recovery reclaims reviews from dead sessions on startup
- Pool shutdown terminates all reviewers on broker exit
- Existing broker functionality unchanged when pool=None (no config)
</verification>

<success_criteria>
Complete reviewer lifecycle management integrated into the broker. Auto-scaling responds to backlog pressure. Background tasks enforce timeouts. Manual override tools available. Stale sessions recovered on restart. All tests pass including 14+ new scaling/integration tests. Broker still works normally without pool configuration (backward compatible).
</success_criteria>

<output>
After completion, create `.planning/phases/07-add-reviewer-lifecycle-management-to-broker/07-04-SUMMARY.md`
</output>
