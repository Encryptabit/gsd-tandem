---
phase: 02-proposal-and-diff-protocol
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - tools/gsd-review-broker/src/gsd_review_broker/tools.py
  - tools/gsd-review-broker/tests/conftest.py
  - tools/gsd-review-broker/tests/test_tools.py
  - tools/gsd-review-broker/tests/test_proposals.py
autonomous: true

must_haves:
  truths:
    - "Proposer can create a proposal with intent, description, and unified diff via create_review tool"
    - "Proposer can revise a proposal after changes_requested by calling create_review with existing review_id"
    - "Reviewer claiming a review with a diff triggers git apply --check validation inside the write_lock"
    - "Reviewer claiming a review with a bad diff gets auto-rejected with changes_requested status and git stderr details"
    - "Reviewer can submit comment verdict without state transition, keeping the review claimable"
    - "Notes are required for request_changes and comment verdicts but optional for approve"
    - "Reviewer can retrieve full proposal content (including diff) via get_proposal tool"
  artifacts:
    - path: "tools/gsd-review-broker/src/gsd_review_broker/tools.py"
      provides: "Extended create_review, claim_review, submit_verdict + new get_proposal tool"
      exports: ["create_review", "claim_review", "submit_verdict", "get_proposal"]
    - path: "tools/gsd-review-broker/tests/test_proposals.py"
      provides: "Full proposal lifecycle tests"
      min_lines: 80
    - path: "tools/gsd-review-broker/tests/test_tools.py"
      provides: "Extended tests including comment verdict and notes enforcement"
      contains: "comment"
  key_links:
    - from: "tools/gsd-review-broker/src/gsd_review_broker/tools.py"
      to: "diff_utils.py"
      via: "import validate_diff, extract_affected_files"
      pattern: "from gsd_review_broker.diff_utils import"
    - from: "tools.py create_review"
      to: "extract_affected_files"
      via: "function call when diff is provided"
      pattern: "extract_affected_files"
    - from: "tools.py claim_review"
      to: "validate_diff"
      via: "function call inside write_lock when diff exists"
      pattern: "validate_diff"
    - from: "tools.py claim_review"
      to: "AppContext.repo_root"
      via: "cwd parameter for validate_diff"
      pattern: "app\\.repo_root"
    - from: "tools.py submit_verdict"
      to: "comment verdict handling"
      via: "new branch for comment type"
      pattern: "comment"
    - from: "tools.py get_proposal"
      to: "SELECT description, diff, affected_files"
      via: "read-only database query"
      pattern: "get_proposal"
---

<objective>
Extend all MCP tool handlers for proposal content and add the get_proposal tool to complete Phase 2's tool surface.

Purpose: With the schema, models, and diff_utils in place from Plan 01, this plan wires everything together in the tool layer -- the actual MCP interface that proposer and reviewer agents interact with. After this plan, the broker supports the full proposal lifecycle: submit with diff, validate on claim, issue typed verdicts, revise proposals, and retrieve proposal content.

Output: Extended tools.py with updated create_review (description + diff + revision), claim_review (git apply --check validation + inline content), submit_verdict (comment type + notes enforcement), new get_proposal tool, plus comprehensive tests in test_proposals.py and extended test_tools.py.
</objective>

<execution_context>
@C:\Users\Jacar\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Jacar\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-proposal-and-diff-protocol/02-RESEARCH.md
@.planning/phases/02-proposal-and-diff-protocol/02-01-SUMMARY.md
@tools/gsd-review-broker/src/gsd_review_broker/tools.py
@tools/gsd-review-broker/src/gsd_review_broker/db.py
@tools/gsd-review-broker/src/gsd_review_broker/diff_utils.py
@tools/gsd-review-broker/src/gsd_review_broker/models.py
@tools/gsd-review-broker/tests/conftest.py
@tools/gsd-review-broker/tests/test_tools.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend tool handlers and add get_proposal</name>
  <files>
    tools/gsd-review-broker/src/gsd_review_broker/tools.py
  </files>
  <action>
    Extend tools.py with all Phase 2 tool changes. Import `validate_diff` and `extract_affected_files` from `gsd_review_broker.diff_utils`.

    **1. Extend create_review with proposal content + revision flow:**
    - Add three new optional parameters: `description: str | None = None`, `diff: str | None = None`, `review_id: str | None = None`.
    - When `diff` is provided, call `extract_affected_files(diff)` to generate the `affected_files` JSON string.
    - **New review flow** (review_id is None): INSERT now includes description, diff, and affected_files columns alongside existing fields.
    - **Revision flow** (review_id is provided): This is for resubmitting after changes_requested.
      - Inside write_lock + BEGIN IMMEDIATE, SELECT the review's status.
      - If review not found, ROLLBACK and return error.
      - Validate transition from current status to PENDING (must be in changes_requested state per state machine).
      - If transition invalid, ROLLBACK and return error.
      - UPDATE the review: set status=pending, intent=new intent, description=new description, diff=new diff, affected_files=new affected_files, claimed_by=NULL, verdict_reason=NULL, updated_at=datetime('now').
      - COMMIT. Return `{"review_id": review_id, "status": "pending", "revised": True}`.
    - Update the docstring to document both flows: new review (omit review_id) and revision (pass existing review_id in changes_requested state).

    **2. Extend claim_review with diff validation and inline content:**
    - Update the SELECT query to also fetch `diff`, `intent`, `description`, `affected_files` columns.
    - After validating the transition to CLAIMED but BEFORE performing the UPDATE, check if the review has a diff:
      - If `diff_text = row["diff"]` is truthy, call `await validate_diff(diff_text, cwd=app.repo_root)` INSIDE the write_lock (per research Pitfall 6 -- prevents wasted subprocess calls on concurrent claims).
      - If `is_valid` is False: UPDATE the review to status=changes_requested, verdict_reason=f"Auto-rejected: diff does not apply cleanly.\n{error_detail}", claimed_by="broker-validator". COMMIT. Return `{"review_id": review_id, "status": "changes_requested", "auto_rejected": True, "validation_error": error_detail}`.
    - On successful claim: build the return dict with review_id, status, claimed_by, plus intent. Conditionally include `description`, `affected_files` (as parsed JSON via json.loads if not None), and `has_diff: True` if diff exists. Do NOT include the full diff text in the claim response (reviewer uses get_proposal for that -- per research recommendation to avoid MCP output size issues).

    **3. Extend submit_verdict with comment type and notes enforcement:**
    - Add "comment" as a recognized verdict type. Comment does NOT cause a state transition -- it records feedback while keeping the review in its current state.
    - Enforce notes requirement: if verdict is "request_changes" or "comment" and reason is None or empty string, return error dict: `{"error": "Notes (reason) required for 'changes_requested' verdict."}` or `{"error": "Notes (reason) required for 'comment' verdict."}`.
    - For "comment" verdict: Inside write_lock + BEGIN IMMEDIATE, SELECT the review. Verify review exists and status is "claimed" or "in_review" (comment only valid on active reviews). UPDATE only the verdict_reason and updated_at (do NOT change status). COMMIT. Return `{"review_id": review_id, "status": current_status, "verdict": "comment", "verdict_reason": reason}`.
    - For "approved" verdict: notes (reason) remain optional (no enforcement).
    - Update the error message for invalid verdict to list all three options: "approved", "changes_requested", or "comment".

    **4. Add new get_proposal tool:**
    - Create a new `@mcp.tool` decorated async function `get_proposal(review_id: str, ctx: Context = None) -> dict`.
    - This is a read-only tool (like get_review_status -- no transactions, no write_lock).
    - SELECT id, status, intent, description, diff, affected_files FROM reviews WHERE id = ?.
    - If not found, return `{"error": f"Review {review_id} not found"}`.
    - Return dict with all fields. Parse affected_files from JSON string to list via json.loads if not None.
    - Docstring: "Retrieve full proposal content including diff. Use after claim_review to read the complete unified diff for review."
  </action>
  <verify>
    Run `python -c "from gsd_review_broker.tools import get_proposal; print('get_proposal registered')"` from tools/gsd-review-broker/ to confirm the new tool imports. Run `uv run pytest tests/test_diff_utils.py -v` to ensure Plan 01 tests still pass (no import breakage). Run `uv run ruff check src/` to check for lint issues.
  </verify>
  <done>
    tools.py exports 7 MCP tools: create_review (extended with description, diff, review_id for revision), list_reviews (unchanged), claim_review (extended with git apply --check validation and inline proposal metadata), submit_verdict (extended with comment type and notes enforcement), get_review_status (unchanged), close_review (unchanged), get_proposal (new read-only tool). All import cleanly and pass lint.
  </done>
</task>

<task type="auto">
  <name>Task 2: Proposal lifecycle tests and verdict extension tests</name>
  <files>
    tools/gsd-review-broker/tests/conftest.py
    tools/gsd-review-broker/tests/test_tools.py
    tools/gsd-review-broker/tests/test_proposals.py
  </files>
  <action>
    **1. Update conftest.py** with a helper fixture or constant for test diff data:
    - Add a sample valid unified diff string as a module-level constant (e.g., `SAMPLE_DIFF` -- a simple diff that modifies a line in a hypothetical file). This will be reused across test files.
    - Add a `SAMPLE_DESCRIPTION` constant with a PR-style description string.
    - Optionally add a fixture that creates a temporary git repo (using tmp_path) with a committed file matching the sample diff, for tests that need git apply --check to succeed. If this is complex, individual tests can set up their own repos.

    **2. Extend test_tools.py** with new verdict tests:
    - **TestSubmitVerdict**: Add tests for:
      - `test_submit_verdict_comment_records_feedback`: Create review, claim, submit "comment" verdict with reason. Verify status stays "claimed" and verdict_reason is set.
      - `test_submit_verdict_comment_requires_notes`: Create review, claim, submit "comment" with no reason. Verify error dict returned.
      - `test_submit_verdict_changes_requested_requires_notes`: Create review, claim, submit "changes_requested" with no reason. Verify error dict returned.
      - `test_submit_verdict_approved_without_notes_succeeds`: Create review, claim, submit "approved" with no reason. Verify success (reason optional for approve).

    **3. Create test_proposals.py** with comprehensive proposal lifecycle tests:

    - **TestCreateReviewWithProposal:**
      - `test_create_review_with_description_and_diff`: Call create_review with intent, description, and a valid diff string. Verify success. Query DB to confirm description, diff, and affected_files columns are populated.
      - `test_create_review_with_description_only`: Call create_review with description but no diff. Verify success, diff is NULL, affected_files is NULL.
      - `test_create_review_extracts_affected_files`: Call create_review with a multi-file diff. Query DB for affected_files, parse JSON, verify it contains entries for each file with correct operations.

    - **TestRevisionFlow:**
      - `test_revision_replaces_content`: Create review with diff A, claim, submit changes_requested, then call create_review with same review_id and diff B. Verify status is back to "pending", description/diff updated to new values, claimed_by is NULL, verdict_reason is NULL.
      - `test_revision_from_wrong_state_fails`: Create review (pending state), attempt revision by passing review_id. Verify error (pending -> pending is not a valid transition; must be changes_requested -> pending).
      - `test_revision_not_found_fails`: Attempt revision with non-existent review_id. Verify error.

    - **TestClaimWithDiffValidation:**
      - `test_claim_review_without_diff_succeeds_normally`: Create review without diff, claim it. Verify normal claim success (no validation step).
      - `test_claim_review_returns_proposal_metadata`: Create review with description and diff, claim it. Verify the claim response includes intent, description, affected_files (as parsed list), and has_diff=True, but does NOT include the raw diff text.
      - Note: Testing git apply --check auto-rejection requires a real git repo. Add one test using tmp_path:
        - `test_claim_review_auto_rejects_bad_diff`: Create a temp git repo, create a review with a diff referencing a non-existent file. Mock or configure AppContext.repo_root to point to the temp repo. Claim the review. Verify it returns auto_rejected=True and status=changes_requested. This test requires careful setup -- if too complex with MockContext, test the integration at a higher level or mock validate_diff to return (False, "error").

    - **TestGetProposal:**
      - `test_get_proposal_returns_content`: Create review with description and diff, call get_proposal. Verify all fields returned including diff text and affected_files as a parsed list.
      - `test_get_proposal_not_found`: Call get_proposal with non-existent ID. Verify error dict.
      - `test_get_proposal_without_diff`: Create review without diff, call get_proposal. Verify description is None/null and diff is None/null.

    - **TestFullProposalLifecycle:**
      - `test_proposal_lifecycle_submit_claim_approve_close`: Create review with description + diff (no real git repo needed -- claim without diff validation by not providing diff, OR mock validate_diff). Claim, approve, close. Verify each state transition.
      - `test_proposal_lifecycle_submit_reject_revise_approve`: Create review with description + diff. Claim (mock validate_diff if needed), request_changes with notes, revise with new content, re-claim, approve, close. Verify revision clears old state and full lifecycle completes.

    For tests that need diff validation, prefer mocking `validate_diff` (using `unittest.mock.patch` on `gsd_review_broker.tools.validate_diff`) to return `(True, "")` or `(False, "error detail")` rather than setting up real git repos. This keeps tests fast and focused on the tool logic. The actual validate_diff function is already tested in test_diff_utils.py.
  </action>
  <verify>
    Run `uv run pytest -v` from tools/gsd-review-broker/. All tests pass: existing 44 tests + new verdict tests in test_tools.py + new proposal tests in test_proposals.py. Run `uv run pytest --tb=short` for a clean overview. Verify test count is at least 60 (44 existing + ~4 verdict + ~14 proposal).
  </verify>
  <done>
    test_tools.py extended with comment verdict tests and notes enforcement tests. test_proposals.py covers: proposal creation with description/diff, affected files extraction, revision flow (success + error cases), claim with diff validation (mocked), get_proposal (success + not found), and full lifecycle including revision. All tests pass alongside existing suite. Total test count >= 60.
  </done>
</task>

</tasks>

<verification>
1. `uv run pytest -v` from tools/gsd-review-broker/ passes all tests (>= 60 total)
2. 7 MCP tools registered on the server (create_review, list_reviews, claim_review, submit_verdict, get_review_status, close_review, get_proposal)
3. create_review accepts description, diff, review_id parameters
4. claim_review calls validate_diff when diff present and auto-rejects on failure
5. submit_verdict supports "comment" verdict type without state transition
6. submit_verdict enforces notes for request_changes and comment
7. get_proposal returns full proposal content including diff
8. Revision flow: changes_requested -> create_review(review_id=X) -> pending with cleared reviewer state
</verification>

<success_criteria>
- All 7 MCP tools work correctly per Phase 2 requirements
- Proposal creation stores description, diff, and affected_files
- Diff validation on claim catches bad diffs and auto-rejects with error detail
- Comment verdict records feedback without state transition
- Notes enforcement: required for request_changes/comment, optional for approve
- Revision replaces content and clears reviewer state (claimed_by, verdict_reason)
- get_proposal provides read-only access to full proposal content
- All tests pass (>= 60 total, covering proposal lifecycle end-to-end)
</success_criteria>

<output>
After completion, create `.planning/phases/02-proposal-and-diff-protocol/02-02-SUMMARY.md`
</output>
