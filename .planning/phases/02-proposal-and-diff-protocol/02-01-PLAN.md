---
phase: 02-proposal-and-diff-protocol
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tools/gsd-review-broker/pyproject.toml
  - tools/gsd-review-broker/src/gsd_review_broker/db.py
  - tools/gsd-review-broker/src/gsd_review_broker/models.py
  - tools/gsd-review-broker/src/gsd_review_broker/diff_utils.py
  - tools/gsd-review-broker/src/gsd_review_broker/server.py
  - tools/gsd-review-broker/tests/test_diff_utils.py
autonomous: true

must_haves:
  truths:
    - "Database schema includes description, diff, and affected_files columns on the reviews table"
    - "Existing Phase 1 databases are migrated with ALTER TABLE ADD COLUMN without data loss"
    - "validate_diff runs git apply --check asynchronously and returns (bool, error_string)"
    - "extract_affected_files parses unified diffs and returns JSON with path, operation, added, removed per file"
    - "Server discovers git repo root at startup and stores it in AppContext for diff validation"
  artifacts:
    - path: "tools/gsd-review-broker/src/gsd_review_broker/diff_utils.py"
      provides: "validate_diff and extract_affected_files functions"
      exports: ["validate_diff", "extract_affected_files"]
    - path: "tools/gsd-review-broker/src/gsd_review_broker/db.py"
      provides: "Schema V2 with description, diff, affected_files columns and migrations"
      contains: "SCHEMA_MIGRATIONS"
    - path: "tools/gsd-review-broker/src/gsd_review_broker/models.py"
      provides: "Updated Review model with description, diff, affected_files fields"
      contains: "description"
    - path: "tools/gsd-review-broker/tests/test_diff_utils.py"
      provides: "Tests for diff utility functions"
      min_lines: 40
  key_links:
    - from: "tools/gsd-review-broker/src/gsd_review_broker/diff_utils.py"
      to: "unidiff.PatchSet"
      via: "import"
      pattern: "from unidiff import PatchSet"
    - from: "tools/gsd-review-broker/src/gsd_review_broker/diff_utils.py"
      to: "asyncio.create_subprocess_exec"
      via: "async subprocess for git apply --check"
      pattern: "create_subprocess_exec"
    - from: "tools/gsd-review-broker/src/gsd_review_broker/db.py"
      to: "SCHEMA_MIGRATIONS"
      via: "ensure_schema runs ALTER TABLE migrations"
      pattern: "ALTER TABLE reviews ADD COLUMN"
    - from: "tools/gsd-review-broker/src/gsd_review_broker/server.py"
      to: "db.py"
      via: "broker_lifespan discovers repo_root and stores in AppContext"
      pattern: "repo_root"
---

<objective>
Extend the broker's data layer and add diff utility functions for Phase 2 proposal support.

Purpose: Phase 2 requires proposals to carry structured content (description + unified diffs) and the broker needs to validate diffs against the working tree. This plan establishes the schema, data models, utility functions, and repo root discovery that the tool extensions in Plan 02 depend on.

Output: Updated db.py with V2 schema migrations, new diff_utils.py module with validate_diff and extract_affected_files, updated models.py with new Review fields, updated server.py with repo_root discovery, and test_diff_utils.py with unit tests.
</objective>

<execution_context>
@C:\Users\Jacar\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Jacar\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-proposal-and-diff-protocol/02-RESEARCH.md
@tools/gsd-review-broker/src/gsd_review_broker/db.py
@tools/gsd-review-broker/src/gsd_review_broker/models.py
@tools/gsd-review-broker/src/gsd_review_broker/server.py
@tools/gsd-review-broker/pyproject.toml
@tools/gsd-review-broker/tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema evolution, diff_utils module, model updates, and repo root discovery</name>
  <files>
    tools/gsd-review-broker/pyproject.toml
    tools/gsd-review-broker/src/gsd_review_broker/db.py
    tools/gsd-review-broker/src/gsd_review_broker/models.py
    tools/gsd-review-broker/src/gsd_review_broker/diff_utils.py
    tools/gsd-review-broker/src/gsd_review_broker/server.py
  </files>
  <action>
    1. **Add unidiff dependency to pyproject.toml**: Add `"unidiff>=0.7.5,<1"` to the `dependencies` list. Then run `uv sync` from `tools/gsd-review-broker/` to install it and update uv.lock.

    2. **Update db.py schema with V2 migrations**:
       - Update SCHEMA_SQL to include `description TEXT`, `diff TEXT`, and `affected_files TEXT` columns in the CREATE TABLE statement (after `intent` column). This handles fresh databases.
       - Add a `SCHEMA_MIGRATIONS` list with three `ALTER TABLE reviews ADD COLUMN` statements for description, diff, and affected_files. These handle existing Phase 1 databases.
       - Update `ensure_schema` to iterate `SCHEMA_MIGRATIONS` after executescript, wrapping each in try/except to silently skip if column already exists.
       - Add `repo_root: str | None = None` field to the `AppContext` dataclass (with `default=None`).

    3. **Create diff_utils.py** with two functions:
       - `async def validate_diff(diff_text: str, cwd: str | None = None) -> tuple[bool, str]`: Run `git apply --check` via `asyncio.create_subprocess_exec` with stdin=PIPE, stdout=PIPE, stderr=PIPE, and the `cwd` parameter. Use `proc.communicate(input=diff_text.encode("utf-8"))`. Return `(True, "")` on returncode 0, or `(False, stderr.decode("utf-8", errors="replace").strip())` otherwise.
       - `def extract_affected_files(diff_text: str) -> str`: Parse with `unidiff.PatchSet(diff_text)`. For each patched file, determine operation: `is_added_file` -> "create", `is_removed_file` -> "delete", else "modify". Build a list of dicts with keys `path`, `operation`, `added`, `removed`. Return `json.dumps(files)`. Wrap PatchSet in try/except and return `"[]"` on parse failure.

    4. **Update models.py**: Add three optional fields to the Review model:
       - `description: str | None = None`
       - `diff: str | None = None`
       - `affected_files: str | None = None`

    5. **Add repo root discovery to server.py / db.py**:
       - Add an `async def discover_repo_root() -> str | None` function in db.py that runs `git rev-parse --show-toplevel` via `asyncio.create_subprocess_exec`. Returns the stdout stripped on success, None on failure.
       - In `broker_lifespan`, call `discover_repo_root()` after creating the connection and set `repo_root` on the `AppContext` instance before yielding. This caches the repo root for the lifetime of the server.
  </action>
  <verify>
    Run `uv sync` from tools/gsd-review-broker/ to confirm unidiff installs. Run `python -c "from gsd_review_broker.diff_utils import validate_diff, extract_affected_files; print('OK')"` from tools/gsd-review-broker/ to confirm imports work. Run `python -c "from gsd_review_broker.db import AppContext; print(AppContext.__dataclass_fields__['repo_root'])"` to confirm repo_root field exists. Run `python -c "from gsd_review_broker.models import Review; r = Review(intent='t', agent_type='t', agent_role='t', phase='1', description='d', diff='d', affected_files='[]'); print(r.description)"` to confirm model fields.
  </verify>
  <done>
    db.py has SCHEMA_SQL with 3 new columns and SCHEMA_MIGRATIONS list; AppContext has repo_root field; diff_utils.py exports validate_diff and extract_affected_files; models.py Review has description, diff, affected_files fields; pyproject.toml includes unidiff dependency; uv.lock is updated; broker_lifespan discovers and caches repo_root.
  </done>
</task>

<task type="auto">
  <name>Task 2: Diff utilities test suite</name>
  <files>
    tools/gsd-review-broker/tests/test_diff_utils.py
  </files>
  <action>
    Create test_diff_utils.py with tests for both diff utility functions.

    **extract_affected_files tests:**
    - Test with a simple single-file modify diff (e.g., changing a line in a Python file). Verify the returned JSON contains one entry with operation "modify", correct path, and non-zero added/removed counts.
    - Test with a new file creation diff (using /dev/null as source). Verify operation is "create".
    - Test with a file deletion diff (using /dev/null as target). Verify operation is "delete".
    - Test with a multi-file diff containing modifications to two or more files. Verify the JSON contains entries for each file.
    - Test with empty string input. Verify returns "[]".
    - Test with malformed/unparseable text. Verify returns "[]" (graceful failure).

    **validate_diff tests:**
    These tests need to run in an actual git repository (not in-memory). Use `tmp_path` pytest fixture to create a temporary git repo:
    - Create a temp directory, run `git init`, create a file, `git add`, `git commit`.
    - Test with a valid diff that modifies the committed file. Verify returns `(True, "")`.
    - Test with a diff referencing a non-existent file. Verify returns `(False, <error containing "No such file or directory">)`.
    - Test with a diff that has wrong context lines (mismatched content). Verify returns `(False, <error containing "patch does not apply">)`.

    Use `pytest.mark.asyncio` for async tests (via pytest-asyncio auto mode). Use realistic unified diff strings as test data -- construct them as multi-line Python strings with proper `---`, `+++`, `@@` headers.

    Note: validate_diff tests need `git` available on PATH and create real temp git repos. This is acceptable because git is always available in the development environment.
  </action>
  <verify>
    Run `uv run pytest tests/test_diff_utils.py -v` from tools/gsd-review-broker/. All tests pass. Run `uv run pytest` to confirm no regressions (all 44 existing tests + new tests pass).
  </verify>
  <done>
    test_diff_utils.py has at least 8 tests covering extract_affected_files (modify, create, delete, multi-file, empty, malformed) and validate_diff (valid diff, missing file, bad context). All tests pass alongside existing 44 tests.
  </done>
</task>

</tasks>

<verification>
1. `uv run pytest` from tools/gsd-review-broker/ passes all tests (44 existing + new diff_utils tests)
2. `python -c "from gsd_review_broker.diff_utils import validate_diff, extract_affected_files"` succeeds
3. Database schema includes description, diff, affected_files columns (verify with in-memory db test)
4. Review model accepts description, diff, affected_files parameters
5. AppContext has repo_root field populated by broker_lifespan
</verification>

<success_criteria>
- unidiff dependency installed and importable
- db.py schema V2 with migrations handles both fresh and existing databases
- diff_utils.py has two working functions: validate_diff (async subprocess) and extract_affected_files (unidiff parser)
- models.py Review model includes new optional fields
- server.py/db.py discovers and caches repo_root at startup
- All tests pass (existing + new)
</success_criteria>

<output>
After completion, create `.planning/phases/02-proposal-and-diff-protocol/02-01-SUMMARY.md`
</output>
