---
phase: 01-core-broker-server
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tools/gsd-review-broker/pyproject.toml
  - tools/gsd-review-broker/uv.lock
  - tools/gsd-review-broker/.python-version
  - tools/gsd-review-broker/.gitattributes
  - tools/gsd-review-broker/src/gsd_review_broker/__init__.py
  - tools/gsd-review-broker/src/gsd_review_broker/server.py
  - tools/gsd-review-broker/src/gsd_review_broker/db.py
  - tools/gsd-review-broker/src/gsd_review_broker/models.py
  - tools/gsd-review-broker/src/gsd_review_broker/state_machine.py
  - tools/gsd-review-broker/src/gsd_review_broker/tools.py
  - tools/gsd-review-broker/tests/__init__.py
  - tools/gsd-review-broker/tests/conftest.py
autonomous: true

must_haves:
  truths:
    - "uv sync completes without errors and installs FastMCP + aiosqlite"
    - "Server starts on 127.0.0.1:8321 with streamable-http transport and shuts down cleanly"
    - "SQLite database is created at .planning/codex_review_broker.sqlite3 with WAL mode and reviews table on first startup"
    - "Server shuts down with WAL checkpoint (TRUNCATE) to release Windows file locks"
  artifacts:
    - path: "tools/gsd-review-broker/pyproject.toml"
      provides: "Package metadata, dependencies, tool config"
      contains: "fastmcp"
    - path: "tools/gsd-review-broker/src/gsd_review_broker/server.py"
      provides: "FastMCP app with lifespan and main() entry point"
      exports: ["mcp", "main"]
    - path: "tools/gsd-review-broker/src/gsd_review_broker/db.py"
      provides: "Database lifespan, schema DDL, AppContext dataclass"
      exports: ["broker_lifespan", "AppContext", "ensure_schema"]
    - path: "tools/gsd-review-broker/src/gsd_review_broker/models.py"
      provides: "Pydantic models for Review, AgentIdentity, ReviewStatus enum"
      exports: ["Review", "AgentIdentity", "ReviewStatus"]
    - path: "tools/gsd-review-broker/src/gsd_review_broker/state_machine.py"
      provides: "State transition table and validation function"
      exports: ["VALID_TRANSITIONS", "validate_transition"]
    - path: "tools/gsd-review-broker/tests/conftest.py"
      provides: "In-memory SQLite fixture for tests"
      contains: "aiosqlite.connect"
  key_links:
    - from: "tools/gsd-review-broker/src/gsd_review_broker/server.py"
      to: "tools/gsd-review-broker/src/gsd_review_broker/db.py"
      via: "lifespan parameter on FastMCP constructor"
      pattern: "lifespan=broker_lifespan"
    - from: "tools/gsd-review-broker/src/gsd_review_broker/db.py"
      to: "SQLite database"
      via: "aiosqlite.connect with isolation_level=None"
      pattern: "isolation_level=None"
---

<objective>
Scaffold the gsd-review-broker Python project and establish a running FastMCP server with lifespan-managed SQLite connection.

Purpose: This is the foundation that all other Phase 1 plans build on. Without a working server, database, and module structure, no tools can be implemented.
Output: A fully installable Python package that starts a FastMCP server on 127.0.0.1:8321, creates/migrates the SQLite database with WAL mode, and shuts down cleanly. All module files exist with proper imports. Test infrastructure ready.
</objective>

<execution_context>
@C:\Users\Jacar\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Jacar\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-broker-server/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Python project structure with uv and install dependencies</name>
  <files>
    tools/gsd-review-broker/pyproject.toml
    tools/gsd-review-broker/uv.lock
    tools/gsd-review-broker/.python-version
    tools/gsd-review-broker/.gitattributes
    tools/gsd-review-broker/src/gsd_review_broker/__init__.py
    tools/gsd-review-broker/tests/__init__.py
  </files>
  <action>
    Create the `tools/gsd-review-broker/` directory structure following the research-recommended layout.

    1. Create `pyproject.toml` with:
       - name: "gsd-review-broker", version: "0.1.0"
       - requires-python: ">=3.12"
       - dependencies: ["fastmcp>=2.14,<3", "aiosqlite>=0.22,<1"]
       - optional-dependencies.dev: ["pytest>=8.0", "pytest-asyncio>=0.24", "ruff>=0.15"]
       - project.scripts: gsd-review-broker = "gsd_review_broker.server:main"
       - tool.ruff: target-version = "py312", line-length = 100, select = ["E", "F", "I", "UP", "B", "SIM"]
       - tool.pytest.ini_options: asyncio_mode = "auto", testpaths = ["tests"]

    2. Create `.python-version` containing "3.13"

    3. Create `.gitattributes` containing "* text=auto" (FOUND-04: cross-platform line endings)

    4. Create `src/gsd_review_broker/__init__.py` with just a docstring and __version__ = "0.1.0"

    5. Create `tests/__init__.py` as empty file

    6. Run `uv sync --all-extras` from within `tools/gsd-review-broker/` to install all dependencies and generate `uv.lock`. If uv is not installed, install it first with `pip install uv` or the platform-appropriate installer.

    IMPORTANT: Use `uv` (not pip) for all package management. The `uv.lock` file must be committed to git.
  </action>
  <verify>
    Run from `tools/gsd-review-broker/`:
    - `uv sync --all-extras` exits 0
    - `uv run python -c "import fastmcp; print(fastmcp.__version__)"` prints a version
    - `uv run python -c "import aiosqlite; print(aiosqlite.__version__)"` prints a version
    - `uv run python -c "import gsd_review_broker; print(gsd_review_broker.__version__)"` prints "0.1.0"
  </verify>
  <done>Python project scaffolded, all dependencies installed, uv.lock generated, package importable.</done>
</task>

<task type="auto">
  <name>Task 2: Implement database layer, models, state machine, server entry point, and test fixtures</name>
  <files>
    tools/gsd-review-broker/src/gsd_review_broker/db.py
    tools/gsd-review-broker/src/gsd_review_broker/models.py
    tools/gsd-review-broker/src/gsd_review_broker/state_machine.py
    tools/gsd-review-broker/src/gsd_review_broker/server.py
    tools/gsd-review-broker/src/gsd_review_broker/tools.py
    tools/gsd-review-broker/tests/conftest.py
  </files>
  <action>
    Implement the core modules following research patterns exactly.

    1. **models.py** -- Pydantic models and enums:
       - `ReviewStatus(StrEnum)` with values: pending, claimed, in_review, approved, changes_requested, closed (per PROTO-01)
       - `AgentIdentity(BaseModel)` with fields: agent_type (str), agent_role (str), phase (str), plan (str | None), task (str | None)
       - `Review(BaseModel)` with fields: id (str, default uuid4), status (ReviewStatus, default PENDING), intent (str), agent_type (str), agent_role (str), phase (str), plan (str | None), task (str | None), claimed_by (str | None), verdict_reason (str | None), parent_id (str | None), created_at (str | None), updated_at (str | None)

    2. **state_machine.py** -- Transition table and validator:
       - `VALID_TRANSITIONS: dict[ReviewStatus, set[ReviewStatus]]` matching the research Pattern 4 exactly
       - `validate_transition(current: ReviewStatus, target: ReviewStatus) -> None` that raises ValueError on invalid transitions
       - Import ReviewStatus from models.py

    3. **db.py** -- Database connection and schema:
       - `AppContext` dataclass with single field `db: aiosqlite.Connection`
       - `ensure_schema(db)` async function that runs CREATE TABLE IF NOT EXISTS for the reviews table with all columns and indexes from the research schema
       - `broker_lifespan(server: FastMCP)` async context manager that:
         a. Resolves DB_PATH as `Path(".planning") / "codex_review_broker.sqlite3"` (using pathlib for FOUND-04)
         b. Creates parent directory with `mkdir(parents=True, exist_ok=True)`
         c. Opens aiosqlite connection with `isolation_level=None` (CRITICAL for BEGIN IMMEDIATE -- see research Pitfall 1)
         d. Sets `row_factory = aiosqlite.Row`
         e. Executes PRAGMAs: `journal_mode=WAL`, `busy_timeout=5000`, `synchronous=NORMAL`, `foreign_keys=ON`
         f. Calls `ensure_schema(db)`
         g. Yields `AppContext(db=db)`
         h. In finally block: runs `PRAGMA wal_checkpoint(TRUNCATE)` then `db.close()` (FOUND-04: Windows file locking)

    4. **server.py** -- FastMCP application:
       - Import `broker_lifespan` from db.py
       - Create `mcp = FastMCP("gsd-review-broker", instructions="Review broker for GSD tandem pairing. Manages review lifecycle between proposer and reviewer.", lifespan=broker_lifespan)`
       - Import tools module to register tool handlers: `from gsd_review_broker import tools  # noqa: F401, E402` (this import MUST come AFTER mcp is created)
       - `main()` function that calls `mcp.run(transport="streamable-http", host="127.0.0.1", port=8321)`
       - `if __name__ == "__main__": main()` guard

    5. **tools.py** -- Empty placeholder with server import:
       - Import `mcp` from `gsd_review_broker.server`
       - Import `Context` from `fastmcp`
       - Import `AppContext` from `gsd_review_broker.db`
       - Add a comment: "# Tool definitions added in Plan 01-02"
       - This file exists so server.py's import of tools doesn't fail

    6. **tests/conftest.py** -- Test fixtures:
       - `db` fixture: async, creates in-memory aiosqlite connection with `isolation_level=None`, sets `row_factory=aiosqlite.Row`, runs `PRAGMA foreign_keys=ON`, calls `ensure_schema(conn)`, yields conn, closes in teardown
       - Import `ensure_schema` from `gsd_review_broker.db`

    CRITICAL WARNINGS from research:
    - `isolation_level=None` is NON-NEGOTIABLE on the aiosqlite connection. Without it, Python auto-issues BEGIN DEFERRED which deadlocks under concurrent access.
    - The tools.py import in server.py MUST be after mcp is defined (circular import otherwise).
    - Use `transport="streamable-http"` (not "http") to be explicit per research recommendation.
    - Host MUST be "127.0.0.1" programmatically (not via CLI flag -- research Pitfall 3).
  </action>
  <verify>
    Run from `tools/gsd-review-broker/`:
    - `uv run python -c "from gsd_review_broker.models import ReviewStatus, Review, AgentIdentity; print(list(ReviewStatus))"` prints all 6 states
    - `uv run python -c "from gsd_review_broker.state_machine import validate_transition; from gsd_review_broker.models import ReviewStatus; validate_transition(ReviewStatus.PENDING, ReviewStatus.CLAIMED); print('OK')"` prints OK
    - `uv run python -c "from gsd_review_broker.state_machine import validate_transition; from gsd_review_broker.models import ReviewStatus; validate_transition(ReviewStatus.PENDING, ReviewStatus.APPROVED)"` raises ValueError
    - `uv run python -c "from gsd_review_broker.db import broker_lifespan, AppContext; print('OK')"` prints OK
    - `uv run python -c "import socket, subprocess, sys, time; p=subprocess.Popen([sys.executable, '-m', 'gsd_review_broker.server']); time.sleep(3); socket.create_connection(('127.0.0.1', 8321), timeout=2).close(); p.terminate(); p.wait(timeout=5); print('OK')"` prints OK (proves non-interactive startup + bind on 127.0.0.1:8321)
    - `uv run python -c "import pathlib, sqlite3; db_path = pathlib.Path('.planning/codex_review_broker.sqlite3'); assert db_path.exists(), db_path; conn = sqlite3.connect(db_path); row = conn.execute(\"SELECT name FROM sqlite_master WHERE type='table' AND name='reviews'\").fetchone(); conn.close(); print('OK' if row else 'MISSING'); raise SystemExit(0 if row else 1)"` prints OK (proves DB exists and `reviews` table exists)
    - `uv run pytest tests/ -v --co` (collect only) confirms test infrastructure loads without import errors
  </verify>
  <done>
    All 6 module files implemented. Server starts on 127.0.0.1:8321 with streamable-http transport. SQLite database created with WAL mode and reviews table. State machine validates transitions correctly. Test fixtures load. Server shuts down cleanly with WAL checkpoint.
  </done>
</task>

</tasks>

<verification>
1. `uv sync --all-extras` in `tools/gsd-review-broker/` succeeds
2. `uv run python -c "import socket, subprocess, sys, time; p=subprocess.Popen([sys.executable, '-m', 'gsd_review_broker.server']); time.sleep(3); socket.create_connection(('127.0.0.1', 8321), timeout=2).close(); p.terminate(); p.wait(timeout=5); print('OK')"` proves server starts, binds, and can be stopped non-interactively
3. `uv run python -c "import pathlib, sqlite3; db_path = pathlib.Path('.planning/codex_review_broker.sqlite3'); assert db_path.exists(), db_path; conn = sqlite3.connect(db_path); row = conn.execute(\"SELECT name FROM sqlite_master WHERE type='table' AND name='reviews'\").fetchone(); conn.close(); print('OK' if row else 'MISSING'); raise SystemExit(0 if row else 1)"` proves DB file and `reviews` table existence
4. `uv run python -c "import pathlib, sqlite3; conn = sqlite3.connect(pathlib.Path('.planning/codex_review_broker.sqlite3')); mode = conn.execute('PRAGMA journal_mode').fetchone()[0]; conn.close(); print(mode); raise SystemExit(0 if str(mode).lower() == 'wal' else 1)"` proves WAL mode is enabled
5. All imports work: models, state_machine, db, server, tools
6. Test collection succeeds with `uv run pytest --co`
</verification>

<success_criteria>
- FastMCP server starts and binds to 127.0.0.1:8321 with streamable-http transport
- SQLite database at .planning/codex_review_broker.sqlite3 has WAL mode enabled and reviews table with all columns
- ReviewStatus enum has 6 states matching PROTO-01
- validate_transition accepts valid transitions and rejects invalid ones
- uv.lock committed, all dependencies installable from scratch
- Test infrastructure ready (conftest.py with in-memory DB fixture)
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-broker-server/01-01-SUMMARY.md`
</output>
