---
phase: 01-core-broker-server
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - tools/gsd-review-broker/src/gsd_review_broker/tools.py
  - tools/gsd-review-broker/tests/test_tools.py
  - tools/gsd-review-broker/tests/test_polling.py
  - .mcp.json
autonomous: false

must_haves:
  truths:
    - "Proposer can poll for review status via get_review_status tool and it returns within 1 second"
    - "get_review_status returns current status, intent, claimed_by, verdict_reason, and updated_at"
    - "Agent identity (agent_type, agent_role, phase, plan, task) is stored with every review and retrievable"
    - "Server starts and accepts MCP tool calls from Claude Code via .mcp.json configuration"
    - "Full lifecycle works through actual MCP client connection (not just direct function calls)"
  artifacts:
    - path: "tools/gsd-review-broker/src/gsd_review_broker/tools.py"
      provides: "6 MCP tools including get_review_status for polling"
      contains: "get_review_status"
    - path: "tools/gsd-review-broker/tests/test_polling.py"
      provides: "Tests for poll-and-return behavior and agent identity round-tripping"
      min_lines: 40
    - path: ".mcp.json"
      provides: "MCP server configuration for Claude Code to connect to broker"
      contains: "gsdreview"
  key_links:
    - from: "tools/gsd-review-broker/src/gsd_review_broker/tools.py"
      to: "SQLite reviews table"
      via: "get_review_status reads review row and returns immediately"
      pattern: "get_review_status"
    - from: ".mcp.json"
      to: "tools/gsd-review-broker/src/gsd_review_broker/server.py"
      via: "HTTP connection to 127.0.0.1:8321/mcp"
      pattern: "127\\.0\\.0\\.1:8321"
---

<objective>
Add the get_review_status polling tool, configure .mcp.json for Claude Code connectivity, and validate the complete system end-to-end with a live MCP server.

Purpose: This completes Phase 1 by adding the poll-and-return tool (INTER-02), ensuring agent identity round-trips correctly (INTER-01), and proving the server works with an actual MCP client -- not just unit tests. The human verification checkpoint confirms the broker works in the real Claude Code environment.
Output: 6th MCP tool (get_review_status), .mcp.json configuration, polling tests, and verified end-to-end connectivity.
</objective>

<execution_context>
@C:\Users\Jacar\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Jacar\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-broker-server/01-RESEARCH.md
@.planning/phases/01-core-broker-server/01-01-SUMMARY.md
@.planning/phases/01-core-broker-server/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement get_review_status tool, .mcp.json config, and polling tests</name>
  <files>
    tools/gsd-review-broker/src/gsd_review_broker/tools.py
    tools/gsd-review-broker/tests/test_polling.py
    .mcp.json
  </files>
  <action>
    1. **Add get_review_status tool to tools.py:**
       - Parameters: review_id (str), ctx: Context = None
       - SELECT review row by id (id, status, intent, agent_type, agent_role, phase, plan, task, claimed_by, verdict_reason, updated_at)
       - If not found, return {"error": f"Review {review_id} not found"}
       - Return dict with all fields listed above
       - Docstring: "Check the current status of a review. Call repeatedly to poll for changes. Returns immediately -- does NOT block waiting for reviewer action. Recommended polling interval: 3 seconds."
       - This tool does NO writes, NO transactions, just a single SELECT -- should return in <10ms on localhost
       - This is the INTER-02 poll-and-return implementation

    2. **Create .mcp.json at project root:**
       ```json
       {
         "mcpServers": {
           "gsdreview": {
             "type": "http",
             "url": "http://127.0.0.1:8321/mcp"
           }
         }
       }
       ```
       This configures Claude Code to connect to the broker as an MCP server. Tool names will appear as mcp__gsdreview__create_review, etc.

    3. **Create tests/test_polling.py:**
       - Use the same MockContext pattern from test_tools.py (or import it if extracted to conftest)
       - `test_get_review_status_returns_all_fields`: Create a review with full agent identity (agent_type="gsd-executor", agent_role="proposer", phase="1", plan="01-01", task="2"). Call get_review_status. Verify all agent identity fields are returned correctly (INTER-01 round-trip).
       - `test_get_review_status_not_found`: Call get_review_status with nonexistent ID, verify {"error": "..."} returned
       - `test_get_review_status_reflects_transitions`: Create review, get_status (pending). Claim it, get_status (claimed). Submit verdict, get_status (approved). Verify status changes are visible to polling.
       - `test_get_review_status_includes_verdict_reason`: Create, claim, submit_verdict with reason="LGTM, clean implementation". Get status. Verify verdict_reason field is "LGTM, clean implementation".
       - `test_agent_identity_persisted`: Create review with plan=None, task=None. Get status. Verify plan and task are None (not empty string or missing).

    4. **Update existing tests if needed:**
       - If the MockContext helper was defined inline in test_tools.py, extract it to conftest.py so test_polling.py can reuse it
       - Run full test suite to ensure no regressions

    IMPORTANT: get_review_status is a READ-ONLY tool. No BEGIN IMMEDIATE needed. Just a SELECT query. This is intentional -- polling should be as lightweight as possible per research Pattern 5.
  </action>
  <verify>
    Run from `tools/gsd-review-broker/`:
    - `uv run pytest tests/test_polling.py -v` -- all polling tests pass
    - `uv run pytest tests/ -v` -- full suite still passes (no regressions)
    - `uv run ruff check src/ tests/` -- clean
    - Verify `.mcp.json` exists at project root with correct content
    - Start server: `uv run gsd-review-broker` -- confirm 6 tools are registered (check startup logs)
  </verify>
  <done>
    get_review_status tool implemented and tested. .mcp.json configured. Agent identity round-trips correctly through create -> get_status. All polling tests pass. Full test suite green.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify live MCP connectivity</name>
  <what-built>
    Complete Phase 1 broker: FastMCP server with 6 MCP tools (create_review, list_reviews, claim_review, submit_verdict, get_review_status, close_review), SQLite persistence with WAL mode, state machine enforcement, poll-and-return pattern, and .mcp.json configuration.
  </what-built>
  <how-to-verify>
    1. Start the broker server in a terminal:
       ```
       cd tools/gsd-review-broker
       uv run gsd-review-broker
       ```
       Expected: Server starts, shows "Uvicorn running on http://127.0.0.1:8321"

    2. In a NEW Claude Code session (with the project open), verify the MCP server appears:
       - Check that .mcp.json is picked up
       - The tools should appear as mcp__gsdreview__create_review, etc.
       - If tools don't appear, try restarting Claude Code or running `claude mcp list`

    3. Test the full lifecycle by asking Claude Code to use the tools:
       - Call create_review with intent="Test review", agent_type="test", agent_role="proposer", phase="1"
       - Note the review_id returned
       - Call list_reviews with status="pending" -- should show the review
       - Call claim_review with the review_id and reviewer_id="human-tester"
       - Call submit_verdict with review_id, verdict="approved", reason="Looks good"
       - Call get_review_status with review_id -- should show status="approved"
       - Call close_review with review_id -- should show status="closed"

    4. Stop the broker (Ctrl+C), restart it, then call list_reviews -- the closed review should still be there (persistence test).

    5. Verify cross-platform: If on Windows, confirm no file lock errors on restart. If on macOS/Linux, this is less of a concern but still verify clean restart.
  </how-to-verify>
  <resume-signal>Type "approved" if the full lifecycle works through Claude Code MCP tools. If issues found, describe what failed and the error messages.</resume-signal>
</task>

</tasks>

<verification>
1. 6 MCP tools registered on server (create_review, list_reviews, claim_review, submit_verdict, get_review_status, close_review)
2. get_review_status returns immediately (<1s) with full review state including agent identity
3. .mcp.json at project root configures Claude Code to connect to broker
4. Full lifecycle works through actual MCP client: create -> list -> claim -> verdict -> status -> close
5. Data persists across server restart
6. All tests pass: `uv run pytest tests/ -v`
7. No cross-platform issues (Windows file locking, path separators)
</verification>

<success_criteria>
- Phase 1 Success Criterion 1: FastMCP server starts on 127.0.0.1 and accepts connections from MCP clients
- Phase 1 Success Criterion 2: Proposer can create a review with agent identity and receive a review_id back
- Phase 1 Success Criterion 3: Reviewer can list pending reviews and claim one, transitioning through the state machine
- Phase 1 Success Criterion 4: Proposer can poll for review status without exceeding MCP tool timeout (returns within 30 seconds per call)
- Phase 1 Success Criterion 5: All review data persists in SQLite at .planning/codex_review_broker.sqlite3 and survives server restart
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-broker-server/01-03-SUMMARY.md`
</output>
