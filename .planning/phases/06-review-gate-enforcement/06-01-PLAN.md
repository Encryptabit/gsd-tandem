---
phase: 06-review-gate-enforcement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tools/gsd-review-broker/src/gsd_review_broker/db.py
  - tools/gsd-review-broker/src/gsd_review_broker/tools.py
  - tools/gsd-review-broker/tests/test_skip_validation.py
  - agents/gsd-executor.md
  - get-shit-done/workflows/execute-phase.md
  - CLAUDE.md
autonomous: true

must_haves:
  truths:
    - "create_review accepts skip_diff_validation=True to store diffs without running git apply --check"
    - "skip_diff_validation flag is persisted on the reviews table and respected by claim_review (no auto-rejection for pre-validated reviews)"
    - "Executor subagent no longer calls mcp__gsdreview__* directly; frontmatter tools list excludes broker tools"
    - "execute-phase workflow submits post-plan diffs to the broker and waits for verdict before proceeding"
    - "Wave parallelism is disabled when tandem_enabled=true to ensure clean per-plan diffs"
    - "CLAUDE.md documents the tandem review requirement when tandem_enabled=true"
  artifacts:
    - path: "tools/gsd-review-broker/src/gsd_review_broker/db.py"
      provides: "skip_diff_validation column migration on reviews table"
      contains: "skip_diff_validation"
    - path: "tools/gsd-review-broker/src/gsd_review_broker/tools.py"
      provides: "skip_diff_validation parameter on create_review, claim_review respects persisted flag"
      contains: "skip_diff_validation"
    - path: "tools/gsd-review-broker/tests/test_skip_validation.py"
      provides: "Tests for skip_diff_validation on both create and claim paths"
      contains: "skip_diff_validation"
    - path: "agents/gsd-executor.md"
      provides: "Executor without broker tool access or tandem sections"
    - path: "get-shit-done/workflows/execute-phase.md"
      provides: "Orchestrator review gate with tandem config loading and per-plan review submission"
      contains: "mcp__gsdreview"
  key_links:
    - from: "agents/gsd-executor.md (task results)"
      to: "get-shit-done/workflows/execute-phase.md (orchestrator review gate)"
      via: "Task() return value — orchestrator captures git diff per plan"
    - from: "get-shit-done/workflows/execute-phase.md (orchestrator)"
      to: "tools.py (create_review with skip_diff_validation)"
      via: "mcp__gsdreview__create_review"
    - from: "db.py (skip_diff_validation column)"
      to: "tools.py (claim_review bypass)"
      via: "SELECT skip_diff_validation FROM reviews WHERE id = ?"
---

# Plan 06-01: Review Gate Enforcement

## Goal
Make the review broker a proper gate for all code changes. Currently, tandem review sections in the executor are dead code because Task() subagents lack MCP tool access. Fix the architecture so the orchestrator handles all broker interaction on behalf of subagents, and diffs are submitted post-commit with validation skipped (since they're already applied).

## Context

### Problem
The executor agent (`agents/gsd-executor.md`) has `<tandem_task_review>`, `<tandem_optimistic_mode>`, and `<tandem_plan_review_gate>` sections that call `mcp__gsdreview__*` tools directly. But executors run as Task() subagents which don't have MCP tool access. The tandem sections are dead code. The executor frontmatter also lists `mcp__gsdreview__*` in its `tools:` field.

Additionally, `git apply --check` validation fails for post-commit diffs because the changes are already in the working tree. This affects both `create_review` (submission) and `claim_review` (claim-time re-validation which auto-rejects).

### Architecture Decision
**Orchestrator-mediated review**: Only the orchestrator (execute-phase workflow) interacts with the broker. Subagents focus on execution and return results. The orchestrator submits diffs post-commit with `skip_diff_validation=true` and waits for reviewer verdict before proceeding.

**Wave parallelism disabled for tandem**: When `tandem_enabled=true`, plans within a wave execute sequentially (override `parallelization` to false). This ensures `git diff ${PLAN_START_REF}..HEAD` isolates exactly one plan's changes — no interleaving from parallel plans.

## Tasks

### Task 1: Persist skip_diff_validation and update create_review + claim_review
**Files**: `tools/gsd-review-broker/src/gsd_review_broker/db.py`, `tools/gsd-review-broker/src/gsd_review_broker/tools.py`

**db.py** — Add schema migration:
```python
"ALTER TABLE reviews ADD COLUMN skip_diff_validation INTEGER NOT NULL DEFAULT 0",
```

**tools.py — create_review**:
Add `skip_diff_validation: bool = False` parameter. When True:
- Skip the `validate_diff()` call on both new review and revision paths
- Still call `extract_affected_files()` (parsing file paths doesn't need git)
- Store `skip_diff_validation=1` on the review row (persist the flag)
- Store the diff as-is for reviewer inspection

Update docstring to explain when to use it (post-commit diffs, diffs already applied to working tree).

**tools.py — claim_review**:
Before the `validate_diff()` call inside the write lock (around current line 309), check the persisted flag:
```python
# Check if diff validation was skipped at submission (post-commit diffs)
skip_validation = bool(row["skip_diff_validation"]) if "skip_diff_validation" in row.keys() else False
```
Add `skip_diff_validation` to the SELECT query for claim_review. When the flag is True, skip the `validate_diff()` call entirely — do not auto-reject.

**Tests** (new file `tests/test_skip_validation.py`):
- `create_review` with `skip_diff_validation=True` stores diff without calling validate_diff
- `create_review` with `skip_diff_validation=True` still extracts affected_files
- `create_review` with `skip_diff_validation=False` (default) still validates (existing behavior)
- `claim_review` on a review with `skip_diff_validation=True` does NOT auto-reject even if diff wouldn't apply
- `claim_review` on a review with `skip_diff_validation=False` still validates (existing behavior)
- Revision with `skip_diff_validation=True` works on changes_requested review

### Task 2: Simplify executor agent — remove broker access
**File**: `agents/gsd-executor.md`

**Frontmatter**: Remove `mcp__gsdreview__*` from the `tools:` line:
```yaml
tools: Read, Write, Edit, Bash, Grep, Glob
```

Replace all tandem sections (`<tandem_config>`, `<tandem_task_review>`, `<tandem_optimistic_mode>`, `<tandem_plan_review_gate>`, `<tandem_error_handling>`) with a single note:

```
<tandem_config>
## Tandem Configuration

Executor subagents do NOT interact with the review broker directly.
All broker interaction is handled by the execute-phase orchestrator.

The executor's role:
1. Execute tasks normally (edit, test, commit)
2. Return task results including git diff to the orchestrator
3. The orchestrator submits the diff for review

No tandem configuration is read or applied by the executor.
</tandem_config>
```

Update the task flow (around line 71) to remove the tandem conditional that references the deleted sections.

### Task 3: Wire orchestrator review gate in execute-phase workflow
**File**: `get-shit-done/workflows/execute-phase.md` (the actual orchestration logic, NOT the thin command wrapper at `commands/gsd/execute-phase.md`)

**3a. Tandem config loading** — Add to `<step name="load_project_state">` after init JSON parsing:

```
TANDEM_ENABLED=$(parse tandem_enabled from .planning/config.json, default false)
```

When `TANDEM_ENABLED=true`, force `PARALLELIZATION=false` to ensure clean per-plan diffs. Log: "Tandem mode active — wave parallelism disabled for clean per-plan diffs."

**3b. Per-plan review gate** — Insert into `<step name="execute_waves">` after step 3 (wait for agents) and before step 4 (report completion), gated on `TANDEM_ENABLED=true`:

```
For each completed plan in the wave (sequentially, since parallelism is off):
  1. Record PLAN_START_REF before spawning the plan's executor (add this before step 2)
  2. After executor returns, capture diff: git diff ${PLAN_START_REF}..HEAD
  3. If diff is empty, skip review gate for this plan
  4. Submit to broker: mcp__gsdreview__create_review with:
     - intent: "Plan {plan_id}: {plan_objective}"
     - agent_type: "gsd-executor"
     - agent_role: "proposer"
     - phase, plan from current execution context
     - category: "code_change"
     - diff: the captured diff
     - skip_diff_validation: true
  5. Long-poll for verdict: mcp__gsdreview__get_review_status(review_id=ID, wait=true)
     - approved: mcp__gsdreview__close_review(review_id=ID), proceed
     - changes_requested: Read verdict_reason, log feedback, hard-reset to
       clean state (git reset --hard ${PLAN_START_REF}) to discard all rejected
       commits and staged/unstaged changes — this is safe because the work was
       rejected and the executor will redo it from scratch with feedback.
       Re-spawn executor with verdict_reason appended to its prompt.
  6. On broker connection failure on first call: warn and set TANDEM_ENABLED=false
     for remainder of execution (solo mode fallback)
```

**3c. Ensure mcp__gsdreview__* is in allowed-tools** for the execute-phase command wrapper (`commands/gsd/execute-phase.md`) — already present per the frontmatter.

### Task 4: Add CLAUDE.md tandem rule
**File**: `CLAUDE.md` (project root, create if needed)

Add a section:

```markdown
## Tandem Review

When `tandem_enabled=true` in `.planning/config.json` and the review broker is running:

All code changes should be submitted through the broker before committing.
The execute-phase orchestrator handles this automatically for planned work.

For ad-hoc changes (direct user requests outside GSD workflow):
1. Make changes with Edit/Write
2. Capture diff: `git diff HEAD`
3. Submit via `mcp__gsdreview__create_review` with `skip_diff_validation=true`
4. Wait for approval via `mcp__gsdreview__get_review_status(wait=true)`
5. On approval, commit. On rejection, address feedback and resubmit.
```

## Verification

After all tasks:
1. Run `uv run pytest -v` from `tools/gsd-review-broker/` — all tests pass including new skip_validation tests
2. Read the updated executor agent — no `mcp__gsdreview__*` in frontmatter or body
3. Read `get-shit-done/workflows/execute-phase.md` — review gate present after plan execution, gated on `tandem_enabled`, parallelism forced off
4. Read CLAUDE.md — tandem rule present
5. Verify claim_review respects the persisted skip_diff_validation flag (covered by tests)

## SUMMARY

(To be written after execution)
