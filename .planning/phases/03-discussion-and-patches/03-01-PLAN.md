---
phase: 03-discussion-and-patches
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tools/gsd-review-broker/src/gsd_review_broker/db.py
  - tools/gsd-review-broker/src/gsd_review_broker/models.py
  - tools/gsd-review-broker/src/gsd_review_broker/priority.py
  - tools/gsd-review-broker/src/gsd_review_broker/notifications.py
  - tools/gsd-review-broker/src/gsd_review_broker/tools.py
  - tools/gsd-review-broker/src/gsd_review_broker/server.py
  - tools/gsd-review-broker/tests/conftest.py
  - tools/gsd-review-broker/tests/test_messages.py
  - tools/gsd-review-broker/tests/test_priority.py
  - tools/gsd-review-broker/tests/test_notifications.py
autonomous: true

must_haves:
  truths:
    - "Messages form a flat chronological conversation per review with strict turn alternation"
    - "Each propose/revise cycle increments a round number tracked on the review"
    - "Proposer and reviewer can exchange messages only when review is in claimed or changes_requested state"
    - "Priority is inferred from agent identity: planner=critical, executor=normal, verification=low"
    - "NotificationBus signals review changes internally via asyncio.Event"
    - "Revision clears counter-patch columns and increments current_round"
  artifacts:
    - path: "tools/gsd-review-broker/src/gsd_review_broker/models.py"
      provides: "Priority and CounterPatchStatus enums"
      contains: "class Priority"
    - path: "tools/gsd-review-broker/src/gsd_review_broker/priority.py"
      provides: "Priority inference pure function"
      exports: ["infer_priority"]
    - path: "tools/gsd-review-broker/src/gsd_review_broker/notifications.py"
      provides: "Internal asyncio event bus"
      exports: ["NotificationBus"]
    - path: "tools/gsd-review-broker/src/gsd_review_broker/db.py"
      provides: "Messages table schema, Phase 3 migrations, updated AppContext"
      contains: "messages"
    - path: "tools/gsd-review-broker/src/gsd_review_broker/tools.py"
      provides: "add_message, get_discussion tools, modified create_review"
      contains: "add_message"
    - path: "tools/gsd-review-broker/tests/test_messages.py"
      provides: "Message threading and round tracking tests"
      min_lines: 80
    - path: "tools/gsd-review-broker/tests/test_priority.py"
      provides: "Priority inference tests"
      min_lines: 30
    - path: "tools/gsd-review-broker/tests/test_notifications.py"
      provides: "NotificationBus tests"
      min_lines: 30
  key_links:
    - from: "tools/gsd-review-broker/src/gsd_review_broker/tools.py"
      to: "notifications.py"
      via: "app.notifications.notify(review_id) after message insert and create_review"
      pattern: "notifications\\.notify"
    - from: "tools/gsd-review-broker/src/gsd_review_broker/tools.py"
      to: "priority.py"
      via: "infer_priority called in create_review new review flow"
      pattern: "infer_priority"
    - from: "tools/gsd-review-broker/src/gsd_review_broker/db.py"
      to: "notifications.py"
      via: "AppContext.notifications field"
      pattern: "notifications.*NotificationBus"
---

<objective>
Build the foundation for Phase 3 (schema, models, utility modules) and implement message threading with multi-round discussion support.

Purpose: Establishes the messages table, Priority/CounterPatchStatus enums, priority inference module, internal notification bus, and the two new message tools (add_message, get_discussion). Also modifies create_review to track rounds and fire notifications. This provides the messaging backbone that Plan 02 builds counter-patch and priority-sort features on top of.

Output: Updated schema with messages table and Phase 3 migrations, two new utility modules (priority.py, notifications.py), two new MCP tools (add_message, get_discussion), modified create_review with round tracking and notifications, and comprehensive tests.
</objective>

<execution_context>
@C:\Users\Jacar\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Jacar\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-discussion-and-patches/03-RESEARCH.md
@tools/gsd-review-broker/src/gsd_review_broker/db.py
@tools/gsd-review-broker/src/gsd_review_broker/models.py
@tools/gsd-review-broker/src/gsd_review_broker/tools.py
@tools/gsd-review-broker/src/gsd_review_broker/server.py
@tools/gsd-review-broker/src/gsd_review_broker/state_machine.py
@tools/gsd-review-broker/src/gsd_review_broker/diff_utils.py
@tools/gsd-review-broker/tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema, models, and utility modules</name>
  <files>
    tools/gsd-review-broker/src/gsd_review_broker/models.py
    tools/gsd-review-broker/src/gsd_review_broker/db.py
    tools/gsd-review-broker/src/gsd_review_broker/priority.py
    tools/gsd-review-broker/src/gsd_review_broker/notifications.py
    tools/gsd-review-broker/src/gsd_review_broker/server.py
    tools/gsd-review-broker/tests/conftest.py
    tools/gsd-review-broker/tests/test_priority.py
    tools/gsd-review-broker/tests/test_notifications.py
  </files>
  <action>
    **models.py** -- Add two new StrEnum classes after the existing ReviewStatus:
    1. `Priority(StrEnum)` with values: CRITICAL = "critical", NORMAL = "normal", LOW = "low"
    2. `CounterPatchStatus(StrEnum)` with values: PENDING = "pending", ACCEPTED = "accepted", REJECTED = "rejected"

    **db.py** -- Three changes:
    1. Add messages table to SCHEMA_SQL (after the reviews table):
       ```sql
       CREATE TABLE IF NOT EXISTS messages (
           id          TEXT PRIMARY KEY,
           review_id   TEXT NOT NULL REFERENCES reviews(id),
           sender_role TEXT NOT NULL CHECK(sender_role IN ('proposer', 'reviewer')),
           round       INTEGER NOT NULL DEFAULT 1,
           body        TEXT NOT NULL,
           metadata    TEXT,
           created_at  TEXT NOT NULL DEFAULT (datetime('now'))
       );
       CREATE INDEX IF NOT EXISTS idx_messages_review ON messages(review_id, round);
       ```
    2. Add Phase 3 migrations to SCHEMA_MIGRATIONS list (after the existing Phase 2 entries):
       ```python
       "ALTER TABLE reviews ADD COLUMN priority TEXT NOT NULL DEFAULT 'normal'",
       "ALTER TABLE reviews ADD COLUMN current_round INTEGER NOT NULL DEFAULT 1",
       "ALTER TABLE reviews ADD COLUMN counter_patch TEXT",
       "ALTER TABLE reviews ADD COLUMN counter_patch_affected_files TEXT",
       "ALTER TABLE reviews ADD COLUMN counter_patch_status TEXT",
       ```
    3. Update `AppContext` dataclass to include a `notifications` field:
       ```python
       from gsd_review_broker.notifications import NotificationBus
       # Add to AppContext:
       notifications: NotificationBus = field(default_factory=NotificationBus)
       ```

    **priority.py** -- New file. Create `infer_priority` pure function:
    - Import `Priority` from models
    - Function signature: `infer_priority(agent_type: str, agent_role: str, phase: str, plan: str | None = None, task: str | None = None) -> Priority`
    - Rules (per locked decisions): if "planner" in agent_type.lower() -> CRITICAL; if "verify" in phase.lower() -> LOW; otherwise -> NORMAL
    - Include module docstring and function docstring explaining the inference rules

    **notifications.py** -- New file. Create `NotificationBus` dataclass:
    - Uses `asyncio.Event` per review_id
    - `notify(review_id: str) -> None`: Set the event for that review_id (no-op if no waiter)
    - `async wait_for_change(review_id: str, timeout: float = 25.0) -> bool`: Wait on the event with timeout. Return True if signaled, False on timeout. Clear event after signal.
    - `cleanup(review_id: str) -> None`: Remove the event for a closed review
    - Follow the exact pattern from 03-RESEARCH.md code example

    **server.py** -- After the existing `from gsd_review_broker import tools` import, add: `from gsd_review_broker import priority  # noqa: F401, E402` (not strictly needed for registration since priority.py has no @mcp.tool, but ensures it's importable). Actually, skip this -- priority.py is imported by tools.py directly, no registration needed. No change to server.py needed.

    **conftest.py** -- Update the `ctx` fixture to include NotificationBus in AppContext:
    ```python
    from gsd_review_broker.notifications import NotificationBus
    # In ctx fixture:
    return MockContext(lifespan_context=AppContext(db=db, notifications=NotificationBus()))
    ```
    Since AppContext now has `notifications` with a default_factory, this may work automatically. But explicitly construct it for clarity.

    **test_priority.py** -- New file. Test the infer_priority function:
    - test_planner_is_critical: agent_type="gsd-planner" -> Priority.CRITICAL
    - test_executor_is_normal: agent_type="gsd-executor" -> Priority.NORMAL
    - test_verification_is_low: agent_type="gsd-verifier", phase="05-observability-and-validation" with "verify" in phase -> Priority.LOW
    - test_default_is_normal: unknown agent_type -> Priority.NORMAL
    - test_planner_takes_precedence: agent_type="gsd-planner", phase with "verify" -> Priority.CRITICAL (planner check first)
    - Use standard pytest-asyncio patterns (these are sync tests since infer_priority is sync)

    **test_notifications.py** -- New file. Test the NotificationBus:
    - test_notify_without_waiter: notify on a review_id with no waiter should not raise
    - test_wait_returns_true_on_signal: create a waiter task, notify from another coroutine, assert wait_for_change returns True
    - test_wait_returns_false_on_timeout: wait_for_change with timeout=0.1 with no signal -> returns False
    - test_cleanup_removes_event: after cleanup, the event dict is empty for that review_id
    - Use asyncio tasks for concurrent test scenarios
  </action>
  <verify>
    Run `uv run pytest tools/gsd-review-broker/tests/test_priority.py tools/gsd-review-broker/tests/test_notifications.py -v` -- all tests pass.
    Run `uv run python -c "from gsd_review_broker.models import Priority, CounterPatchStatus; print(Priority.CRITICAL, CounterPatchStatus.PENDING)"` -- prints "critical pending".
    Run `uv run python -c "from gsd_review_broker.db import AppContext; print(AppContext.__dataclass_fields__.keys())"` -- includes 'notifications'.
  </verify>
  <done>
    Priority enum, CounterPatchStatus enum, infer_priority function, and NotificationBus are implemented and tested. AppContext includes notifications field. Messages table and Phase 3 migrations are in the schema. All foundation tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Message threading tools and create_review round tracking</name>
  <files>
    tools/gsd-review-broker/src/gsd_review_broker/tools.py
  </files>
  <action>
    Add three new imports at top of tools.py:
    ```python
    from gsd_review_broker.notifications import NotificationBus
    from gsd_review_broker.priority import infer_priority
    from gsd_review_broker.models import Priority
    ```

    **add_message tool** -- New @mcp.tool. Follow the exact pattern from 03-RESEARCH.md code example:
    - Parameters: review_id (str), sender_role (str), body (str), metadata (str | None = None), ctx (Context = None)
    - Validate sender_role is "proposer" or "reviewer"
    - Inside write_lock + BEGIN IMMEDIATE:
      1. SELECT status, current_round FROM reviews WHERE id = ?
      2. Verify review exists, verify status is in ("claimed", "changes_requested") -- these are the states where back-and-forth messaging is meaningful
      3. Turn enforcement: SELECT sender_role FROM messages WHERE review_id = ? ORDER BY created_at DESC LIMIT 1. If last message has same sender_role, return error dict with "Turn violation" message. Allow either role to send first message (if no messages exist, any role can go first).
      4. INSERT into messages table with uuid4 id, review_id, sender_role, round from review's current_round, body, metadata
      5. COMMIT
    - After commit (outside write_lock): call app.notifications.notify(review_id)
    - Return: {"message_id": msg_id, "review_id": review_id, "round": current_round}

    **get_discussion tool** -- New @mcp.tool. Read-only (no write_lock, no transaction):
    - Parameters: review_id (str), round (int | None = None), ctx (Context = None)
    - Verify review exists (SELECT id FROM reviews WHERE id = ?)
    - If round is provided: SELECT id, sender_role, round, body, metadata, created_at FROM messages WHERE review_id = ? AND round = ? ORDER BY created_at ASC
    - If round is None: SELECT same columns WHERE review_id = ? ORDER BY created_at ASC
    - Parse metadata from JSON string to dict for each message (with try/except, fallback to raw string)
    - Return: {"review_id": review_id, "messages": [...], "count": len(messages)}

    **Modify create_review** -- Two changes:
    1. **New review flow**: After the INSERT, call `app.notifications.notify(new_review_id)` outside the write_lock (after COMMIT). Also add `priority` to the INSERT: compute via `infer_priority(agent_type, agent_role, phase, plan, task)` before entering write_lock. Add priority to the INSERT column list and values.
    2. **Revision flow**: Inside the UPDATE statement, add: `current_round = current_round + 1, counter_patch = NULL, counter_patch_affected_files = NULL, counter_patch_status = NULL`. After the write_lock block (after COMMIT), call `app.notifications.notify(review_id)`. The round increment and counter-patch clearing happen atomically in the same UPDATE.

    Note: The `priority` column should be included in both the INSERT (new review) and left unchanged on revision (don't overwrite -- priority is fixed at submission time per locked decision).
  </action>
  <verify>
    Run `uv run python -c "from gsd_review_broker.tools import add_message, get_discussion; print('tools loaded')"` -- prints "tools loaded" confirming no import errors.
    Run `uv run pytest tools/gsd-review-broker/tests/ -v --tb=short` -- existing tests still pass (no regressions from create_review changes).
  </verify>
  <done>
    add_message tool enforces turn alternation and inserts messages with round tracking. get_discussion retrieves messages with optional round filter. create_review infers priority on new reviews, increments current_round and clears counter-patch columns on revision, and fires notifications on both new and revised reviews. All existing tests continue to pass.
  </done>
</task>

<task type="auto">
  <name>Task 3: Message threading and round tracking tests</name>
  <files>
    tools/gsd-review-broker/tests/test_messages.py
  </files>
  <action>
    Create test_messages.py following the project's existing test patterns (pytest-asyncio, MockContext from conftest, .fn attribute to call tools).

    Create a module-level helper `_create_and_claim(ctx, **overrides)` that creates a review and claims it, returning the review_id. This avoids repeating setup in every test. Use default values: intent="test", agent_type="gsd-executor", agent_role="proposer", phase="01", reviewer_id="reviewer-1".

    **Test class: TestAddMessage**
    - test_alternating_messages: Create + claim review. Reviewer sends message, proposer responds. Both succeed with message_id in response.
    - test_consecutive_same_sender_rejected: After one reviewer message, second reviewer message returns error with "Turn violation".
    - test_either_role_can_start: First message from proposer succeeds (no prior messages).
    - test_message_includes_round: Message response includes "round" matching review's current_round (should be 1 for new review).
    - test_metadata_stored: Send message with metadata='{"file": "foo.py", "line": 42}'. Retrieve via get_discussion and verify metadata is parsed.
    - test_message_on_pending_review_rejected: Try to add message to a review that hasn't been claimed yet. Returns error about invalid state.
    - test_message_on_closed_review_rejected: Close a review, try to add message. Returns error.

    **Test class: TestGetDiscussion**
    - test_empty_discussion: New review with no messages returns empty list, count=0.
    - test_full_history: Add 3 alternating messages, get_discussion returns all 3 in order.
    - test_filter_by_round: Create review, add messages in round 1. Then simulate revision (call create_review with review_id to revise, which increments to round 2), re-claim, add messages in round 2. get_discussion(round=1) returns only round 1 messages. get_discussion(round=2) returns only round 2 messages.
    - test_review_not_found: get_discussion for nonexistent review_id returns error.

    **Test class: TestRoundTracking**
    - test_revision_increments_round: Create review (round=1), claim, submit verdict changes_requested, revise via create_review(review_id=...). Check that messages added after revision have round=2. Use get_discussion to verify.
    - test_revision_clears_counter_patch: Create review, claim, manually insert counter_patch columns in DB (or this can be tested in Plan 02). If not feasible without counter-patch tools, just test that current_round increments by reading from DB directly.

    **Test class: TestCreateReviewNotifications**
    - test_new_review_fires_notification: Create a NotificationBus, set up a waiter on a known review_id (but we don't know the ID in advance). Instead, test that after create_review, the bus was notified. Simpler approach: After create_review, check bus._events state, or use a different approach -- just verify the notification bus integration works by having a waiter task that resolves after create_review is called.
    - Actually, the simplest approach: pre-set an asyncio.Event waiter, call create_review, assert the event was set. But review_id is generated inside the tool. Alternative: test notification by adding a message (which also fires notify) -- after add_message, assert a concurrent wait_for_change returns True. Use asyncio.create_task for the waiter, call add_message, await the waiter.

    **Test class: TestCreateReviewPriority**
    - test_planner_gets_critical_priority: Create review with agent_type="gsd-planner". SELECT priority FROM reviews. Assert "critical".
    - test_executor_gets_normal_priority: Create review with agent_type="gsd-executor", phase="01". Assert "normal".
    - test_verification_gets_low_priority: Create review with agent_type="gsd-verifier", phase="05-verify". Assert "low".

    For the mock validate_diff pattern: Since create_review may call validate_diff when diff is provided, and tests use in-memory DB with no real git repo, either: (a) don't pass diffs in message tests, or (b) mock validate_diff as done in test_proposals.py. Option (a) is simpler -- omit diff param in message tests since messaging doesn't require a diff.

    Run all tests after writing to ensure they pass: `uv run pytest tools/gsd-review-broker/tests/test_messages.py -v`
  </action>
  <verify>
    Run `uv run pytest tools/gsd-review-broker/tests/test_messages.py -v` -- all tests pass.
    Run `uv run pytest tools/gsd-review-broker/tests/ -v` -- full test suite passes (no regressions).
  </verify>
  <done>
    Message threading is fully tested: turn alternation, round tracking, metadata, state validation, discussion retrieval with round filtering, revision round increment, priority inference on creation, and notification firing. All tests pass including existing test suite with zero regressions.
  </done>
</task>

</tasks>

<verification>
1. `uv run pytest tools/gsd-review-broker/tests/ -v` -- entire test suite passes
2. `uv run python -c "from gsd_review_broker.tools import add_message, get_discussion"` -- new tools importable
3. `uv run python -c "from gsd_review_broker.priority import infer_priority; from gsd_review_broker.models import Priority; assert infer_priority('gsd-planner','proposer','01') == Priority.CRITICAL"` -- priority inference works
4. `uv run python -c "from gsd_review_broker.notifications import NotificationBus; print('OK')"` -- notification bus importable
</verification>

<success_criteria>
- Messages table exists in schema with review_id, sender_role, round, body, metadata columns
- add_message enforces strict turn alternation (consecutive same-role messages rejected)
- get_discussion returns full history or filtered by round
- create_review auto-infers priority from agent identity (planner=critical, executor=normal, verification=low)
- create_review revision increments current_round, clears counter-patch columns
- create_review fires notification on both new and revised reviews
- add_message fires notification after inserting a message
- NotificationBus provides async wait_for_change with timeout
- All new tests pass, all existing tests pass with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/03-discussion-and-patches/03-01-SUMMARY.md`
</output>
