---
phase: 05-observability-and-validation
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - tools/gsd-review-broker/tests/test_activity_feed.py
  - tools/gsd-review-broker/tests/test_stats.py
  - tools/gsd-review-broker/tests/test_e2e_workflow.py
  - .planning/scripts/phase5_command_e2e_check.sh
  - .planning/phases/05-observability-and-validation/05-VERIFICATION.md
autonomous: false

must_haves:
  truths:
    - "Activity feed tests enforce deterministic ordering when updated_at timestamps tie"
    - "Stats tests cover counts, rates, timing metrics, and avg_time_in_state_seconds"
    - "Broker lifecycle tests still cover revision and counter-patch flows end-to-end"
    - "Command-level validation proves /gsd:plan-phase -> /gsd:execute-phase -> /gsd:verify-work are broker-mediated when tandem is enabled"
    - "A phase verification artifact captures command-level evidence with pass/fail status"
  artifacts:
    - path: "tools/gsd-review-broker/tests/test_activity_feed.py"
      provides: "Activity feed + audit log tests including deterministic order checks"
      min_lines: 100
    - path: "tools/gsd-review-broker/tests/test_stats.py"
      provides: "Stats + timeline tests including avg_time_in_state_seconds coverage"
      min_lines: 100
    - path: "tools/gsd-review-broker/tests/test_e2e_workflow.py"
      provides: "Broker lifecycle tests with observability assertions"
      min_lines: 120
    - path: ".planning/scripts/phase5_command_e2e_check.sh"
      provides: "Command-level evidence checker using SQLite queries"
      min_lines: 80
    - path: ".planning/phases/05-observability-and-validation/05-VERIFICATION.md"
      provides: "Recorded command-level validation evidence and verdict"
      min_lines: 60
  key_links:
    - from: "test_activity_feed.py"
      to: "tools.get_activity_feed"
      via: "assert ORDER BY updated_at DESC, id DESC behavior"
      pattern: "updated_at.*id"
    - from: "test_stats.py"
      to: "tools.get_review_stats"
      via: "assert avg_time_in_state_seconds shape and values"
      pattern: "avg_time_in_state_seconds"
    - from: "test_e2e_workflow.py"
      to: "broker lifecycle tools"
      via: "full create->claim->message->verdict->close + revision/counter-patch assertions"
      pattern: "create_review\\.fn\\(.*claim_review\\.fn\\("
    - from: "phase5_command_e2e_check.sh"
      to: ".planning/codex_review_broker.sqlite3"
      via: "sqlite3 aggregate checks for gsd-planner/gsd-executor/gsd-verifier activity"
      pattern: "SELECT.*FROM reviews"
---

<objective>
Deliver complete Phase 5 validation at two layers: (1) automated broker/tool tests for observability correctness, and (2) command-level workflow evidence proving the real GSD commands are broker-mediated end-to-end.

Purpose: Close the remaining gap between broker-level unit/integration confidence and roadmap-required command-level validation. This plan explicitly validates `/gsd:plan-phase`, `/gsd:execute-phase`, and `/gsd:verify-work` under tandem mode, then records evidence in a dedicated verification artifact.

Output: Updated test suite for observability tools, a reusable command-level evidence checker script, and `05-VERIFICATION.md` documenting whether command-level mediation passed.
</objective>

<execution_context>
@C:\Users\Jacar\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Jacar\.claude/get-shit-done/references/checkpoints.md
@C:\Users\Jacar\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-observability-and-validation/05-CONTEXT.md
@.planning/phases/05-observability-and-validation/05-RESEARCH.md
@.planning/phases/05-observability-and-validation/05-01-SUMMARY.md
@.planning/config.json
@commands/gsd/plan-phase.md
@commands/gsd/execute-phase.md
@commands/gsd/verify-work.md
@agents/gsd-planner.md
@agents/gsd-executor.md
@get-shit-done/workflows/verify-work.md
@tools/gsd-review-broker/src/gsd_review_broker/tools.py
@tools/gsd-review-broker/tests/conftest.py
@tools/gsd-review-broker/tests/test_proposals.py
@tools/gsd-review-broker/tests/test_messages.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand automated observability coverage and add command-evidence checker scaffold</name>
  <files>
    tools/gsd-review-broker/tests/test_activity_feed.py
    tools/gsd-review-broker/tests/test_stats.py
    tools/gsd-review-broker/tests/test_e2e_workflow.py
    .planning/scripts/phase5_command_e2e_check.sh
    .planning/phases/05-observability-and-validation/05-VERIFICATION.md
  </files>
  <action>
    Create/extend test coverage for all observability tools and add the command-level evidence checker scaffold.

    **test_activity_feed.py**:
    1. Cover empty state, status/category filters, combined filters, message preview truncation, and ISO 8601 fields.
    2. Add deterministic ordering test for ties: when two reviews have identical updated_at, feed ordering is stable by id DESC.
    3. Keep audit-log tests for per-review/all-events retrieval, nonexistent review error handling, and event ordering.

    **test_stats.py**:
    4. Cover empty-database behavior for all fields including `avg_time_in_state_seconds`.
    5. Validate status/category counts, approval rate, avg_time_to_verdict_seconds, avg_review_duration_seconds.
    6. Add assertions for `avg_time_in_state_seconds` object keys (`pending`, `claimed`, `approved`, `changes_requested`) and numeric/null semantics.

    **test_e2e_workflow.py**:
    7. Preserve lifecycle broker tests (happy path, revision cycle, counter-patch flow, multi-category data).
    8. Assert observability outputs after each lifecycle step (feed/status, timeline sequence, audit log ordering, stats consistency).

    **.planning/scripts/phase5_command_e2e_check.sh** (NEW):
    9. Create a bash script that reads `.planning/codex_review_broker.sqlite3` and fails fast if command-level evidence is missing.
    10. Checks must include at minimum:
        - at least one review with `agent_type='gsd-planner'` and `category='plan_review'`
        - at least one review with `agent_type='gsd-executor'` and `category='code_change'`
        - at least one review with `agent_type='gsd-verifier'` and `category='verification'`
        - audit_events exist for those reviews
    11. Script supports `--db <path>` override and prints concise PASS/FAIL summary.

    **05-VERIFICATION.md** (NEW scaffold):
    12. Create a template report with sections for command run metadata, evidence table, checker output, and final verdict.
    13. Leave placeholders clearly marked for Task 3 completion.
  </action>
  <verify>
    Run: `cd tools/gsd-review-broker && uv run pytest tests/test_activity_feed.py tests/test_stats.py tests/test_e2e_workflow.py -v`
    Run: `bash .planning/scripts/phase5_command_e2e_check.sh --db .planning/codex_review_broker.sqlite3 || true`
    (Second command may fail before command-level run exists; failure at this stage is expected and should print missing-evidence checks.)
  </verify>
  <done>
    Automated observability tests exist and pass. Command-evidence checker script and verification report scaffold exist with concrete structure ready for command-level evidence capture.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Human-run command-level tandem workflow</name>
  <files>
    .planning/config.json
    .planning/codex_review_broker.sqlite3
  </files>
  <action>Run command-level tandem workflow in a separate Claude Code session</action>
  <instructions>
    I prepared automated tests, an evidence checker script, and a verification report scaffold.

    In a separate Claude Code session, run this exact command-level flow with tandem enabled.
    Recommended: use a scratch clone/worktree to avoid recursive execution against the active Phase 5 branch.

    1. Create or choose a scratch workspace (example):
       - `git worktree add ../gsd-tandem-phase5-e2e HEAD`
       - `cd ../gsd-tandem-phase5-e2e`
    2. Set `.planning/config.json` to:
       - `"tandem_enabled": true`
       - `"review_granularity": "per_task"`
       - `"execution_mode": "blocking"`
    3. Start broker server in another terminal from that same scratch workspace:
       - `cd tools/gsd-review-broker && uv run gsd-review-broker`
    4. Execute commands in sequence:
       - `/gsd:plan-phase 5 --skip-research --skip-verify`
       - `/gsd:execute-phase 5`
       - `/gsd:verify-work 5`
    5. Complete the verify-work interaction until the phase verification session is committed.
    6. Stop the broker server.
    7. Capture the broker DB path used for this run (for example `../gsd-tandem-phase5-e2e/.planning/codex_review_broker.sqlite3`).
  </instructions>
  <verification>
    After you return, Claude will run:
    `bash .planning/scripts/phase5_command_e2e_check.sh --db <PATH_FROM_YOUR_RUN>`
    Success requires PASS for planner/executor/verifier evidence checks.
  </verification>
  <verify>
    `bash .planning/scripts/phase5_command_e2e_check.sh --db <PATH_FROM_YOUR_RUN>`
  </verify>
  <done>
    Human completed the command-level run and returned a resume signal.
  </done>
  <resume-signal>Type `done db=/absolute/or/relative/path/to/codex_review_broker.sqlite3` after completion, or paste blockers/errors if it fails.</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Capture command-level evidence and finalize Phase 5 verification report</name>
  <files>
    .planning/phases/05-observability-and-validation/05-VERIFICATION.md
  </files>
  <action>
    After checkpoint completion, run the evidence checker and finalize `05-VERIFICATION.md`.

    1. Read DB path from the checkpoint resume signal (`db=...`). If absent, default to `.planning/codex_review_broker.sqlite3`.
    2. Execute checker script and capture exact PASS/FAIL output.
    3. Query SQLite (or use checker output) to record concrete evidence rows for planner/executor/verifier reviews and key audit event counts.
    4. Fill the report template with:
       - command run timestamp
       - config values used
       - DB path used
       - evidence table (agent_type, category, review_count, sample_review_id)
       - checker output snippet
       - final verdict: PASS/FAIL for roadmap criterion "plan-phase -> execute-phase -> verify-work is broker-mediated"
    5. If any check fails, mark report FAIL and list exact remediation steps (do not silently pass).
  </action>
  <verify>
    Run: `bash .planning/scripts/phase5_command_e2e_check.sh --db <DB_PATH_FROM_CHECKPOINT_OR_DEFAULT>`
    Run: `cd tools/gsd-review-broker && uv run pytest -v`
  </verify>
  <done>
    `05-VERIFICATION.md` contains concrete command-level evidence and an explicit pass/fail verdict. Checker script passes and broker test suite is green.
  </done>
</task>

</tasks>

<verification>
1. `cd tools/gsd-review-broker && uv run pytest tests/test_activity_feed.py tests/test_stats.py tests/test_e2e_workflow.py -v`
2. `bash .planning/scripts/phase5_command_e2e_check.sh --db <DB_PATH_FROM_CHECKPOINT>`
3. `cd tools/gsd-review-broker && uv run pytest -v`
4. Verify `.planning/phases/05-observability-and-validation/05-VERIFICATION.md` has a non-placeholder final verdict and evidence table
</verification>

<success_criteria>
- Activity feed tests validate deterministic ordering, filters, previews, and ISO timestamps
- Stats tests validate counts/rates/timing plus `avg_time_in_state_seconds`
- Broker lifecycle E2E tests remain green with observability assertions
- Command-level run evidence exists for planner, executor, and verifier mediated reviews
- Phase verification report explicitly states PASS/FAIL for roadmap command-level criterion
- Full broker test suite passes with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/05-observability-and-validation/05-02-SUMMARY.md`
</output>
