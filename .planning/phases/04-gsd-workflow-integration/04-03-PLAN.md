---
phase: 04-gsd-workflow-integration
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - agents/gsd-executor.md
autonomous: true

must_haves:
  truths:
    - "gsd-executor loads tandem config (tandem_enabled, review_granularity, execution_mode) at startup"
    - "In blocking per-task mode, executor submits a proposal with task diff and description before committing"
    - "In blocking per-task mode, executor waits for approval before proceeding to commit"
    - "On changes_requested, executor reads feedback, checks for counter-patch, incorporates changes, and resubmits"
    - "In optimistic mode, executor commits immediately, submits proposal, continues to next task, checks reviews at plan end"
    - "In per-plan mode, executor runs all tasks with individual commits, then submits single combined diff for review"
    - "Executor skips all tandem sections when tandem_enabled=false"
    - "Executor falls back to solo mode on broker connection error"
  artifacts:
    - path: "agents/gsd-executor.md"
      provides: "Full tandem integration: config loading, per-task gate, optimistic mode, per-plan mode, error handling"
      contains: "tandem_config"
  key_links:
    - from: "agents/gsd-executor.md"
      to: "tools/gsd-review-broker/src/gsd_review_broker/tools.py"
      via: "mcp__gsdreview__create_review call with category=code_change"
      pattern: "create_review"
    - from: "agents/gsd-executor.md"
      to: ".planning/config.json"
      via: "grep-based config reading for tandem_enabled, review_granularity, execution_mode"
      pattern: "tandem_enabled"
---

<objective>
Integrate the gsd-executor agent with the review broker for all execution modes: blocking per-task, blocking per-plan, and optimistic.

Purpose: The executor is the primary producer of code changes. Every task commit (or plan-level batch) must be submitted for review when tandem is enabled. This gives the reviewer control over what code gets committed and the ability to supply counter-patches.

Output: Updated gsd-executor.md with tandem config loading, per-task review gate, per-plan review gate, optimistic mode, counter-patch handling, and error fallback.
</objective>

<execution_context>
@C:\Users\Jacar\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Jacar\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-gsd-workflow-integration/04-CONTEXT.md
@.planning/phases/04-gsd-workflow-integration/04-RESEARCH.md
@agents/gsd-executor.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tandem config loading and blocking per-task review gate to gsd-executor</name>
  <files>agents/gsd-executor.md</files>
  <action>
    Read `agents/gsd-executor.md` in full. Make the following additions:

    **1. Frontmatter:** Add `mcp__gsdreview__*` to the `tools:` line (after existing tools).

    **2. Add `<tandem_config>` section** immediately after `<auto_mode_detection>` and before `<checkpoint_protocol>`:

    ```markdown
    <tandem_config>
    ## Load Tandem Configuration

    At executor start, read tandem settings from config:

    ```bash
    TANDEM_ENABLED=$(cat .planning/config.json 2>/dev/null | grep -o '"tandem_enabled"[[:space:]]*:[[:space:]]*[^,}]*' | grep -o 'true\|false' || echo "false")
    REVIEW_GRANULARITY=$(cat .planning/config.json 2>/dev/null | grep -o '"review_granularity"[[:space:]]*:[[:space:]]*"[^"]*"' | grep -o '"[^"]*"$' | tr -d '"' || echo "per_task")
    EXECUTION_MODE=$(cat .planning/config.json 2>/dev/null | grep -o '"execution_mode"[[:space:]]*:[[:space:]]*"[^"]*"' | grep -o '"[^"]*"$' | tr -d '"' || echo "blocking")
    ```

    Store these values for use in `<tandem_task_review>`, `<tandem_plan_review_gate>`, and `<tandem_optimistic_mode>` sections.

    If `TANDEM_ENABLED=false`: Skip ALL `<tandem_*>` sections throughout execution.

    **Per-plan tracking:** If `REVIEW_GRANULARITY=per_plan`, record the starting git ref before the first task:
    ```bash
    PLAN_START_REF=$(git rev-parse HEAD)
    ```
    </tandem_config>
    ```

    **3. Add `<tandem_task_review>` section** immediately after `<task_commit_protocol>`:

    ```markdown
    <tandem_task_review>
    ## Tandem Task Review Gate (Per-Task Blocking Mode)

    **When:** After task verification passes but BEFORE git commit (inserts before step 1 of task_commit_protocol).
    **Skip if:** `TANDEM_ENABLED=false` OR `REVIEW_GRANULARITY=per_plan` OR `EXECUTION_MODE=optimistic`

    1. Generate the task's diff:
       ```bash
       TASK_DIFF=$(git diff HEAD)
       ```
       If TASK_DIFF is empty (no changes), skip the review gate for this task.

    2. Submit proposal:
       Call `mcp__gsdreview__create_review` with:
       - `intent`: "Task {task_number}: {task_name} in plan {phase}-{plan}"
       - `agent_type`: "gsd-executor"
       - `agent_role`: "proposer"
       - `phase`: the phase number
       - `plan`: the plan number
       - `task`: the task number (as string)
       - `category`: "code_change"
       - `description`: "## Task Description\n{full task description from PLAN.md}\n\n## Verification Result\n{verification output}"
       - `diff`: TASK_DIFF

    3. Wait for verdict (long-poll):
       Loop:
         Call `mcp__gsdreview__get_review_status(review_id=ID, wait=true)`
         - **approved**: Call `mcp__gsdreview__close_review(review_id=ID)`. Proceed to task_commit_protocol (commit the changes).
         - **changes_requested**: Read `verdict_reason` for feedback. Check for counter-patch:
           - Call `mcp__gsdreview__get_proposal(review_id=ID)` — if response includes counter-patch info with status "pending":
             - Review the counter-patch content
             - If reasonable: `mcp__gsdreview__accept_counter_patch(review_id=ID)` — this replaces the active diff with the counter-patch. Apply the counter-patch diff to the working tree, then resubmit.
             - If not reasonable: `mcp__gsdreview__reject_counter_patch(review_id=ID)` — make your own fixes based on the feedback.
           - Incorporate feedback into the code changes
           - Generate new diff: `TASK_DIFF=$(git diff HEAD)`
           - Resubmit: `mcp__gsdreview__create_review(review_id=ID, intent=..., description=..., diff=NEW_TASK_DIFF)`
           - Return to polling

    4. After approval: proceed to standard task_commit_protocol (stage, commit, record hash).

    **Error handling:** If the first `mcp__gsdreview__create_review` call fails with a connection error:
    - Log warning: "Review broker unreachable. Proceeding in solo mode for remaining tasks."
    - Set TANDEM_ENABLED=false for the remainder of this execution
    - Proceed to task_commit_protocol normally

    **Revision limit:** After 3 revision rounds on a single task, warn: "Task review has gone through 3 rounds. Consider discussing directly with the reviewer." Continue the loop.
    </tandem_task_review>
    ```

    **Important:** The tandem_task_review gate inserts BEFORE the commit in task_commit_protocol. The flow becomes: execute task -> verify task -> tandem review gate (if enabled) -> task_commit_protocol (stage + commit). Do NOT move or modify task_commit_protocol itself — the tandem gate is an additional pre-commit step.
  </action>
  <verify>
    1. `grep "mcp__gsdreview__" agents/gsd-executor.md` — appears in tools line and tandem sections
    2. `grep "tandem_config" agents/gsd-executor.md` — config loading section exists
    3. `grep "tandem_task_review" agents/gsd-executor.md` — per-task gate section exists
    4. `grep "tandem_enabled" agents/gsd-executor.md` — config guard exists
    5. `grep "code_change" agents/gsd-executor.md` — correct category used
    6. `grep "counter_patch" agents/gsd-executor.md` — counter-patch handling exists
    7. Confirm task_commit_protocol section is unchanged
  </verify>
  <done>
    gsd-executor.md has mcp__gsdreview__* in tools. Tandem config loading reads tandem_enabled, review_granularity, and execution_mode at startup. Per-task blocking review gate submits code_change proposals with task description and diff, long-polls for verdict, handles changes_requested with counter-patch support, and falls back to solo mode on broker error. Existing task_commit_protocol is preserved unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add optimistic mode and per-plan granularity to gsd-executor</name>
  <files>agents/gsd-executor.md</files>
  <action>
    Read `agents/gsd-executor.md` (with Task 1 changes already applied). Add two new sections after `<tandem_task_review>`:

    **1. Add `<tandem_optimistic_mode>` section:**

    ```markdown
    <tandem_optimistic_mode>
    ## Tandem Optimistic Execution Mode

    **When:** `TANDEM_ENABLED=true` AND `EXECUTION_MODE=optimistic` AND `REVIEW_GRANULARITY=per_task`
    **Skip if:** `TANDEM_ENABLED=false` OR `EXECUTION_MODE=blocking` OR `REVIEW_GRANULARITY=per_plan`

    In optimistic mode, the executor commits changes immediately (standard flow) and submits proposals after commit. Reviews happen asynchronously while execution continues.

    **Per-task flow:**

    1. Execute task normally
    2. Run task_commit_protocol (stage, commit) — do NOT wait for review
    3. Record commit hash: `TASK_COMMIT_HASH=$(git rev-parse HEAD)`
    4. Generate diff from the commit: `TASK_DIFF=$(git diff HEAD~1..HEAD)`
    5. Submit proposal (non-blocking — do not poll):
       Call `mcp__gsdreview__create_review` with same fields as tandem_task_review but with the post-commit diff.
       Store: `PENDING_REVIEWS[{task_number}] = {review_id: ID, commit_hash: TASK_COMMIT_HASH}`
    6. Continue to next task immediately

    **At plan completion** (after all tasks, before summary_creation):

    Check all pending reviews:
    ```
    for each entry in PENDING_REVIEWS (in task order):
      status = mcp__gsdreview__get_review_status(review_id=entry.review_id, wait=false)
      if status.status == "approved":
        mcp__gsdreview__close_review(review_id=entry.review_id)
        # OK — move to next
      elif status.status == "changes_requested":
        # STOP optimistic execution
        # Warn: "Task {N} rejected by reviewer. Reverting task {N} and all subsequent commits."
        # Revert from this task's commit onward:
        git revert --no-edit HEAD~{number_of_subsequent_commits}..HEAD
        # Note: git revert creates new commits that undo the changes
        # Read feedback: status.verdict_reason
        # Check for counter-patch via get_proposal
        # Incorporate feedback, re-execute from this task onward
        # Switch to blocking mode for the remainder of this plan
        break
      elif status.status == "pending":
        # Not yet reviewed — wait with long-poll
        Loop:
          status = mcp__gsdreview__get_review_status(review_id=entry.review_id, wait=true)
          if status.status in ("approved", "changes_requested"):
            break
        # Then handle as above
    ```

    **Limitation (v1):** If an early task is rejected, ALL subsequent task commits for this plan are reverted. The executor must re-execute from the rejected task onward in blocking mode. Document this in SUMMARY.md under "Optimistic Mode Reverts" if it occurs.

    **Error handling:** If broker is unreachable during the end-of-plan review check, warn user and proceed (changes are already committed).
    </tandem_optimistic_mode>
    ```

    **2. Add `<tandem_plan_review_gate>` section** after `<tandem_optimistic_mode>`:

    ```markdown
    <tandem_plan_review_gate>
    ## Tandem Plan-Level Review Gate (Per-Plan Granularity)

    **When:** `TANDEM_ENABLED=true` AND `REVIEW_GRANULARITY=per_plan` AND `EXECUTION_MODE=blocking`
    **Skip if:** `TANDEM_ENABLED=false` OR `REVIEW_GRANULARITY=per_task` OR `EXECUTION_MODE=optimistic`

    In per-plan mode, individual tasks are committed normally without review gates. A single review proposal is submitted after all tasks complete, covering the entire plan's changes.

    **Flow:**

    1. Execute all tasks normally — each task goes through task_commit_protocol (commit individually, no tandem gate)
    2. After all tasks complete, generate combined diff:
       ```bash
       COMBINED_DIFF=$(git diff ${PLAN_START_REF}..HEAD)
       ```
       Where `PLAN_START_REF` was recorded in `<tandem_config>` before the first task.
    3. Build combined description: Include all task descriptions from PLAN.md, concatenated with headers.
    4. Submit single proposal:
       Call `mcp__gsdreview__create_review` with:
       - `intent`: "Plan {phase}-{plan}: {plan objective} ({N} tasks)"
       - `agent_type`: "gsd-executor"
       - `agent_role`: "proposer"
       - `phase`: the phase number
       - `plan`: the plan number
       - `category`: "code_change"
       - `description`: Combined task descriptions and verification results
       - `diff`: COMBINED_DIFF
    5. Wait for verdict (long-poll):
       Loop:
         Call `mcp__gsdreview__get_review_status(review_id=ID, wait=true)`
         - **approved**: Close review, proceed to summary_creation
         - **changes_requested**: Read feedback. If rejection applies to the entire plan:
           - Revert all task commits: `git revert --no-edit ${PLAN_START_REF}..HEAD`
           - Incorporate feedback
           - Re-execute all tasks
           - Resubmit combined diff
           - Return to polling

    **Important:** Per-plan mode still commits each task individually (for git history traceability). The review gate simply moves from per-task to post-all-tasks. On rejection, all task commits for the plan are reverted.

    **Per-plan + optimistic combination:** If `REVIEW_GRANULARITY=per_plan` AND `EXECUTION_MODE=optimistic`, behavior is the same as per-plan blocking — the combined diff is submitted after all tasks, but the executor does not wait. At plan completion, check review status. Revert all if rejected.
    </tandem_plan_review_gate>
    ```

    **3. Add `<tandem_error_handling>` section** after `<tandem_plan_review_gate>`:

    ```markdown
    <tandem_error_handling>
    ## Broker Connection Error Handling

    If any `mcp__gsdreview__*` call fails with a connection error (the very first call in a session):

    1. Log warning: "Review broker unreachable. Falling back to solo mode for this session."
    2. Set `TANDEM_ENABLED=false` for the remainder of this executor's execution
    3. Proceed with normal (non-tandem) workflow — standard task_commit_protocol without review gates
    4. Do NOT retry broker calls — the broker is likely not running

    This ensures workflow never blocks on a missing broker. The user sees the warning and can start the broker for next execution.
    </tandem_error_handling>
    ```
  </action>
  <verify>
    1. `grep "tandem_optimistic_mode" agents/gsd-executor.md` — optimistic section exists
    2. `grep "tandem_plan_review_gate" agents/gsd-executor.md` — per-plan section exists
    3. `grep "tandem_error_handling" agents/gsd-executor.md` — error section exists
    4. `grep "git revert" agents/gsd-executor.md` — revert mechanism documented
    5. `grep "PLAN_START_REF" agents/gsd-executor.md` — appears in both tandem_config and plan_review_gate
    6. `grep "PENDING_REVIEWS" agents/gsd-executor.md` — optimistic tracking exists
    7. Confirm all existing sections (execution_flow, deviation_rules, task_commit_protocol, etc.) are preserved
  </verify>
  <done>
    gsd-executor.md has optimistic mode section (commit-then-submit, end-of-plan review check, git revert on rejection, cascade limitation documented). Per-plan granularity section (combined diff after all tasks, single review submission, revert-all on rejection). Error handling section (solo fallback on broker connection error). All existing executor behavior preserved unchanged.
  </done>
</task>

</tasks>

<verification>
1. `grep -c "tandem_" agents/gsd-executor.md` — should be 4+ (config, task_review, optimistic_mode, plan_review_gate, error_handling)
2. `grep "mcp__gsdreview__" agents/gsd-executor.md` — appears in tools and all tandem sections
3. `grep "solo mode" agents/gsd-executor.md` — error fallback documented
4. `grep "blocking" agents/gsd-executor.md` — blocking mode referenced
5. `grep "optimistic" agents/gsd-executor.md` — optimistic mode referenced
6. `grep "per_plan" agents/gsd-executor.md` — per-plan granularity referenced
7. All existing sections intact: grep for execution_flow, deviation_rules, task_commit_protocol, checkpoint_protocol, summary_creation
</verification>

<success_criteria>
- Executor loads tandem config at startup (tandem_enabled, review_granularity, execution_mode)
- Blocking per-task mode: submits diff + task description before commit, polls for approval, handles counter-patches
- Optimistic mode: commits first, submits proposal, continues, checks at plan end, reverts on rejection
- Per-plan mode: runs all tasks, submits combined diff, reverts all on rejection
- All tandem sections skip cleanly when tandem_enabled=false
- Broker error falls back to solo mode
- Existing executor behavior completely preserved
</success_criteria>

<output>
After completion, create `.planning/phases/04-gsd-workflow-integration/04-03-SUMMARY.md`
</output>
