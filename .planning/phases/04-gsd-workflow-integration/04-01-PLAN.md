---
phase: 04-gsd-workflow-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tools/gsd-review-broker/src/gsd_review_broker/models.py
  - tools/gsd-review-broker/src/gsd_review_broker/db.py
  - tools/gsd-review-broker/src/gsd_review_broker/tools.py
  - tools/gsd-review-broker/tests/test_category.py
  - .planning/config.json
autonomous: true

must_haves:
  truths:
    - "create_review accepts optional category parameter and stores it in the database"
    - "list_reviews accepts optional category filter and returns only matching reviews"
    - "get_review_status and get_proposal return the category field"
    - "claim_review response includes the category field"
    - "config.json contains tandem_enabled, review_granularity, and execution_mode fields"
  artifacts:
    - path: "tools/gsd-review-broker/src/gsd_review_broker/models.py"
      provides: "Category StrEnum with plan_review, code_change, verification, handoff values"
      contains: "class Category"
    - path: "tools/gsd-review-broker/src/gsd_review_broker/db.py"
      provides: "Schema migration for category column"
      contains: "ADD COLUMN category"
    - path: "tools/gsd-review-broker/src/gsd_review_broker/tools.py"
      provides: "category parameter in create_review and list_reviews"
      contains: "category"
    - path: "tools/gsd-review-broker/tests/test_category.py"
      provides: "Tests for category creation, filtering, and retrieval"
      min_lines: 60
    - path: ".planning/config.json"
      provides: "Tandem configuration fields"
      contains: "tandem_enabled"
  key_links:
    - from: "tools/gsd-review-broker/src/gsd_review_broker/tools.py"
      to: "tools/gsd-review-broker/src/gsd_review_broker/db.py"
      via: "category column in INSERT/SELECT"
      pattern: "category"
---

<objective>
Add category field to the review broker and tandem configuration to config.json.

Purpose: The category field lets proposals be typed (plan_review, code_change, verification, handoff) so reviewers can filter and prioritize. The config fields (tandem_enabled, review_granularity, execution_mode) control whether and how GSD commands interact with the broker.

Output: Updated broker models/schema/tools with category support, new tests, and tandem config in config.json.
</objective>

<execution_context>
@C:\Users\Jacar\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Jacar\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@tools/gsd-review-broker/src/gsd_review_broker/models.py
@tools/gsd-review-broker/src/gsd_review_broker/db.py
@tools/gsd-review-broker/src/gsd_review_broker/tools.py
@tools/gsd-review-broker/tests/conftest.py
@tools/gsd-review-broker/tests/test_proposals.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Category StrEnum, schema migration, and tool parameter support</name>
  <files>
    tools/gsd-review-broker/src/gsd_review_broker/models.py
    tools/gsd-review-broker/src/gsd_review_broker/db.py
    tools/gsd-review-broker/src/gsd_review_broker/tools.py
  </files>
  <action>
    **models.py:** Add a `Category` StrEnum after the existing `CounterPatchStatus` class with values: `PLAN_REVIEW = "plan_review"`, `CODE_CHANGE = "code_change"`, `VERIFICATION = "verification"`, `HANDOFF = "handoff"`.

    **db.py:** Add one migration to the `SCHEMA_MIGRATIONS` list:
    ```python
    # Phase 4 migrations
    "ALTER TABLE reviews ADD COLUMN category TEXT",
    ```

    **tools.py — `create_review`:** Add `category: str | None = None` parameter after `task`. In the new-review INSERT, add `category` to both the column list and the VALUES. Include `category` in the values tuple passed to execute. The revision flow UPDATE does NOT change category (category is set at creation time). Category is NOT validated against the StrEnum — it's a free-text field stored as-is (per the pattern used for `agent_type` and `agent_role`).

    **tools.py — `list_reviews`:** Add `category: str | None = None` parameter. Build WHERE clause dynamically: if status is provided, add `status = ?`; if category is provided, add `category = ?`. Both can be combined. Add `category` to the SELECT column list and include it in each review dict in the response.

    **tools.py — `get_review_status`:** Add `category` to the SELECT column list and include it in the returned dict.

    **tools.py — `get_proposal`:** Add `category` to the SELECT column list and include it in the returned dict.

    **tools.py — `claim_review`:** Add `category` to the SELECT column list in the claim query and include it in the returned result dict.
  </action>
  <verify>
    Run `cd tools/gsd-review-broker && uv run pytest tests/ -v` — all existing 132 tests pass. No import errors.
  </verify>
  <done>
    Category StrEnum exists in models.py. Migration appended to db.py. create_review accepts and stores category. list_reviews filters by category. get_review_status, get_proposal, and claim_review return category in response. All existing tests pass (no regressions).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tandem configuration to config.json</name>
  <files>.planning/config.json</files>
  <action>
    Read `.planning/config.json` and add three new fields at the top level (alongside existing `mode`, `depth`, etc.):

    ```json
    {
      "mode": "yolo",
      "depth": "standard",
      "parallelization": true,
      "commit_docs": true,
      "model_profile": "quality",
      "tandem_enabled": false,
      "review_granularity": "per_task",
      "execution_mode": "blocking",
      "workflow": {
        "research": true,
        "plan_check": true,
        "verifier": true
      }
    }
    ```

    - `tandem_enabled`: boolean, default `false` (safe default — all broker interactions skipped when false)
    - `review_granularity`: string, `"per_task"` (default) or `"per_plan"`
    - `execution_mode`: string, `"blocking"` (default) or `"optimistic"`
  </action>
  <verify>
    Read `.planning/config.json` and confirm it is valid JSON with the three new fields present, defaults correct, and existing fields preserved.
  </verify>
  <done>
    config.json contains tandem_enabled (false), review_granularity ("per_task"), and execution_mode ("blocking") alongside all existing fields.
  </done>
</task>

<task type="auto">
  <name>Task 3: Tests for category support</name>
  <files>tools/gsd-review-broker/tests/test_category.py</files>
  <action>
    Create `test_category.py` following the established test patterns (import tools via `.fn`, use `MockContext` from conftest, mock `validate_diff` for diff tests).

    **Tests to write:**

    1. `test_create_review_with_category` — Create a review with `category="plan_review"`, verify response has `review_id`. Query the database directly to confirm `category` column stores `"plan_review"`.

    2. `test_create_review_without_category` — Create a review omitting `category`, verify success. Query database to confirm `category` is NULL.

    3. `test_list_reviews_filter_by_category` — Create 3 reviews with different categories (plan_review, code_change, verification). Call `list_reviews(category="code_change")`, verify only the code_change review is returned.

    4. `test_list_reviews_filter_by_status_and_category` — Create 2 reviews with same category but different statuses. Filter by both status and category, verify only the matching one is returned.

    5. `test_get_review_status_includes_category` — Create a review with category, call `get_review_status`, verify the response dict includes `"category": "plan_review"`.

    6. `test_get_proposal_includes_category` — Create a review with category, call `get_proposal`, verify the response dict includes the category.

    7. `test_claim_review_includes_category` — Create a review with category, claim it (mock validate_diff), verify claim response includes category.

    8. `test_list_reviews_includes_category_field` — Create a review with category, call `list_reviews()`, verify each review dict in the response includes the `category` field.

    Use `create_review.fn(intent=..., agent_type="gsd-executor", agent_role="proposer", phase="4", category="plan_review", ctx=ctx)` pattern. Follow existing test style from `test_proposals.py`.
  </action>
  <verify>
    Run `cd tools/gsd-review-broker && uv run pytest tests/test_category.py -v` — all 8 tests pass. Then run full suite: `uv run pytest tests/ -v` — all tests pass (existing + new).
  </verify>
  <done>
    8 category tests pass. Full test suite passes with zero failures. Total test count increased from 132 to 140.
  </done>
</task>

</tasks>

<verification>
1. `cd tools/gsd-review-broker && uv run pytest tests/ -v` — all tests pass (140+)
2. `cat .planning/config.json | python -m json.tool` — valid JSON with tandem fields
3. `grep -n "category" tools/gsd-review-broker/src/gsd_review_broker/tools.py` — category appears in create_review, list_reviews, get_review_status, get_proposal, claim_review
</verification>

<success_criteria>
- Category StrEnum exists with 4 values
- Schema migration added for category column
- create_review stores category, list_reviews filters by it, all read tools return it
- 8 new tests pass, no regressions on existing 132 tests
- config.json has tandem_enabled=false, review_granularity=per_task, execution_mode=blocking
</success_criteria>

<output>
After completion, create `.planning/phases/04-gsd-workflow-integration/04-01-SUMMARY.md`
</output>
