---
phase: 04-gsd-workflow-integration
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - commands/gsd/plan-phase.md
  - commands/gsd/execute-phase.md
  - commands/gsd/discuss-phase.md
  - commands/gsd/verify-work.md
  - agents/gsd-planner.md
autonomous: true

must_haves:
  truths:
    - "All four GSD commands include mcp__gsdreview__* in their allowed-tools frontmatter"
    - "gsd-planner submits full PLAN.md content for review before writing to disk when tandem is enabled"
    - "discuss-phase submits full CONTEXT.md content for review before writing when tandem is enabled"
    - "verify-work submits full VERIFICATION.md content for review before writing when tandem is enabled"
    - "All tandem review gates are skipped when tandem_enabled is false (solo mode)"
    - "Broker connection errors fall back to solo mode gracefully"
  artifacts:
    - path: "commands/gsd/plan-phase.md"
      provides: "MCP tool permissions for broker access"
      contains: "mcp__gsdreview__"
    - path: "commands/gsd/execute-phase.md"
      provides: "MCP tool permissions for broker access"
      contains: "mcp__gsdreview__"
    - path: "commands/gsd/discuss-phase.md"
      provides: "MCP tool permissions and tandem review gate instructions"
      contains: "mcp__gsdreview__"
    - path: "commands/gsd/verify-work.md"
      provides: "MCP tool permissions and tandem review gate instructions"
      contains: "mcp__gsdreview__"
    - path: "agents/gsd-planner.md"
      provides: "Tandem plan review gate before writing PLAN.md"
      contains: "tandem_plan_review"
  key_links:
    - from: "agents/gsd-planner.md"
      to: "tools/gsd-review-broker/src/gsd_review_broker/tools.py"
      via: "mcp__gsdreview__create_review call with category=plan_review"
      pattern: "create_review"
    - from: "commands/gsd/discuss-phase.md"
      to: "tools/gsd-review-broker/src/gsd_review_broker/tools.py"
      via: "mcp__gsdreview__create_review call with category=handoff"
      pattern: "create_review"
    - from: "commands/gsd/verify-work.md"
      to: "tools/gsd-review-broker/src/gsd_review_broker/tools.py"
      via: "mcp__gsdreview__create_review call with category=verification"
      pattern: "create_review"
---

<objective>
Add MCP broker tool permissions to all four GSD commands and integrate tandem review gates into plan-phase, discuss-phase, and verify-work workflows.

Purpose: These commands produce artifacts (PLAN.md, CONTEXT.md, VERIFICATION.md) that the reviewer must approve before they are written to disk. This gives the reviewer control over the entire GSD workflow pace.

Output: Updated command frontmatter with MCP tools, tandem review gate instructions in gsd-planner.md, discuss-phase.md, and verify-work.md.
</objective>

<execution_context>
@C:\Users\Jacar\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Jacar\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-gsd-workflow-integration/04-CONTEXT.md
@.planning/phases/04-gsd-workflow-integration/04-RESEARCH.md
@commands/gsd/plan-phase.md
@commands/gsd/execute-phase.md
@commands/gsd/discuss-phase.md
@commands/gsd/verify-work.md
@agents/gsd-planner.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add mcp__gsdreview__* to all four command frontmatters</name>
  <files>
    commands/gsd/plan-phase.md
    commands/gsd/execute-phase.md
    commands/gsd/discuss-phase.md
    commands/gsd/verify-work.md
  </files>
  <action>
    For each of the four command files, add `- mcp__gsdreview__*` to the `allowed-tools:` list in the YAML frontmatter. Place it at the end of the existing allowed-tools list.

    **plan-phase.md:** After `- mcp__context7__*`, add `- mcp__gsdreview__*`
    **execute-phase.md:** After `- AskUserQuestion`, add `- mcp__gsdreview__*`
    **discuss-phase.md:** After `- Task`, add `- mcp__gsdreview__*`
    **verify-work.md:** After `- Task`, add `- mcp__gsdreview__*`

    Do NOT modify any other content in these files. Only add the single line to the frontmatter.
  </action>
  <verify>
    For each file, run: `grep "mcp__gsdreview__" commands/gsd/plan-phase.md commands/gsd/execute-phase.md commands/gsd/discuss-phase.md commands/gsd/verify-work.md` — all four files should match.
  </verify>
  <done>
    All four GSD command files have `mcp__gsdreview__*` in their allowed-tools frontmatter. No other content changed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tandem review gate to gsd-planner.md</name>
  <files>agents/gsd-planner.md</files>
  <action>
    Read `agents/gsd-planner.md` in full. Add `mcp__gsdreview__*` to the `tools:` line in the frontmatter (after existing tools).

    Then add a new `<tandem_plan_review>` section BEFORE the existing `<step name="write_phase_prompt">` step in the `<execution_flow>`. This gate fires AFTER the plan content is drafted but BEFORE it is written to disk.

    **Content of the tandem section:**

    ```markdown
    <tandem_plan_review>
    ## Tandem Plan Review Gate

    **When:** After plan content is fully drafted but BEFORE writing PLAN.md to disk.
    **Skip if:** tandem is disabled.

    **Step 1: Check tandem config:**
    ```bash
    TANDEM_ENABLED=$(cat .planning/config.json 2>/dev/null | grep -o '"tandem_enabled"[[:space:]]*:[[:space:]]*[^,}]*' | grep -o 'true\|false' || echo "false")
    ```

    If `TANDEM_ENABLED=false`: Skip this section entirely. Proceed to write PLAN.md as normal.

    **Step 2: Submit plan for review:**
    Call `mcp__gsdreview__create_review` with:
    - `intent`: "Plan {phase}-{plan}: {brief plan objective}"
    - `agent_type`: "gsd-planner"
    - `agent_role`: "proposer"
    - `phase`: the phase number
    - `plan`: the plan number
    - `category`: "plan_review"
    - `description`: The full PLAN.md content that was drafted (the complete markdown including frontmatter)
    - `diff`: null (plans are content, not diffs)

    **Step 3: Wait for verdict (long-poll):**
    Loop:
      Call `mcp__gsdreview__get_review_status(review_id=ID, wait=true)`
      - If `status == "approved"`: Call `mcp__gsdreview__close_review(review_id=ID)`. Proceed to write PLAN.md to disk.
      - If `status == "changes_requested"`: Read `verdict_reason`. Check for counter-patch via `mcp__gsdreview__get_proposal(review_id=ID)`. If counter-patch exists and `counter_patch_status == "pending"`, review the counter-patch content. Accept if reasonable via `mcp__gsdreview__accept_counter_patch(review_id=ID)` or reject via `mcp__gsdreview__reject_counter_patch(review_id=ID)`. Incorporate feedback from `verdict_reason` into the plan. Resubmit via `mcp__gsdreview__create_review(review_id=ID, intent=..., description=REVISED_PLAN_CONTENT, ...)`. Return to polling.

    **Step 4: After approval, write PLAN.md to disk using Write tool (existing behavior).**

    **Error handling:** If any `mcp__gsdreview__*` call fails with a connection error on the first attempt:
    - Log warning: "Review broker unreachable. Proceeding in solo mode."
    - Set TANDEM_ENABLED=false for the remainder of this execution
    - Proceed to write PLAN.md normally

    **Revision limit:** After 3 revision rounds, warn: "Plan review has gone through 3 rounds. Consider discussing directly with the reviewer." Continue the loop but surface the warning.
    </tandem_plan_review>
    ```

    Place this section inside `<execution_flow>` just before `<step name="write_phase_prompt">`.
  </action>
  <verify>
    1. `grep "mcp__gsdreview__" agents/gsd-planner.md` — matches in tools line and tandem section
    2. `grep "tandem_plan_review" agents/gsd-planner.md` — section exists
    3. `grep "tandem_enabled" agents/gsd-planner.md` — config check exists
    4. Visually confirm the section is placed before `write_phase_prompt` step
  </verify>
  <done>
    gsd-planner.md has mcp__gsdreview__* in tools frontmatter. Tandem plan review gate section exists with config check, proposal submission, long-poll verdict loop, counter-patch handling, error fallback, and revision limit. Gate is positioned before PLAN.md write step.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add tandem review gates to discuss-phase and verify-work</name>
  <files>
    commands/gsd/discuss-phase.md
    commands/gsd/verify-work.md
  </files>
  <action>
    **discuss-phase.md:** Add a `<tandem_review_gate>` section at the end of the `<process>` section (after step 7 "Offer next steps" but before `</process>`). This gate fires after CONTEXT.md content is drafted but before writing to disk.

    Content:
    ```markdown

    **Tandem Review Gate (if enabled):**

    Before writing CONTEXT.md to disk, check tandem config:
    ```bash
    TANDEM_ENABLED=$(cat .planning/config.json 2>/dev/null | grep -o '"tandem_enabled"[[:space:]]*:[[:space:]]*[^,}]*' | grep -o 'true\|false' || echo "false")
    ```

    If `TANDEM_ENABLED=true`:
    1. Submit CONTEXT.md content for review:
       - `mcp__gsdreview__create_review(intent="Phase {N} context: {phase name}", agent_type="gsd-discuss", agent_role="proposer", phase="{N}", category="handoff", description=FULL_CONTEXT_MD_CONTENT)`
    2. Long-poll for verdict:
       - Loop: `mcp__gsdreview__get_review_status(review_id=ID, wait=true)`
       - Approved: `mcp__gsdreview__close_review(review_id=ID)`, proceed to write
       - Changes requested: Read `verdict_reason`, incorporate feedback, revise CONTEXT.md content, resubmit via `mcp__gsdreview__create_review(review_id=ID, ...)`
    3. After approval: write CONTEXT.md to disk

    If `TANDEM_ENABLED=false`: Write CONTEXT.md immediately (current behavior).

    Error handling: If broker unreachable, warn user and proceed in solo mode.
    ```

    **verify-work.md:** Add a `<tandem_review_gate>` section at the end of the `<process>` section. This gate fires after VERIFICATION.md (or UAT.md) content is drafted but before writing to disk.

    Content:
    ```markdown

    **Tandem Review Gate (if enabled):**

    Before writing verification results to disk, check tandem config:
    ```bash
    TANDEM_ENABLED=$(cat .planning/config.json 2>/dev/null | grep -o '"tandem_enabled"[[:space:]]*:[[:space:]]*[^,}]*' | grep -o 'true\|false' || echo "false")
    ```

    If `TANDEM_ENABLED=true`:
    1. Submit verification content for review:
       - `mcp__gsdreview__create_review(intent="Phase {N} verification: {pass/fail summary}", agent_type="gsd-verifier", agent_role="proposer", phase="{N}", category="verification", description=FULL_VERIFICATION_CONTENT_WITH_PASS_FAIL_ASSESSMENT)`
    2. Long-poll for verdict:
       - Loop: `mcp__gsdreview__get_review_status(review_id=ID, wait=true)`
       - Approved: `mcp__gsdreview__close_review(review_id=ID)`, proceed to write
       - Changes requested: Read `verdict_reason`. Reviewer may dispute the verdict — re-examine the test results, adjust assessment, resubmit via `mcp__gsdreview__create_review(review_id=ID, ...)`
    3. After approval: write verification results to disk

    If `TANDEM_ENABLED=false`: Write verification results immediately (current behavior).

    Error handling: If broker unreachable, warn user and proceed in solo mode.
    ```
  </action>
  <verify>
    1. `grep "tandem_enabled" commands/gsd/discuss-phase.md commands/gsd/verify-work.md` — both files match
    2. `grep "create_review" commands/gsd/discuss-phase.md` — shows handoff category
    3. `grep "create_review" commands/gsd/verify-work.md` — shows verification category
    4. Confirm existing process steps are preserved in both files
  </verify>
  <done>
    discuss-phase.md has tandem review gate that submits CONTEXT.md with category=handoff. verify-work.md has tandem review gate that submits VERIFICATION.md with category=verification. Both gates check tandem_enabled, long-poll for verdict, handle changes_requested with resubmission, and fall back to solo mode on broker error. All existing content preserved.
  </done>
</task>

</tasks>

<verification>
1. All four command files have `mcp__gsdreview__*` in allowed-tools: `grep -l "mcp__gsdreview__" commands/gsd/plan-phase.md commands/gsd/execute-phase.md commands/gsd/discuss-phase.md commands/gsd/verify-work.md`
2. gsd-planner.md has tandem section: `grep "tandem_plan_review" agents/gsd-planner.md`
3. discuss-phase.md has tandem gate with handoff category: `grep "handoff" commands/gsd/discuss-phase.md`
4. verify-work.md has tandem gate with verification category: `grep "verification" commands/gsd/verify-work.md`
5. Solo mode guard in all tandem sections: `grep -c "tandem_enabled" agents/gsd-planner.md commands/gsd/discuss-phase.md commands/gsd/verify-work.md`
</verification>

<success_criteria>
- All 4 command files grant mcp__gsdreview__* tool access
- gsd-planner.md submits plan content for review before writing PLAN.md (when tandem enabled)
- discuss-phase.md submits CONTEXT.md for review before writing (when tandem enabled)
- verify-work.md submits VERIFICATION.md for review before writing (when tandem enabled)
- All gates skip cleanly when tandem_enabled=false
- Error handling falls back to solo mode on broker connection failure
</success_criteria>

<output>
After completion, create `.planning/phases/04-gsd-workflow-integration/04-02-SUMMARY.md`
</output>
