---
phase: 10-log-viewer-tab
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - tools/gsd-review-broker/dashboard/src/components/LogViewer.astro
  - tools/gsd-review-broker/dashboard/src/scripts/logs.ts
  - tools/gsd-review-broker/dashboard/src/pages/index.astro
  - tools/gsd-review-broker/dashboard/dist/index.html
autonomous: true
requirements: [LOGS-01, LOGS-02]

must_haves:
  truths:
    - "User sees a dropdown listing available log files grouped by source (Broker Logs / Reviewer Logs) with name, size, and modified date"
    - "Selecting a log file loads its full contents and renders each entry as a terminal-style color-coded monospaced block"
    - "Most recent log file is auto-selected on page load so user sees content immediately"
    - "New log entries stream into the view automatically via live tail (SSE) with auto-scroll"
    - "User can pause/resume live tail via a toggle control"
    - "User can filter entries by text search that works on both existing and incoming entries"
    - "Pulsing dot indicator shows when entries are actively streaming"
  artifacts:
    - path: "tools/gsd-review-broker/dashboard/src/components/LogViewer.astro"
      provides: "Log viewer component with dropdown, controls toolbar, and log output area"
    - path: "tools/gsd-review-broker/dashboard/src/scripts/logs.ts"
      provides: "Log data fetching, rendering, SSE tail subscription, search filtering, auto-scroll"
    - path: "tools/gsd-review-broker/dashboard/src/pages/index.astro"
      provides: "Updated page importing LogViewer component and logs.ts script"
    - path: "tools/gsd-review-broker/dashboard/dist/index.html"
      provides: "Rebuilt dist with compiled log viewer tab"
  key_links:
    - from: "logs.ts"
      to: "/dashboard/api/logs"
      via: "fetch in init()"
      pattern: "fetch.*api/logs"
    - from: "logs.ts"
      to: "/dashboard/api/logs/{filename}"
      via: "fetch on file selection"
      pattern: "fetch.*api/logs/"
    - from: "logs.ts"
      to: "window.gsdSSE"
      via: "SSE subscription for log_tail events"
      pattern: "gsdSSE.*subscribe.*log_tail"
    - from: "LogViewer.astro"
      to: "logs.ts"
      via: "DOM element IDs for JS-driven rendering (established pattern from overview)"
      pattern: "id=\"log-"
---

<objective>
Build the Astro frontend for the Log Viewer tab with terminal-style rendering, file selector dropdown, live tail streaming, and text search.

Purpose: Gives users a visual, real-time log viewer within the dashboard -- replacing the need to manually inspect JSONL files on disk.

Output: LogViewer.astro component, logs.ts data script, updated index.astro, rebuilt dist/.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-log-viewer-tab/10-CONTEXT.md
@.planning/phases/10-log-viewer-tab/10-01-SUMMARY.md
@.planning/phases/09-overview-tab/09-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LogViewer Astro component with terminal-style layout</name>
  <files>
    tools/gsd-review-broker/dashboard/src/components/LogViewer.astro
    tools/gsd-review-broker/dashboard/src/pages/index.astro
  </files>
  <action>
**Create LogViewer.astro component:**

Create `tools/gsd-review-broker/dashboard/src/components/LogViewer.astro` with the following structure:

HTML structure (all elements need IDs for logs.ts to populate dynamically, following the overview component pattern):

1. **Controls toolbar** (top bar):
   - File selector dropdown: `<select id="log-file-select">` with a disabled default option "Select log file...". The optgroups ("Broker Logs", "Reviewer Logs") and options will be populated dynamically by logs.ts.
   - Live tail toggle button: `<button id="log-tail-toggle">` with a pulsing dot indicator `<span id="log-tail-dot" class="tail-dot"></span>` and text label. Default state: tail active.
   - Text search input: `<input id="log-search" type="text" placeholder="Search logs..." />` positioned to the right of the controls.

2. **Log output area**:
   - `<div id="log-output" class="log-output">` -- scrollable container for rendered log entries.
   - `<div id="log-empty" class="log-empty"><p>Select a log file to view entries.</p></div>` -- shown when no file selected.
   - `<div id="log-loading" class="log-loading" style="display:none"><p>Loading...</p></div>` -- shown during file load.

Scoped CSS styling:

- `.log-controls` -- Flex row with gap, sticky at top of the tab panel, background matches surface color with bottom border.
- `select#log-file-select` -- Styled with design token variables: `var(--color-surface)` background, `var(--color-border)` border, `var(--color-text)` color, `var(--font-mono)` font. Width enough to show full filenames (min-width: 300px).
- `#log-tail-toggle` -- Button with surface styling. When active, dot pulses with CSS animation.
- `.tail-dot` -- 8px circle, default `var(--color-text-secondary)`. Use `is:global` CSS for state classes set by JS:
  - `.tail-dot-active` -- `var(--color-success)` (#00e676 dark / #2e7d32 light) with pulsing animation.
  - `.tail-dot-paused` -- `var(--color-warning)` (#ffab40 dark / #ef6c00 light), no pulse.
  - `.tail-dot-idle` -- `var(--color-text-secondary)`, no pulse.
- `#log-search` -- Input with surface styling, border, padding, monospace font.
- `.log-output` -- Monospaced terminal-style area: `var(--font-mono)`, `var(--font-size-sm)` (0.8rem), `overflow-y: auto`, `max-height: calc(100vh - 200px)` for scrollable content, `var(--color-bg)` background (slightly darker than surface for terminal feel), 1px border.
- `.log-entry` -- Single log entry: padding 4px 8px, border-bottom with subtle border color, white-space: pre-wrap for long messages. Use `is:global` CSS for level-based color classes set by JS:
  - `.log-level-error` -- `var(--color-error)` text color
  - `.log-level-warn` / `.log-level-warning` -- `var(--color-warning)` text color
  - `.log-level-info` -- `var(--color-text)` (default, no special color)
  - `.log-level-debug` -- `var(--color-text-secondary)` text color (gray)
- `.log-entry-ts` -- Timestamp prefix: `var(--color-text-secondary)`, slightly smaller font.
- `.log-entry-tag` -- Caller tag / reviewer_id in brackets: `var(--color-accent)` color.
- `.log-entry-message` -- Message content: inherits color from level class.
- `.log-entry-json` -- Pretty-printed JSON block: `var(--color-text-secondary)`, indented, smaller font.
- `.log-empty`, `.log-loading` -- Centered text, `var(--color-text-secondary)`.
- Pulsing animation keyframes: `@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }` applied to `.tail-dot-active`.

**Update index.astro:**

1. Add import for LogViewer: `import LogViewer from '../components/LogViewer.astro';`
2. Replace the placeholder content in `<section id="tab-logs">`:
   - Remove `<h2 class="tab-heading">Logs</h2>` and `<p class="tab-placeholder">...</p>`
   - Add `<LogViewer />`
3. Add script tag for logs.ts: `<script src="../scripts/logs.ts"></script>` after the existing overview.ts script tag.
  </action>
  <verify>
Run `npm run build` from tools/gsd-review-broker/dashboard/ -- build succeeds with no errors. Check that dist/index.html contains log viewer HTML structure (the select, button, and output div elements).
  </verify>
  <done>
LogViewer.astro component exists with dropdown selector, tail toggle button, search input, and terminal-style log output area. index.astro imports and renders the component in the logs tab panel. Astro build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create logs.ts data script with file loading, rendering, SSE tail, search, and auto-scroll</name>
  <files>
    tools/gsd-review-broker/dashboard/src/scripts/logs.ts
    tools/gsd-review-broker/dashboard/dist/index.html
  </files>
  <action>
Create `tools/gsd-review-broker/dashboard/src/scripts/logs.ts` following the established tab data script pattern (DOMContentLoaded init, fetch API, subscribe SSE). This is the most complex script in the dashboard -- handle all interactivity for the log viewer.

**TypeScript interfaces:**

```typescript
interface LogFile {
  name: string;
  size: number;
  modified: string;  // ISO 8601
  source: 'broker' | 'reviewer';
}

interface LogEntry {
  ts?: string;
  level?: string;
  event?: string;
  message?: string;
  reviewer_id?: string;
  caller_tag?: string;
  session_token?: string;
  stream?: string;
  pid?: number;
  exit_code?: number;
  exception?: string;
  [key: string]: unknown;  // Allow any other fields
}
```

**State variables:**

- `currentFile: string | null` -- Currently selected filename
- `allEntries: LogEntry[]` -- All entries for the current file (used for search filtering)
- `tailActive: boolean` -- Whether live tail is active (default: true)
- `searchQuery: string` -- Current search filter text
- `autoScroll: boolean` -- Whether to auto-scroll on new entries (default: true)

**Functions:**

1. `fetchFileList(): Promise<LogFile[]>` -- Fetch GET /dashboard/api/logs, return files array.

2. `populateDropdown(files: LogFile[])` -- Populate the `#log-file-select` dropdown:
   - Clear existing options (keep the disabled default).
   - Create two optgroups: "Broker Logs" and "Reviewer Logs".
   - For each file, create an `<option>` with value=filename, text showing: `{name} ({formatSize(size)}, {formatDate(modified)})` where formatSize shows human-readable bytes (KB/MB) and formatDate shows relative or short timestamp.
   - Auto-select the first file in the list (most recent, since API returns sorted by mtime desc) per user decision.

3. `loadFile(filename: string)` -- Fetch GET /dashboard/api/logs/{filename}:
   - Show loading indicator, hide log output.
   - Fetch and parse response.
   - Store entries in `allEntries`.
   - Call `renderEntries()`.
   - Hide loading, show log output.
   - Start SSE tail subscription for this file.
   - Scroll to bottom.

4. `renderEntries()` -- Render entries into `#log-output`:
   - Clear the output div.
   - Filter entries by `searchQuery` if non-empty (case-insensitive text match against the full JSON stringified entry -- this is the simplest approach that covers all fields including message content).
   - For each entry, create a `.log-entry` div element.
   - Per user decision (terminal-style, color-coded, full JSON pretty-printed), render each entry as:
     - Line 1: `[timestamp] [tag] message` where:
       - timestamp = entry.ts formatted as HH:MM:SS.mmm (short form for readability)
       - tag = entry.caller_tag or entry.reviewer_id or entry.event (whichever is present, for identification)
       - message = entry.message (if present)
     - Line 2+: Full pretty-printed JSON of the entire entry object (`JSON.stringify(entry, null, 2)`) displayed in a `<pre class="log-entry-json">` block.
   - Apply level-based CSS class: determine level from `entry.level` (broker logs) or infer from `entry.event` (reviewer logs: "reviewer_exit" with exit_code != 0 -> error, otherwise info). Add class `log-level-{level}` to the entry div.
   - Use `document.createDocumentFragment()` for batch DOM insertion (performance with many entries).

5. `formatSize(bytes: number): string` -- Format bytes as "1.2 KB", "3.4 MB", etc.

6. `formatTimestamp(iso: string): string` -- Format ISO timestamp as "HH:MM:SS.mmm".

7. `formatDate(iso: string): string` -- Format ISO timestamp as "Feb 26, 12:34" for the dropdown.

8. `escapeHtml(text: string): string` -- HTML entity escaping (reuse the div.textContent pattern from overview.ts).

9. `startTail(filename: string)` -- Connect SSE for live tail:
   - The existing SSE manager (`window.gsdSSE`) dispatches messages by `data.type`. Subscribe to `log_tail` events.
   - However, the SSE endpoint needs to know WHICH file to tail. The approach: disconnect and reconnect the EventSource with a query parameter. Since `window.gsdSSE` is a singleton connecting to `/dashboard/events`, and modifying it would affect the overview tab, use a SEPARATE EventSource connection for log tailing:
     - Create a dedicated EventSource to `/dashboard/events?tail={filename}`.
     - Store reference in `tailEventSource`.
     - On message, parse data, check for `type: "log_tail"`, extract entries array.
     - For each new entry: push to `allEntries`, render and append to output (don't re-render entire list -- just append new entry divs).
     - Apply search filter to new entries (only append if they match current query).
     - If `autoScroll` is true, scroll output to bottom.
   - On reconnect/error, update tail dot to appropriate state.

10. `stopTail()` -- Close the dedicated tail EventSource, update dot to idle.

11. `handleTailToggle()` -- Toggle `tailActive`:
    - If pausing: set tailActive=false, close the tail EventSource, update dot class to `tail-dot-paused`.
    - If resuming: set tailActive=true, reconnect tail for currentFile, update dot class to `tail-dot-active`.

12. `handleSearch()` -- On search input change (use `input` event with debounce of 200ms):
    - Update `searchQuery`.
    - Call `renderEntries()` to re-filter all entries.
    - If tail is active, new incoming entries will be filtered by the updated query.

13. `handleScroll()` -- Detect if user scrolled away from bottom:
    - If scrolled up more than 50px from bottom, set `autoScroll = false`.
    - If scrolled back to within 50px of bottom, set `autoScroll = true`.

14. `init()` -- On DOMContentLoaded:
    - Fetch file list via API.
    - Populate dropdown.
    - Attach event listener on `#log-file-select` change -> call loadFile(selectedValue).
    - Attach event listener on `#log-tail-toggle` click -> call handleTailToggle().
    - Attach event listener on `#log-search` input -> call handleSearch() with debounce.
    - Attach scroll event listener on `#log-output` -> call handleScroll().
    - Auto-select and load the first file (if any files exist).

**Important implementation details:**
- Use string concatenation for innerHTML (not template literals) to avoid bash heredoc issues during file creation (per established pattern from 09-02).
- All DOM queries use `document.getElementById()` with the `log-` prefix convention.
- Handle the case where log API returns empty file list -- show a "No log files found" message in the output area.

**After creating logs.ts, rebuild the Astro project:**
- Run `npm run build` from `tools/gsd-review-broker/dashboard/` to rebuild dist/.
- The built dist/index.html should contain the compiled log viewer markup and bundled JS.
  </action>
  <verify>
1. `npm run build` from tools/gsd-review-broker/dashboard/ succeeds.
2. dist/index.html contains log viewer elements (verify with grep for "log-file-select" and "log-output").
3. `uv run pytest tests/test_dashboard.py -v` from tools/gsd-review-broker/ still passes (no regressions from frontend changes).
  </verify>
  <done>
logs.ts data script handles file listing, file loading with full content rendering, SSE live tail with dedicated EventSource, text search filtering, auto-scroll behavior, and tail pause/resume toggle. Astro build succeeds and dist/ is updated with compiled log viewer tab. All existing tests pass.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` from dashboard/ succeeds -- Astro compiles LogViewer and logs.ts without errors
2. dist/index.html contains log viewer HTML structure
3. `uv run pytest tests/test_dashboard.py -v` -- all tests pass
4. Log viewer dropdown renders with optgroups for broker/reviewer sources
5. Selecting a file loads and renders entries in terminal-style with color coding
6. Live tail streams new entries via dedicated SSE connection
7. Search input filters displayed entries
8. Tail toggle pauses/resumes streaming with dot indicator state changes
</verification>

<success_criteria>
- LogViewer.astro component renders dropdown, controls, and terminal-style output area
- logs.ts fetches file list, loads file contents, renders color-coded entries with full JSON
- Live tail via SSE streams new entries with auto-scroll
- Text search filters entries (existing and incoming)
- Tail toggle pauses/resumes with pulsing dot indicator
- Astro build succeeds, dist/ updated
</success_criteria>

<output>
After completion, create `.planning/phases/10-log-viewer-tab/10-02-SUMMARY.md`
</output>
