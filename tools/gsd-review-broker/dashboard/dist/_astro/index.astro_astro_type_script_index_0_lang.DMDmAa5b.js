let u=null,g=[],p=!0,T="",w=!0,s=null,v=null,m=null,L=null,I="",E=!1;const b=5e3;function y(e){const t=document.createElement("div");return t.appendChild(document.createTextNode(e)),t.innerHTML}function B(e){return e<1024?e+" B":e<1024*1024?(e/1024).toFixed(1)+" KB":(e/(1024*1024)).toFixed(1)+" MB"}function D(e){try{const t=new Date(e),n=String(t.getHours()).padStart(2,"0"),o=String(t.getMinutes()).padStart(2,"0"),l=String(t.getSeconds()).padStart(2,"0"),r=String(t.getMilliseconds()).padStart(3,"0");return n+":"+o+":"+l+"."+r}catch{return e||"--"}}function C(e){try{const t=new Date(e),o=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][t.getMonth()],l=t.getDate(),r=String(t.getHours()).padStart(2,"0"),i=String(t.getMinutes()).padStart(2,"0");return o+" "+l+", "+r+":"+i}catch{return e||"--"}}function N(e){return e.level?e.level.toLowerCase():e.event==="reviewer_exit"&&e.exit_code!==void 0&&e.exit_code!==0?"error":e.event==="stderr_line"||e.stream==="stderr"?"warn":"info"}function k(e){return e.caller_tag?e.caller_tag:e.reviewer_id?e.reviewer_id:e.event?e.event:""}function x(e,t){if(!t)return!0;const n=t.toLowerCase();return JSON.stringify(e).toLowerCase().indexOf(n)!==-1}function F(e){const t=document.createElement("div");t.className="log-entry";const n=N(e);t.classList.add("log-level-"+n);const o=k(e),l=e.ts?D(e.ts):"--:--:--.---",r=e.message||"";let i='<span class="log-entry-ts">['+y(l)+"]</span>";return o&&(i+=' <span class="log-entry-tag">['+y(o)+"]</span>"),r&&(i+=' <span class="log-entry-message">'+y(r)+"</span>"),t.innerHTML=i,t}async function O(){const e=await fetch("/dashboard/api/logs");if(!e.ok)throw new Error("HTTP "+e.status+": "+e.statusText);return(await e.json()).files||[]}function R(e,t){const n=document.getElementById("log-file-select");if(!n)return null;for(;n.children.length>1;)n.removeChild(n.lastChild);if(e.length===0){const i=document.createElement("option");return i.value="",i.disabled=!0,i.selected=!0,i.textContent="No log files found",n.appendChild(i),null}const o=e.filter(function(i){return i.source==="broker"}),l=e.filter(function(i){return i.source==="reviewer"});if(o.length>0){const i=document.createElement("optgroup");i.label="Broker Logs";for(let d=0;d<o.length;d++){const a=o[d],f=document.createElement("option");f.value=a.name,f.textContent=a.name+" ("+B(a.size)+", "+C(a.modified)+")",i.appendChild(f)}n.appendChild(i)}if(l.length>0){const i=document.createElement("optgroup");i.label="Reviewer Logs";for(let d=0;d<l.length;d++){const a=l[d],f=document.createElement("option");f.value=a.name,f.textContent=a.name+" ("+B(a.size)+", "+C(a.modified)+")",i.appendChild(f)}n.appendChild(i)}return(t?e.some(function(i){return i.name===t}):!1)&&t?(n.value=t,t):(n.value=e[0].name,e[0].name)}function j(e){return e.length===0?"empty":e.map(function(t){return t.source+":"+t.name+":"+t.size+":"+t.modified}).join("|")}async function S(){if(!E){E=!0;try{const e=await O(),t=j(e);if(t===I)return;const n=document.getElementById("log-file-select"),o=u||(n&&n.value?n.value:null),l=R(e,o);if(I=t,!l){u=null,h();return}l!==u&&await M(l)}catch{}finally{E=!1}}}function H(){const e=document.getElementById("log-output");if(!e)return;e.innerHTML="";const t=g.filter(function(o){return x(o,T)});if(t.length===0&&g.length>0){e.innerHTML='<div style="text-align:center;color:var(--color-text-secondary);padding:20px;">No entries match the search filter.</div>';return}const n=document.createDocumentFragment();for(let o=0;o<t.length;o++)n.appendChild(F(t[o]));e.appendChild(n),w&&(e.scrollTop=e.scrollHeight)}async function M(e){const t=document.getElementById("log-output"),n=document.getElementById("log-empty"),o=document.getElementById("log-loading");o&&(o.style.display=""),t&&(t.style.display="none"),n&&(n.style.display="none"),h(),u=e,g=[];try{const l=await fetch("/dashboard/api/logs/"+encodeURIComponent(e));if(!l.ok)throw new Error("HTTP "+l.status);g=(await l.json()).entries||[]}catch{g=[],t&&(t.innerHTML='<div style="text-align:center;color:var(--color-error);padding:20px;">Failed to load log file.</div>')}o&&(o.style.display="none"),t&&(t.style.display=""),H(),t&&(t.scrollTop=t.scrollHeight),p&&u&&_(u)}function c(e){const t=document.getElementById("log-tail-dot");t&&(t.className="tail-dot tail-dot-"+e)}function A(){m&&clearTimeout(m),m=setTimeout(function(){p&&s&&c("idle")},3e3)}function _(e){h(),c("idle");try{s=new EventSource("/dashboard/events?tail="+encodeURIComponent(e)),s.onmessage=function(t){try{const n=JSON.parse(t.data);if(n.type==="log_tail"&&Array.isArray(n.entries)&&n.entries.length>0){const o=document.getElementById("log-output");if(!o)return;c("active"),A();for(let l=0;l<n.entries.length;l++){const r=n.entries[l];g.push(r),x(r,T)&&o.appendChild(F(r))}w&&o&&(o.scrollTop=o.scrollHeight)}}catch{}},s.onerror=function(){c("idle")},s.onopen=function(){c("idle")}}catch{c("idle")}}function h(){m&&(clearTimeout(m),m=null),s&&(s.close(),s=null),c("idle")}function J(){p=!p;const e=document.getElementById("log-tail-label");p?(e&&(e.textContent="Live Tail"),u&&_(u)):(h(),c("paused"),e&&(e.textContent="Tail Paused"))}function P(){const e=document.getElementById("log-search");e&&(T=e.value,H())}function z(){const e=document.getElementById("log-output");if(!e)return;w=e.scrollHeight-e.scrollTop-e.clientHeight<50}async function U(){try{await S()}catch{const l=document.getElementById("log-empty");if(l){const r=l.querySelector("p");r&&(r.textContent="Unable to load log files.")}}const e=document.getElementById("log-file-select");e&&e.addEventListener("change",function(){const l=e;l.value&&M(l.value)});const t=document.getElementById("log-tail-toggle");t&&t.addEventListener("click",J);const n=document.getElementById("log-search");n&&n.addEventListener("input",function(){v&&clearTimeout(v),v=setTimeout(P,200)});const o=document.getElementById("log-output");o&&o.addEventListener("scroll",z),window.gsdSSE&&window.gsdSSE.subscribe("overview_update",function(){S()}),L||(L=setInterval(function(){S()},b))}document.addEventListener("DOMContentLoaded",U);
