let g=null,d=[],m=!0,v="",y=!0,u=null,h=null,f=null;function p(e){const t=document.createElement("div");return t.appendChild(document.createTextNode(e)),t.innerHTML}function T(e){return e<1024?e+" B":e<1024*1024?(e/1024).toFixed(1)+" KB":(e/(1024*1024)).toFixed(1)+" MB"}function x(e){try{const t=new Date(e),l=String(t.getHours()).padStart(2,"0"),o=String(t.getMinutes()).padStart(2,"0"),i=String(t.getSeconds()).padStart(2,"0"),n=String(t.getMilliseconds()).padStart(3,"0");return l+":"+o+":"+i+"."+n}catch{return e||"--"}}function S(e){try{const t=new Date(e),o=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][t.getMonth()],i=t.getDate(),n=String(t.getHours()).padStart(2,"0"),r=String(t.getMinutes()).padStart(2,"0");return o+" "+i+", "+n+":"+r}catch{return e||"--"}}function H(e){return e.level?e.level.toLowerCase():e.event==="reviewer_exit"&&e.exit_code!==void 0&&e.exit_code!==0?"error":e.event==="stderr_line"||e.stream==="stderr"?"warn":"info"}function F(e){return e.caller_tag?e.caller_tag:e.reviewer_id?e.reviewer_id:e.event?e.event:""}function B(e,t){if(!t)return!0;const l=t.toLowerCase();return JSON.stringify(e).toLowerCase().indexOf(l)!==-1}function C(e){const t=document.createElement("div");t.className="log-entry";const l=H(e);t.classList.add("log-level-"+l);const o=F(e),i=e.ts?x(e.ts):"--:--:--.---",n=e.message||"";let r='<span class="log-entry-ts">['+p(i)+"]</span>";o&&(r+=' <span class="log-entry-tag">['+p(o)+"]</span>"),n&&(r+=' <span class="log-entry-message">'+p(n)+"</span>");const c=JSON.stringify(e,null,2),a='<pre class="log-entry-json">'+p(c)+"</pre>";return t.innerHTML=r+a,t}async function M(){const e=await fetch("/dashboard/api/logs");if(!e.ok)throw new Error("HTTP "+e.status+": "+e.statusText);return(await e.json()).files||[]}function b(e){const t=document.getElementById("log-file-select");if(!t)return;for(;t.options.length>1;)t.remove(1);if(e.length===0){const n=document.createElement("option");n.value="",n.disabled=!0,n.textContent="No log files found",t.appendChild(n);return}const l=e.filter(function(n){return n.source==="broker"}),o=e.filter(function(n){return n.source==="reviewer"});if(l.length>0){const n=document.createElement("optgroup");n.label="Broker Logs";for(let r=0;r<l.length;r++){const c=l[r],a=document.createElement("option");a.value=c.name,a.textContent=c.name+" ("+T(c.size)+", "+S(c.modified)+")",n.appendChild(a)}t.appendChild(n)}if(o.length>0){const n=document.createElement("optgroup");n.label="Reviewer Logs";for(let r=0;r<o.length;r++){const c=o[r],a=document.createElement("option");a.value=c.name,a.textContent=c.name+" ("+T(c.size)+", "+S(c.modified)+")",n.appendChild(a)}t.appendChild(n)}const i=t.querySelector("optgroup option");i&&(t.value=i.value)}function I(){const e=document.getElementById("log-output");if(!e)return;e.innerHTML="";const t=d.filter(function(o){return B(o,v)});if(t.length===0&&d.length>0){e.innerHTML='<div style="text-align:center;color:var(--color-text-secondary);padding:20px;">No entries match the search filter.</div>';return}const l=document.createDocumentFragment();for(let o=0;o<t.length;o++)l.appendChild(C(t[o]));e.appendChild(l),y&&(e.scrollTop=e.scrollHeight)}async function w(e){const t=document.getElementById("log-output"),l=document.getElementById("log-empty"),o=document.getElementById("log-loading");o&&(o.style.display=""),t&&(t.style.display="none"),l&&(l.style.display="none"),E(),g=e,d=[];try{const i=await fetch("/dashboard/api/logs/"+encodeURIComponent(e));if(!i.ok)throw new Error("HTTP "+i.status);d=(await i.json()).entries||[]}catch{d=[],t&&(t.innerHTML='<div style="text-align:center;color:var(--color-error);padding:20px;">Failed to load log file.</div>')}o&&(o.style.display="none"),t&&(t.style.display=""),I(),t&&(t.scrollTop=t.scrollHeight),m&&g&&L(g)}function s(e){const t=document.getElementById("log-tail-dot");t&&(t.className="tail-dot tail-dot-"+e)}function D(){f&&clearTimeout(f),f=setTimeout(function(){m&&u&&s("idle")},3e3)}function L(e){E(),s("idle");try{u=new EventSource("/dashboard/events?tail="+encodeURIComponent(e)),u.onmessage=function(t){try{const l=JSON.parse(t.data);if(l.type==="log_tail"&&Array.isArray(l.entries)&&l.entries.length>0){const o=document.getElementById("log-output");if(!o)return;s("active"),D();for(let i=0;i<l.entries.length;i++){const n=l.entries[i];d.push(n),B(n,v)&&o.appendChild(C(n))}y&&o&&(o.scrollTop=o.scrollHeight)}}catch{}},u.onerror=function(){s("idle")},u.onopen=function(){s("idle")}}catch{s("idle")}}function E(){f&&(clearTimeout(f),f=null),u&&(u.close(),u=null),s("idle")}function N(){m=!m;const e=document.getElementById("log-tail-label");m?(e&&(e.textContent="Live Tail"),g&&L(g)):(E(),s("paused"),e&&(e.textContent="Tail Paused"))}function O(){const e=document.getElementById("log-search");e&&(v=e.value,I())}function _(){const e=document.getElementById("log-output");if(!e)return;y=e.scrollHeight-e.scrollTop-e.clientHeight<50}async function j(){try{const i=await M();b(i);const n=document.getElementById("log-file-select");n&&n.value&&n.value!==""&&w(n.value)}catch{const i=document.getElementById("log-empty");if(i){const n=i.querySelector("p");n&&(n.textContent="Unable to load log files.")}}const e=document.getElementById("log-file-select");e&&e.addEventListener("change",function(){const i=e;i.value&&w(i.value)});const t=document.getElementById("log-tail-toggle");t&&t.addEventListener("click",N);const l=document.getElementById("log-search");l&&l.addEventListener("input",function(){h&&clearTimeout(h),h=setTimeout(O,200)});const o=document.getElementById("log-output");o&&o.addEventListener("scroll",_)}document.addEventListener("DOMContentLoaded",j);
