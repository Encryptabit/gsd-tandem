let u=null,d=[],g=!0,p="",h=!0,s=null,m=null;function f(t){const e=document.createElement("div");return e.appendChild(document.createTextNode(t)),e.innerHTML}function y(t){return t<1024?t+" B":t<1024*1024?(t/1024).toFixed(1)+" KB":(t/(1024*1024)).toFixed(1)+" MB"}function I(t){try{const e=new Date(t),i=String(e.getHours()).padStart(2,"0"),o=String(e.getMinutes()).padStart(2,"0"),l=String(e.getSeconds()).padStart(2,"0"),n=String(e.getMilliseconds()).padStart(3,"0");return i+":"+o+":"+l+"."+n}catch{return t||"--"}}function E(t){try{const e=new Date(t),o=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][e.getMonth()],l=e.getDate(),n=String(e.getHours()).padStart(2,"0"),r=String(e.getMinutes()).padStart(2,"0");return o+" "+l+", "+n+":"+r}catch{return t||"--"}}function L(t){return t.level?t.level.toLowerCase():t.event==="reviewer_exit"&&t.exit_code!==void 0&&t.exit_code!==0?"error":t.event==="stderr_line"||t.stream==="stderr"?"warn":"info"}function x(t){return t.caller_tag?t.caller_tag:t.reviewer_id?t.reviewer_id:t.event?t.event:""}function w(t,e){if(!e)return!0;const i=e.toLowerCase();return JSON.stringify(t).toLowerCase().indexOf(i)!==-1}function T(t){const e=document.createElement("div");e.className="log-entry";const i=L(t);e.classList.add("log-level-"+i);const o=x(t),l=t.ts?I(t.ts):"--:--:--.---",n=t.message||"";let r='<span class="log-entry-ts">['+f(l)+"]</span>";o&&(r+=' <span class="log-entry-tag">['+f(o)+"]</span>"),n&&(r+=' <span class="log-entry-message">'+f(n)+"</span>");const a=JSON.stringify(t,null,2),c='<pre class="log-entry-json">'+f(a)+"</pre>";return e.innerHTML=r+c,e}async function H(){const t=await fetch("/dashboard/api/logs");if(!t.ok)throw new Error("HTTP "+t.status+": "+t.statusText);return(await t.json()).files||[]}function N(t){const e=document.getElementById("log-file-select");if(!e)return;for(;e.options.length>1;)e.remove(1);if(t.length===0){const n=document.createElement("option");n.value="",n.disabled=!0,n.textContent="No log files found",e.appendChild(n);return}const i=t.filter(function(n){return n.source==="broker"}),o=t.filter(function(n){return n.source==="reviewer"});if(i.length>0){const n=document.createElement("optgroup");n.label="Broker Logs";for(let r=0;r<i.length;r++){const a=i[r],c=document.createElement("option");c.value=a.name,c.textContent=a.name+" ("+y(a.size)+", "+E(a.modified)+")",n.appendChild(c)}e.appendChild(n)}if(o.length>0){const n=document.createElement("optgroup");n.label="Reviewer Logs";for(let r=0;r<o.length;r++){const a=o[r],c=document.createElement("option");c.value=a.name,c.textContent=a.name+" ("+y(a.size)+", "+E(a.modified)+")",n.appendChild(c)}e.appendChild(n)}const l=e.querySelector("optgroup option");l&&(e.value=l.value)}function B(){const t=document.getElementById("log-output");if(!t)return;t.innerHTML="";const e=d.filter(function(o){return w(o,p)});if(e.length===0&&d.length>0){t.innerHTML='<div style="text-align:center;color:var(--color-text-secondary);padding:20px;">No entries match the search filter.</div>';return}const i=document.createDocumentFragment();for(let o=0;o<e.length;o++)i.appendChild(T(e[o]));t.appendChild(i),h&&(t.scrollTop=t.scrollHeight)}async function S(t){const e=document.getElementById("log-output"),i=document.getElementById("log-empty"),o=document.getElementById("log-loading");o&&(o.style.display=""),e&&(e.style.display="none"),i&&(i.style.display="none"),v(),u=t,d=[];try{const l=await fetch("/dashboard/api/logs/"+encodeURIComponent(t));if(!l.ok)throw new Error("HTTP "+l.status);d=(await l.json()).entries||[]}catch{d=[],e&&(e.innerHTML='<div style="text-align:center;color:var(--color-error);padding:20px;">Failed to load log file.</div>')}o&&(o.style.display="none"),e&&(e.style.display=""),B(),e&&(e.scrollTop=e.scrollHeight),g&&u&&C(u)}function C(t){v();const e=document.getElementById("log-tail-dot");e&&(e.className="tail-dot tail-dot-active");try{s=new EventSource("/dashboard/events?tail="+encodeURIComponent(t)),s.onmessage=function(i){try{const o=JSON.parse(i.data);if(o.type==="log_tail"&&Array.isArray(o.entries)){const l=document.getElementById("log-output");if(!l)return;for(let n=0;n<o.entries.length;n++){const r=o.entries[n];d.push(r),w(r,p)&&l.appendChild(T(r))}h&&l&&(l.scrollTop=l.scrollHeight)}}catch{}},s.onerror=function(){e&&(e.className="tail-dot tail-dot-idle")},s.onopen=function(){e&&(e.className="tail-dot tail-dot-active")}}catch{e&&(e.className="tail-dot tail-dot-idle")}}function v(){s&&(s.close(),s=null);const t=document.getElementById("log-tail-dot");t&&(t.className="tail-dot tail-dot-idle")}function F(){g=!g;const t=document.getElementById("log-tail-dot"),e=document.getElementById("log-tail-label");g?(e&&(e.textContent="Live Tail"),u&&C(u)):(v(),t&&(t.className="tail-dot tail-dot-paused"),e&&(e.textContent="Tail Paused"))}function M(){const t=document.getElementById("log-search");t&&(p=t.value,B())}function b(){const t=document.getElementById("log-output");if(!t)return;h=t.scrollHeight-t.scrollTop-t.clientHeight<50}async function D(){try{const l=await H();N(l);const n=document.getElementById("log-file-select");n&&n.value&&n.value!==""&&S(n.value)}catch{const l=document.getElementById("log-empty");if(l){const n=l.querySelector("p");n&&(n.textContent="Unable to load log files.")}}const t=document.getElementById("log-file-select");t&&t.addEventListener("change",function(){const l=t;l.value&&S(l.value)});const e=document.getElementById("log-tail-toggle");e&&e.addEventListener("click",F);const i=document.getElementById("log-search");i&&i.addEventListener("input",function(){m&&clearTimeout(m),m=setTimeout(M,200)});const o=document.getElementById("log-output");o&&o.addEventListener("scroll",b)}document.addEventListener("DOMContentLoaded",D);
