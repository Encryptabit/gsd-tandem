let f=null,d=[],g=!0,h="",v=!0,s=null,p=null,u=null;function m(e){const t=document.createElement("div");return t.appendChild(document.createTextNode(e)),t.innerHTML}function E(e){return e<1024?e+" B":e<1024*1024?(e/1024).toFixed(1)+" KB":(e/(1024*1024)).toFixed(1)+" MB"}function x(e){try{const t=new Date(e),i=String(t.getHours()).padStart(2,"0"),o=String(t.getMinutes()).padStart(2,"0"),n=String(t.getSeconds()).padStart(2,"0"),l=String(t.getMilliseconds()).padStart(3,"0");return i+":"+o+":"+n+"."+l}catch{return e||"--"}}function T(e){try{const t=new Date(e),o=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][t.getMonth()],n=t.getDate(),l=String(t.getHours()).padStart(2,"0"),r=String(t.getMinutes()).padStart(2,"0");return o+" "+n+", "+l+":"+r}catch{return e||"--"}}function H(e){return e.level?e.level.toLowerCase():e.event==="reviewer_exit"&&e.exit_code!==void 0&&e.exit_code!==0?"error":e.event==="stderr_line"||e.stream==="stderr"?"warn":"info"}function F(e){return e.caller_tag?e.caller_tag:e.reviewer_id?e.reviewer_id:e.event?e.event:""}function w(e,t){if(!t)return!0;const i=t.toLowerCase();return JSON.stringify(e).toLowerCase().indexOf(i)!==-1}function B(e){const t=document.createElement("div");t.className="log-entry";const i=H(e);t.classList.add("log-level-"+i);const o=F(e),n=e.ts?x(e.ts):"--:--:--.---",l=e.message||"";let r='<span class="log-entry-ts">['+m(n)+"]</span>";o&&(r+=' <span class="log-entry-tag">['+m(o)+"]</span>"),l&&(r+=' <span class="log-entry-message">'+m(l)+"</span>");const c=JSON.stringify(e,null,2),L='<pre class="log-entry-json">'+m(c)+"</pre>";return t.innerHTML=r+L,t}async function M(){const e=await fetch("/dashboard/api/logs");if(!e.ok)throw new Error("HTTP "+e.status+": "+e.statusText);return(await e.json()).files||[]}function b(e){const t=document.getElementById("log-file-select");if(!t)return;for(;t.options.length>1;)t.remove(1);if(e.length===0){const n=document.createElement("option");n.value="",n.disabled=!0,n.textContent="No log files found",t.appendChild(n);return}const i=e.filter(function(n){return n.source==="broker"}),o=e.filter(function(n){return n.source==="reviewer"});if(i.length>0){const n=document.createElement("optgroup");n.label="Broker Logs";for(let l=0;l<i.length;l++){const r=i[l],c=document.createElement("option");c.value=r.name,c.textContent=r.name+" ("+E(r.size)+", "+T(r.modified)+")",n.appendChild(c)}t.appendChild(n)}if(o.length>0){const n=document.createElement("optgroup");n.label="Reviewer Logs";for(let l=0;l<o.length;l++){const r=o[l],c=document.createElement("option");c.value=r.name,c.textContent=r.name+" ("+E(r.size)+", "+T(r.modified)+")",n.appendChild(c)}t.appendChild(n)}e.length>0&&(t.value=e[0].name)}function C(){const e=document.getElementById("log-output");if(!e)return;e.innerHTML="";const t=d.filter(function(o){return w(o,h)});if(t.length===0&&d.length>0){e.innerHTML='<div style="text-align:center;color:var(--color-text-secondary);padding:20px;">No entries match the search filter.</div>';return}const i=document.createDocumentFragment();for(let o=0;o<t.length;o++)i.appendChild(B(t[o]));e.appendChild(i),v&&(e.scrollTop=e.scrollHeight)}async function S(e){const t=document.getElementById("log-output"),i=document.getElementById("log-empty"),o=document.getElementById("log-loading");o&&(o.style.display=""),t&&(t.style.display="none"),i&&(i.style.display="none"),y(),f=e,d=[];try{const n=await fetch("/dashboard/api/logs/"+encodeURIComponent(e));if(!n.ok)throw new Error("HTTP "+n.status);d=(await n.json()).entries||[]}catch{d=[],t&&(t.innerHTML='<div style="text-align:center;color:var(--color-error);padding:20px;">Failed to load log file.</div>')}o&&(o.style.display="none"),t&&(t.style.display=""),C(),t&&(t.scrollTop=t.scrollHeight),g&&f&&I(f)}function a(e){const t=document.getElementById("log-tail-dot");t&&(t.className="tail-dot tail-dot-"+e)}function D(){u&&clearTimeout(u),u=setTimeout(function(){g&&s&&a("idle")},3e3)}function I(e){y(),a("idle");try{s=new EventSource("/dashboard/events?tail="+encodeURIComponent(e)),s.onmessage=function(t){try{const i=JSON.parse(t.data);if(i.type==="log_tail"&&Array.isArray(i.entries)&&i.entries.length>0){const o=document.getElementById("log-output");if(!o)return;a("active"),D();for(let n=0;n<i.entries.length;n++){const l=i.entries[n];d.push(l),w(l,h)&&o.appendChild(B(l))}v&&o&&(o.scrollTop=o.scrollHeight)}}catch{}},s.onerror=function(){a("idle")},s.onopen=function(){a("idle")}}catch{a("idle")}}function y(){u&&(clearTimeout(u),u=null),s&&(s.close(),s=null),a("idle")}function N(){g=!g;const e=document.getElementById("log-tail-label");g?(e&&(e.textContent="Live Tail"),f&&I(f)):(y(),a("paused"),e&&(e.textContent="Tail Paused"))}function _(){const e=document.getElementById("log-search");e&&(h=e.value,C())}function j(){const e=document.getElementById("log-output");if(!e)return;v=e.scrollHeight-e.scrollTop-e.clientHeight<50}async function O(){try{const n=await M();b(n);const l=document.getElementById("log-file-select");l&&l.value&&l.value!==""&&S(l.value)}catch{const n=document.getElementById("log-empty");if(n){const l=n.querySelector("p");l&&(l.textContent="Unable to load log files.")}}const e=document.getElementById("log-file-select");e&&e.addEventListener("change",function(){const n=e;n.value&&S(n.value)});const t=document.getElementById("log-tail-toggle");t&&t.addEventListener("click",N);const i=document.getElementById("log-search");i&&i.addEventListener("input",function(){p&&clearTimeout(p),p=setTimeout(_,200)});const o=document.getElementById("log-output");o&&o.addEventListener("scroll",j)}document.addEventListener("DOMContentLoaded",O);
